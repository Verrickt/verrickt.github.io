<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  <title>记一次愉(dan)快(teng)的捉虫 | Melchior on CLR</title>
  <meta name="description" content="A programmer focus mainly on Microsoft Technologies" />
  <meta name="keywords" content="Windows desktop,C#,XAML,UWP,WPF,OpenSource,GNU/Linux,CLI" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="shortcut icon" href="/">
  <link rel="alternate" href="/atom.xml" title="Melchior on CLR">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="废话BUG是任何软件都会遇到的问题。它通常是开发人员考虑问题不全面而埋下的隐形炸弹，在条件合适的时候就会爆炸；开发自己埋BUG往往比较容易除错，因为代码都是自己写的，定位问题后git blame一下就可以甩锅了；而程序依赖项里的BUG则排查起来则让人一筹莫展，尤其是在没有足够多信息的情况。 面对来自客户和QA的压力，绞尽脑汁仍无法定位问题开发们只能找借口了🤣  It’s a feature,no">
<meta name="keywords" content="C#,WPF,Debugging">
<meta property="og:type" content="article">
<meta property="og:title" content="记一次愉(dan)快(teng)的捉虫">
<meta property="og:url" content="https://verrickt.github.io/2018/05/21/hell-mode-debugging/index.html">
<meta property="og:site_name" content="Melchior on CLR">
<meta property="og:description" content="废话BUG是任何软件都会遇到的问题。它通常是开发人员考虑问题不全面而埋下的隐形炸弹，在条件合适的时候就会爆炸；开发自己埋BUG往往比较容易除错，因为代码都是自己写的，定位问题后git blame一下就可以甩锅了；而程序依赖项里的BUG则排查起来则让人一筹莫展，尤其是在没有足够多信息的情况。 面对来自客户和QA的压力，绞尽脑汁仍无法定位问题开发们只能找借口了🤣  It’s a feature,no">
<meta property="og:locale" content="zh-CN,en-US">
<meta property="og:image" content="https://verrickt.github.io/2018/05/21/hell-mode-debugging/net472_error.png">
<meta property="og:updated_time" content="2018-08-04T10:24:55.494Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="记一次愉(dan)快(teng)的捉虫">
<meta name="twitter:description" content="废话BUG是任何软件都会遇到的问题。它通常是开发人员考虑问题不全面而埋下的隐形炸弹，在条件合适的时候就会爆炸；开发自己埋BUG往往比较容易除错，因为代码都是自己写的，定位问题后git blame一下就可以甩锅了；而程序依赖项里的BUG则排查起来则让人一筹莫展，尤其是在没有足够多信息的情况。 面对来自客户和QA的压力，绞尽脑汁仍无法定位问题开发们只能找借口了🤣  It’s a feature,no">
<meta name="twitter:image" content="https://verrickt.github.io/2018/05/21/hell-mode-debugging/net472_error.png">
    
  <link href="https://fonts.googleapis.com/css?family=Inconsolata|Titillium+Web" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet">
  <link href='//cdn.bootcss.com/node-waves/0.7.5/waves.min.css' rel='stylesheet'>
  <link rel="stylesheet" href="/style.css">
  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>
</head>

<body>
  <div id="loading-bar-wrapper">
  <div id="loading-bar"></div>
</div>


  <script>setLoadingBarProgress(20)</script> 
  <header class="l_header">
	<div class='wrapper'>
		<div class="nav-main container container--flex">
			<a class="logo flat-box" href='/' >
				Melchior on CLR
			</a>
			<div class='menu'>
				<ul class='h-list'>
					
						<li>
							<a class='flat-box nav-home' href='/'>
								Home
							</a>
						</li>
					
						<li>
							<a class='flat-box nav-archives' href='/archives'>
								Archives
							</a>
						</li>
					
						<li>
							<a class='flat-box nav-about' href='/about'>
								About
							</a>
						</li>
					
				</ul>
				<div class='underline'></div>
			</div>
			
				<div class="m_search">
					<form name="searchform" class="form u-search-form">
						<input type="text" class="input u-search-input" placeholder="Search" />
						<span class="icon icon-search"></span>
					</form>
				</div>
			
			<ul class='switcher h-list'>
				
					<li class='s-search'><a href='javascript:void(0)'><span class="icon icon-search flat-box"></span></a></li>
				
				<li class='s-menu'><a href='javascript:void(0)'><span class="icon icon-menu flat-box"></span></a></li>
			</ul>
		</div>
		
		<div class='nav-sub container container--flex'>
			<a class="logo" class="flat-box" href='javascript:void(0)'>
				Word of Forks
			</a>

			<ul class='switcher h-list'>
				<li class='s-comment'><a href='javascript:void(0)'><span class="icon icon-chat_bubble_outline flat-box"></span></a></li>
				<li class='s-top'><a href='javascript:void(0)'><span class="icon icon-arrow_upward flat-box"></span></a></li>
				<li class='s-toc'><a href='javascript:void(0)'><span class="icon icon-format_list_numbered flat-box"></span></a></li>
			</ul>
		</div>
	</div>
</header>
<aside class="menu-phone">
	<nav>
		
			<a href="/" class="nav-home nav">
				Home
			</a>
		
			<a href="/archives" class="nav-archives nav">
				Archives
			</a>
		
			<a href="/about" class="nav-about nav">
				About
			</a>
		
	</nav>
</aside>

    <script>setLoadingBarProgress(40);</script>
  <div class="l_body">
    <div class='container clearfix'>
      <div class='l_main'>
        <article id="post-hell-mode-debugging"
  class="post white-box article-type-post"
  itemscope itemprop="blogPost">
	<section class='meta'>
	<h2 class="title">
  	<a href="/2018/05/21/hell-mode-debugging/">
    	记一次愉(dan)快(teng)的捉虫
    </a>
  </h2>
	<time>
	  May 21, 2018
	</time>
	
	</section>
	
		<section class="toc-wrapper"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#废话"><span class="toc-number">1.</span> <span class="toc-text">废话</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#背景"><span class="toc-number">2.</span> <span class="toc-text">背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#捉虫"><span class="toc-number">3.</span> <span class="toc-text">捉虫</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#出师不利"><span class="toc-number">3.1.</span> <span class="toc-text">出师不利</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#寻找原因"><span class="toc-number">3.2.</span> <span class="toc-text">寻找原因</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#又入困境"><span class="toc-number">3.3.</span> <span class="toc-text">又入困境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#转机"><span class="toc-number">3.4.</span> <span class="toc-text">转机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#微软来背锅"><span class="toc-number">3.5.</span> <span class="toc-text">微软来背锅</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#原因分析"><span class="toc-number">4.</span> <span class="toc-text">原因分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">5.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">6.</span> <span class="toc-text">Reference</span></a></li></ol></section>
	
	<section class="article typo">
  	<div class="article-entry" itemprop="articleBody">
    	<h2 id="废话"><a href="#废话" class="headerlink" title="废话"></a>废话</h2><p>BUG是任何软件都会遇到的问题。它通常是开发人员考虑问题不全面而埋下的隐形炸弹，在条件合适的时候就会爆炸；开发自己埋BUG往往比较容易除错，因为代码都是自己写的，定位问题后<code>git blame</code>一下就可以甩锅了；而程序依赖项里的BUG则排查起来则让人一筹莫展，尤其是在没有足够多信息的情况。</p>
<p>面对来自客户和QA的压力，绞尽脑汁仍无法定位问题开发们只能找借口了🤣</p>
<ul>
<li>It’s a feature,not a bug.</li>
<li>That’s the design decision, so not a bug</li>
</ul>
<p>我以前也遇到框架出问题的情况，不过都是自己改代码改出来的，倒也不是很难排查。但这次挖出来的BUG就完全不一样了</p>
<a id="more"></a>
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>一个WPF的项目，勉强在deadline之前赶完了功能。出了新版本后接到QA报告，程序在Windows 8.1上死于OOM:</p>
<blockquote>
<p>System.OutOfMemoryException: Insufficient memory to continue the execution of the program.<br>   at System.Windows.Media.MediaContext.NotifyPartitionIsZombie(Int32 failureCode)<br>   at System.Windows.Media.MediaContext.NotifyChannelMessage()<br>   at System.Windows.Interop.HwndTarget.HandleMessage(Int32 msg, IntPtr wparam, IntPtr lparam)<br>   at System.Windows.Interop.HwndSource.HwndTargetFilterMessage(IntPtr hwnd, Int32 msg, IntPtr wParam, IntPtr lParam, Boolean&amp; handled)<br>   at MS.Win32.HwndWrapper.WndProc(IntPtr hwnd, Int32 msg, IntPtr wParam, IntPtr lParam, Boolean&amp; handled)<br>   at MS.Win32.HwndSubclass.DispatcherCallbackOperation(Object o)<br>   at System.Windows.Threading.ExceptionWrapper.InternalRealCall(Delegate callback, Object args, Boolean isSingleParameter)<br>   at System.Windows.Threading.ExceptionWrapper.TryCatchWhen(Object source, Delegate callback, Object args, Boolean isSingleParameter, Delegate catchHandler)<br>   at System.Windows.Threading.Dispatcher.WrappedInvoke(Delegate callback, Object args, Boolean isSingleParameter, Delegate catchHandler)<br>   at System.Windows.Threading.Dispatcher.InvokeImpl(DispatcherPriority priority, TimeSpan timeout, Delegate method, Object args, Boolean isSingleParameter)<br>   at System.Windows.Threading.Dispatcher.Invoke(DispatcherPriority priority, Delegate method, Object arg)<br>   at MS.Win32.HwndSubclass.SubclassWndProc(IntPtr hwnd, Int32 msg, IntPtr wParam, IntPtr lParam)<br>   at MS.Win32.UnsafeNativeMethods.DispatchMessage(MSG&amp; msg)<br>   at System.Windows.Threading.Dispatcher.PushFrameImpl(DispatcherFrame frame)<br>   at System.Windows.Threading.Dispatcher.PushFrame(DispatcherFrame frame)<br>   at System.Windows.Threading.Dispatcher.Run()</p>
</blockquote>
<h2 id="捉虫"><a href="#捉虫" class="headerlink" title="捉虫"></a>捉虫</h2><h3 id="出师不利"><a href="#出师不利" class="headerlink" title="出师不利"></a>出师不利</h3><p>程序里用自定义的<code>Window Style</code>替代了WPF自带的。但是自定义的<code>Window Style</code>在最大化的时候会<a href="https://stackoverflow.com/questions/20941443/properly-maximizing-wpf-window-with-windowstyle-none" target="_blank" rel="external">覆盖任务栏</a>。为了解决这个问题，我们使用了回答里自定义的消息循环。看到调用栈里的<code>Hwnd</code>，初步怀疑是自定义的消息循环的问题。把消息循环相关的代码拿掉，问题依旧。看来不是消息循环的问题。不过为什么我在开发的时候没有遇到问题呢？</p>
<h3 id="寻找原因"><a href="#寻找原因" class="headerlink" title="寻找原因"></a>寻找原因</h3><p>把出问题版本直接放在我的开发机上跑发现并没有问题。放在另一个同事的机子上也没问题。这时候意识到问题有点蹊跷。一般来说这种不能稳定重现的问题都或多或少会和多线程和死锁有关。然而上个版本到这个版本并没有写这些方面的代码。这时候开始怀疑是环境的问题了。找来各个版本的Windows，依次尝试后发现只在Windows 8.1上有问题。难道是OS的问题？同事提醒了一句，说以前的版本是可以在Windows 8.1上正常跑的。用二分法，找到了最晚的能用的版本B和最早的不能用的版本A。</p>
<h3 id="又入困境"><a href="#又入困境" class="headerlink" title="又入困境"></a>又入困境</h3><p>按理说，找到版本后diff下改动的代码就能比较快的定位问题了。不过现在有了稳定浮现的版本B，我决定从异常本身入手。一番搜索后找到了微软的一篇<a href="https://blogs.msdn.microsoft.com/dsui_team/2013/11/18/wpf-render-thread-failures/" target="_blank" rel="external">博客</a>，其中提到这个错误通常是渲染子系统出问题的症状：</p>
<blockquote>
<p>… WPF render thread encountered some fatal error … Most of the time, a failure occurs when calling into DirectX/D3D … When a failure is detected, The render thread will attempt to map the failure it receives to an appropriate managed exception. The render thread only synchronizes with the UI thread in a few locations …The most common locations when they synchronize are … or as a result of the UI thread handling a “channel” message from DirectX.</p>
<p>If a render thread failure manifests as a System.OutOfMemoryException, then the likelihood is that the render thread was a victim of the process exhausting some resource .The exhausted resource is most often available/contiguous virtual address space … It might be a situation where sometimes the WPF render thread is the victim of the resource exhaustion …</p>
</blockquote>
<p>WPF里的渲染是由非托管的DirectX做的。为了从程序员的角度隐藏掉渲染这个过程，WPF将自身拆分为不同的组件。<code>PreserentationFramework.dll</code>和<code>PreserentationFrameworkCore.dll</code>是程序员直接能接触到的。这里实现的是组合子系统。渲染子系统则在非托管的<code>milcore.dll</code>里实现。<code>System.Windows.Media.Visual</code>是WPF组合子系统的入口点，它通过私有的通信协议与<code>milcore</code>里的渲染子系统通信，从而将组合子系统和渲染子系统连接起来。</p>
<p>看起来我们的代码耗尽了DirectX里边的某种资源，从而让渲染失败了。C#做为一个托管语言，居然能捅这么大的篓子，完全不科学。这个BUG越来越有意思了🤔</p>
<p>既然异常上看不出来什么头绪那就要从代码入手了。找diff的时候发现B版本没有打tag。</p>
<p>没打tag不算大问题，多花了些时间成功找到了那个commit，但是心情有点不爽。</p>
<p>diff的代码不多。排除掉无关的文件就只剩下一些布局文件比较可疑。改流程，依次跳过这些页面，发现一跳到登录页面就挂了。登录页面的diff有点多，二分删除很快就定位到了问题的根源:<code>ImageButton</code>。</p>
<p><code>ImageButton</code>是个在普通、鼠标悬停、被按下三种不同状态时显示不同的图片的按钮。</p>
<p><code>ImageButton.cs</code>:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System.Windows;</div><div class="line"><span class="keyword">using</span> System.Windows.Controls;</div><div class="line"><span class="keyword">using</span> System.Windows.Media;</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">Debugging</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ImageButton</span> : <span class="title">Button</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">public</span> ImageSource Source</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">get</span> &#123; <span class="keyword">return</span> (ImageSource)GetValue(SourceProperty); &#125;</div><div class="line">            <span class="keyword">set</span> &#123; SetValue(SourceProperty, <span class="keyword">value</span>); &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> DependencyProperty SourceProperty =</div><div class="line">            DependencyProperty.Register(<span class="string">"Source"</span>, <span class="keyword">typeof</span>(ImageSource), <span class="keyword">typeof</span>(ImageButton), <span class="keyword">new</span> PropertyMetadata(<span class="literal">null</span>));</div><div class="line"></div><div class="line">        <span class="keyword">public</span> ImageSource MouseOverImage</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">get</span> &#123; <span class="keyword">return</span> (ImageSource)GetValue(MouseOverImageProperty); &#125;</div><div class="line">            <span class="keyword">set</span> &#123; SetValue(MouseOverImageProperty, <span class="keyword">value</span>); &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> DependencyProperty MouseOverImageProperty =</div><div class="line">            DependencyProperty.Register(<span class="string">"MouseOverImage"</span>, <span class="keyword">typeof</span>(ImageSource), <span class="keyword">typeof</span>(ImageButton), <span class="keyword">new</span> PropertyMetadata(<span class="literal">null</span>));</div><div class="line"></div><div class="line">        <span class="keyword">public</span> ImageSource PressedImage</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">get</span> &#123; <span class="keyword">return</span> (ImageSource)GetValue(PressedImageProperty); &#125;</div><div class="line">            <span class="keyword">set</span> &#123; SetValue(PressedImageProperty, <span class="keyword">value</span>); &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> DependencyProperty PressedImageProperty =</div><div class="line">            DependencyProperty.Register(<span class="string">"PressedImage"</span>, <span class="keyword">typeof</span>(ImageSource), <span class="keyword">typeof</span>(ImageButton), <span class="keyword">new</span> PropertyMetadata(<span class="literal">null</span>));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>ImageButton.xaml</code>:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">ResourceDictionary</span> <span class="attr">xmlns</span>=<span class="string">"http://schemas.microsoft.com/winfx/2006/xaml/presentation"</span></span></div><div class="line"><span class="tag">                    <span class="attr">xmlns:x</span>=<span class="string">"http://schemas.microsoft.com/winfx/2006/xaml"</span></span></div><div class="line"><span class="tag">                    <span class="attr">xmlns:local</span>=<span class="string">"clr-namespace:Debugging"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">Style</span> <span class="attr">TargetType</span>=<span class="string">"local:ImageButton"</span>&gt;</span><span class="undefined"></span></div><div class="line"><span class="xml">        <span class="tag">&lt;<span class="name">Setter</span> <span class="attr">Property</span>=<span class="string">"Template"</span>&gt;</span></span></div><div class="line"><span class="xml">            <span class="tag">&lt;<span class="name">Setter.Value</span>&gt;</span></span></div><div class="line"><span class="xml">                <span class="tag">&lt;<span class="name">ControlTemplate</span> <span class="attr">TargetType</span>=<span class="string">"local:ImageButton"</span>&gt;</span></span></div><div class="line"><span class="xml">                    <span class="tag">&lt;<span class="name">Grid</span>&gt;</span></span></div><div class="line"><span class="xml">                        <span class="tag">&lt;<span class="name">Image</span> <span class="attr">x:Name</span>=<span class="string">"image"</span> <span class="attr">Source</span>=<span class="string">"&#123;TemplateBinding Source&#125;"</span> /&gt;</span></span></div><div class="line"><span class="xml">                    <span class="tag">&lt;/<span class="name">Grid</span>&gt;</span></span></div><div class="line"><span class="xml">                    <span class="tag">&lt;<span class="name">ControlTemplate.Triggers</span>&gt;</span></span></div><div class="line"><span class="xml">                        <span class="tag">&lt;<span class="name">Trigger</span> <span class="attr">Property</span>=<span class="string">"IsMouseOver"</span> <span class="attr">Value</span>=<span class="string">"True"</span>&gt;</span></span></div><div class="line"><span class="xml">                            <span class="tag">&lt;<span class="name">Setter</span> <span class="attr">TargetName</span>=<span class="string">"image"</span> <span class="attr">Property</span>=<span class="string">"Source"</span> <span class="attr">Value</span>=<span class="string">"&#123;Binding RelativeSource=&#123;RelativeSource TemplatedParent&#125;, Path=MouseOverImage&#125;"</span> /&gt;</span></span></div><div class="line"><span class="xml">                        <span class="tag">&lt;/<span class="name">Trigger</span>&gt;</span></span></div><div class="line"><span class="xml">                        <span class="tag">&lt;<span class="name">Trigger</span> <span class="attr">Property</span>=<span class="string">"IsPressed"</span> <span class="attr">Value</span>=<span class="string">"True"</span>&gt;</span></span></div><div class="line"><span class="xml">                            <span class="tag">&lt;<span class="name">Setter</span> <span class="attr">TargetName</span>=<span class="string">"image"</span> <span class="attr">Property</span>=<span class="string">"Source"</span> <span class="attr">Value</span>=<span class="string">"&#123;Binding RelativeSource=&#123;RelativeSource TemplatedParent&#125;, Path=PressedImage&#125;"</span> /&gt;</span></span></div><div class="line"><span class="xml">                        <span class="tag">&lt;/<span class="name">Trigger</span>&gt;</span></span></div><div class="line"><span class="xml">                    <span class="tag">&lt;/<span class="name">ControlTemplate.Triggers</span>&gt;</span></span></div><div class="line"><span class="xml">                <span class="tag">&lt;/<span class="name">ControlTemplate</span>&gt;</span></span></div><div class="line"><span class="xml">            <span class="tag">&lt;/<span class="name">Setter.Value</span>&gt;</span></span></div><div class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">Setter</span>&gt;</span></span></div><div class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">Style</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">ResourceDictionary</span>&gt;</span></div></pre></td></tr></table></figure>
<p>登陆页面中是这样使用ImageButton的:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">....</div><div class="line"><span class="tag">&lt;<span class="name">ImageButton</span> <span class="attr">Source</span>=<span class="string">"&#123;StaticResource SomeImage&#125;"</span> <span class="attr">MouseOverImage</span>=<span class="string">"&#123;StaticResouce SomeOtherImage&#125;"</span> <span class="attr">PressedImage</span>=<span class="string">"&#123;StaticResources AnotherImage&#125;"</span> /&gt;</span></div><div class="line">....</div></pre></td></tr></table></figure></p>
<p>把<code>Source=&quot;{StaticResource SomeImage}&quot;</code>这一句去掉就正常了。似乎它就是罪魁祸首。但是，把这部分代码和图片拿出来放到另一个程序里却又一切正常。</p>
<h3 id="转机"><a href="#转机" class="headerlink" title="转机"></a>转机</h3><p>接下来又尝试了</p>
<ul>
<li>把<code>ImageButton</code>替换为<code>Image</code></li>
<li>把<code>Template.Trigger</code>去掉</li>
<li>把<code>SomeImage</code>指向其他图片</li>
</ul>
<p>但是还是找不到root cause。一模一样的代码不能在其他程序复现，那就说明BUG是我们程序自己造成的。但是这个BUG只在Windows 8.1下出现，说明跟环境也有可能有关系。距离发现BUG已经过去一天半了，放弃的话实在是不甘心，接下来只能猜了。</p>
<p>堆栈里显示程序挂在WPF的程序集里，基于这个现象决定retarget到.NET Framework的最新版本4.7.2。编译打包部署一套流程走完，在运行的时候发现Windows 8.1没有安装.NET Framework 4.7.2。好吧，那就装。可是安装包告诉我不满足条件：</p>
<p><img src="/2018/05/21/hell-mode-debugging/net472_error.png" alt="net472_requirement_not_meet"></p>
<p>需要安装<a href="https://support.microsoft.com/en-us/help/2919355/windows-rt-8-1-windows-8-1-and-windows-server-2012-r2-update-april-201" target="_blank" rel="external"><strong>KB2919355</strong></a>？</p>
<h3 id="微软来背锅"><a href="#微软来背锅" class="headerlink" title="微软来背锅"></a>微软来背锅</h3><p>在微软的<a href="https://support.microsoft.com/en-us/help/2919355/windows-rt-8-1-windows-8-1-and-windows-server-2012-r2-update-april-201" target="_blank" rel="external">支持网站</a>上详细列出了KB2919355的change log。以<code>image</code>为关键字CTRL+F发现这样的描述：</p>
<blockquote>
<table>
<thead>
<tr>
<th style="text-align:center">Article number</th>
<th style="text-align:center">Article Title</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><a href="https://support.microsoft.com/en-us/help/2929755" target="_blank" rel="external">2929755</a></td>
<td style="text-align:center">Out of memory when you load some image resources in a Windows application</td>
</tr>
</tbody>
</table>
</blockquote>
<p>我去，这就是我们遇到的问题。</p>
<p><a href="https://support.microsoft.com/en-us/help/2929755/out-of-memory-when-you-load-some-image-resources-in-a-windows-applicat" target="_blank" rel="external">对应的页面</a>给出的描述：</p>
<blockquote>
<p><strong>Symptoms</strong></p>
<p>When you load some image resources in an application such as Microsoft Visual Studio on a computer that has Windows 8.1, Windows Server 2012 R2, Windows 8, Windows Server 2012, Windows 7, or Windows Server 2008 R2 installed, the application stops responding and memory leaks in Windows. This issue occurs after you install the following update:<br>2670838 Platform update for Windows 7 SP1 and Windows Server 2008 R2 SP1</p>
<p><strong>File Information</strong></p>
<ul>
<li>For all supported x86-based versions of Windows 8:</li>
</ul>
<table>
<thead>
<tr>
<th>File name</th>
<th style="text-align:left">File version</th>
<th style="text-align:left">File size</th>
<th style="text-align:left">Date</th>
<th style="text-align:left">Time</th>
<th style="text-align:left">Platform</th>
</tr>
</thead>
<tbody>
<tr>
<td>Windowscodecs.dll</td>
<td style="text-align:left">6.2.9200.16809</td>
<td style="text-align:left">1,339,392</td>
<td style="text-align:left">31-Jan-2014</td>
<td style="text-align:left">00:48</td>
<td style="text-align:left">x86</td>
</tr>
<tr>
<td>Windowscodecs.dll</td>
<td style="text-align:left">6.2.9200.20930</td>
<td style="text-align:left">1,319,936</td>
<td style="text-align:left">31-Jan-2014</td>
<td style="text-align:left">06:04</td>
<td style="text-align:left">x86</td>
</tr>
</tbody>
</table>
</blockquote>
<p>这个BUG是<a href="https://support.microsoft.com/en-us/help/2670838" target="_blank" rel="external">KB2670838</a>引入的。在2670838的更新中,微软更新了现有的Windows Imaging Component (WIC)</p>
<blockquote>
<p>This update improves the range and performance of the following graphics and imaging components:</p>
<ul>
<li>Windows Imaging Component (WIC)</li>
</ul>
</blockquote>
<p>我们在diff里重点关注了Image相更改，发现改了这么一行：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">Application.Resources</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">Style</span> <span class="attr">TargetType</span>=<span class="string">"Image"</span>&gt;</span><span class="undefined"></span></div><div class="line"><span class="xml">            <span class="tag">&lt;<span class="name">Setter</span> <span class="attr">Property</span>=<span class="string">"RenderOptions.BitmapScalingMode"</span></span></span></div><div class="line"><span class="undefined">                    Value="Fant" /&gt;</span></div><div class="line"><span class="undefined">        </span><span class="tag">&lt;/<span class="name">Style</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">Application.Resources</span>&gt;</span></div></pre></td></tr></table></figure>
<p><a href="https://docs.microsoft.com/en-us/dotnet/api/system.windows.media.bitmapscalingmode?view=netframework-4.7.2" target="_blank" rel="external">RenderOptons.BitmapScalingMode</a>指明在需要缩放时使用的算法。<code>Fant</code>是质量最高的一种之一。尝试<code>Fant</code>改为<code>Linear</code>后程序正常运行。继续尝试其他的值，发现除了<code>Linear</code>和<code>Unspecified</code>都会崩溃。</p>
<h2 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h2><p>在KB2670838里的WIC在特定情况会OOM爆掉。WPF里的<code>BitmapScalingMode.Fant</code>依赖WIC实现，在装了KB2670838的环境里跟就会跟WIC一起OOM爆掉；微软在后来发行的KB2919355中修复了这个BUG。</p>
<p>我们的测试机的Windows系统由RTM的镜像安装并且关闭了自动更新。在Windows 8.1之前的RTM镜像没有自带KBB2670838，在Windows 8.1之后RTM镜像自带了KB2919355。偏偏这个Windows 8.1的RTM镜像内置了KB2670838而没有内置KB2919355，程序就这样死于OOM。</p>
<p>验证Windowscodecs.dll的版本也支持这个结论。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>定位环境问题的时候要控制变量</li>
<li>二分法能快速定位出错的位置</li>
<li>打好Tag很重要</li>
<li>一直以来依赖的底层也会有BUG。大胆质疑，小心求证。</li>
</ul>
<p><del>该甩锅的时候要果断的甩给微软</del></p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://docs.microsoft.com/en-us/dotnet/framework/wpf/advanced/wpf-architecture#systemwindowsmediavisual" target="_blank" rel="external">WPF Architecture - docs.microsoft.com</a></p>
<p><a href="https://social.msdn.microsoft.com/Forums/en-US/2ca9e3d5-06b9-4ca0-b5e0-0a42d54cd926/wpf-tooltip-rendering-issue-application-hang?forum=wpf" target="_blank" rel="external">WPF ToolTip Rendering Issue : Application Hang - social.msdn.microsoft.com</a></p>
<p><a href="https://support.microsoft.com/en-us/help/2919355/windows-rt-8-1-windows-8-1-and-windows-server-2012-r2-update-april-201" target="_blank" rel="external">Windows RT 8.1, Windows 8.1, and Windows Server 2012 R2 update: April 2014 - support.microsoft.com</a></p>
<p><a href="https://support.microsoft.com/en-us/help/2670838/platform-update-for-windows-7-sp1-and-windows-server-2008-r2-sp1" target="_blank" rel="external">Platform update for Windows 7 SP1 and Windows Server 2008 R2 SP1 - support.microsoft.com</a></p>
<p><a href="https://msdn.microsoft.com/library/windows/desktop/ee719902.aspx" target="_blank" rel="external">Windows Imaging Component - msdn.microsoft.com</a></p>

  	</div>
	  
	  <div class="article-tags tags">
      
        <a href="/tags/C/">C#</a>
      
        <a href="/tags/WPF/">WPF</a>
      
        <a href="/tags/Debugging/">Debugging</a>
      
	  </div>
    
		
	
		<div class="art-item-footer">
				
					<span class="art-item-left"><i class="icon icon-chevron-thin-left"></i>prev：<a href="/2018/07/12/program-upon-abstractions/" rel="prev"  title="面向抽象编程">
						面向抽象编程 
					</a></span>
				
				
					<span class="art-item-right">next：<a href="/2018/03/08/closure-and-re-entrance/" rel="next"  title="闭包，变量捕获与重入问题">
						闭包，变量捕获与重入问题
					</a><i class="icon icon-chevron-thin-right"></i></span>
				
		</div>
	
	</section>
	
		<section id="comments">
			<div id="gitment_thread"></div>
			<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
			<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
			<script>
					var gitment = new Gitment({
							id: '记一次愉(dan)快(teng)的捉虫',
							owner: 'verrickt',
							repo: 'verrickt.github.io',
							oauth: {
									client_id: '9a5cc0fe7b4e920d91f3',
									client_secret: 'ae774015efba47b603a7c6540c276f744e32e07d',
							},
					})
					gitment.render('comments')
			</script>
		</section>
	
</article>
<script>
	window.subData = {
		title: '记一次愉(dan)快(teng)的捉虫',
		tools: true
	}
</script>

      </div>
      <aside class='l_side'>
        
  <section class='m_widget about'>

<img class='avatar waves-image' src='https://avatars0.githubusercontent.com/u/11483783' />

<div class='header'>Verrickt</div>
<div class='content'>
<div class='desc'>Von as a programmer</div>
</div>
</section>

  <section class='m_widget links'>
<div class='header'>Links</div>
<div class='content'>
    <ul class="entry">
    
        <li><a class="flat-box" target="_blank" href="https://sjx1995.github.io">
            <div class='name'>Sunly</div>
        </a></li>
    
    </ul>
</div>
</section>

  <section class='m_widget categories'>
<div class='header'>Categories</div>
<div class='content'>
    
    <ul class="entry">
    
        <li><a class="flat-box" href="/categories/FluentTreeView/"><div class='name'>FluentTreeView</div><div class='badget'>5</div></a></li>
    
    </ul>
    
</div>
</section>

  
<div class="m_widget tagcloud">
    <div class="header">Tags</div>
    <div class='content'>
        <a href="/tags/Net-Framework/" style="font-size: 14px; color: #808080">.Net Framework</a> <a href="/tags/C/" style="font-size: 20px; color: #000">C#</a> <a href="/tags/Debugging/" style="font-size: 14px; color: #808080">Debugging</a> <a href="/tags/HttpClient/" style="font-size: 14px; color: #808080">HttpClient</a> <a href="/tags/MSBuild/" style="font-size: 14px; color: #808080">MSBuild</a> <a href="/tags/OOP/" style="font-size: 14px; color: #808080">OOP</a> <a href="/tags/PAT/" style="font-size: 20px; color: #000">PAT</a> <a href="/tags/Parser/" style="font-size: 14px; color: #808080">Parser</a> <a href="/tags/Reentrance/" style="font-size: 14px; color: #808080">Reentrance</a> <a href="/tags/SOLID/" style="font-size: 14px; color: #808080">SOLID</a> <a href="/tags/WPF/" style="font-size: 17px; color: #404040">WPF</a> <a href="/tags/async-await/" style="font-size: 14px; color: #808080">async/await</a> <a href="/tags/lambda/" style="font-size: 14px; color: #808080">lambda</a> <a href="/tags/overhead/" style="font-size: 14px; color: #808080">overhead</a> <a href="/tags/reference-type/" style="font-size: 14px; color: #808080">reference type</a>
    </div>
</div>



      </aside>
      <script>setLoadingBarProgress(60);</script>
    </div>
  </div>
  <footer id="footer" class="clearfix">

  <div class="social-wrapper">
    
      
        <a href="https://github.com/verrickt" class="social github" target="_blank" rel="external">
          <span class="icon icon-github"></span>
        </a>
        
        <a href="https://twitter.com/verrickt" class="social twitter" target="_blank" rel="external">
          <span class="icon icon-twitter"></span>
        </a>
        
        <a href="/atom.xml" class="social rss" target="_blank" rel="external">
          <span class="icon icon-rss"></span>
        </a>
        
          
  </div>

  <div>(c) 2017-2018 by verrickt, all right reserved. Powered by
    <a href="https://hexo.io/" class="codename">Hexo</a>. Theme by
    <a href='https://github.com/stkevintan/hexo-theme-material-flow' class="codename">MaterialFlow</a>
    <div>
      <a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank">
        <img style="vertical-align: middle" alt="graphical represerentaion of CC BY-SA license" src="https://licensebuttons.net/l/by-sa/3.0/88x31.png"
          height="24.75" width="66">
      </a>
      <span>
        Unless explicitly stated, contents of this blog are licensed under
        <a href="https://creativecommons.org/licenses/by-sa/4.0/" class="codename" target="_blank">CC BY-SA</a>
      </span>
    </div>
</footer>
  <script>setLoadingBarProgress(80);</script>
  

<script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
<script src='//cdn.bootcss.com/node-waves/0.7.5/waves.min.js'></script>
<script src="//cdn.bootcss.com/scrollReveal.js/3.3.2/scrollreveal.min.js"></script>
<script src="/js/jquery.fitvids.js"></script>
<script>
	var GOOGLE_CUSTOM_SEARCH_API_KEY = "";
	var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "";
	var ALGOLIA_API_KEY = "";
	var ALGOLIA_APP_ID = "";
	var ALGOLIA_INDEX_NAME = "";
  var AZURE_SERVICE_NAME = "";
  var AZURE_INDEX_NAME = "";
  var AZURE_QUERY_KEY = "";
  var BAIDU_API_ID = "";
  var SEARCH_SERVICE = "hexo";
  var ROOT = "/"||"/";
  if(!ROOT.endsWith('/'))ROOT += '/';
</script>
<script src="/js/search.js"></script>
<script src="/js/app.js"></script>


  <script>setLoadingBarProgress(100);</script>
</body>
</html>
