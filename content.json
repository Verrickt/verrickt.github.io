{"meta":{"title":"Melchior on CLR","subtitle":"Verrickt as a Programmer","description":"A programmer focus mainly on Microsoft Technologies","author":"Verrickt","url":"https://verrickt.github.io"},"pages":[{"title":"About","date":"2018-08-04T09:08:39.000Z","updated":"2018-08-04T09:18:10.589Z","comments":true,"path":"about/index.html","permalink":"https://verrickt.github.io/about/index.html","excerpt":"","text":"ç¨‹åºå‘˜ã€‚ å…³é”®è¯ï¼š Windows desktop C# XAML UWP WPF GNU/Linux 1public string ğŸ“§=&gt;\"von@hohm.in\";"}],"posts":[{"title":"FluentTreeView Part.5","slug":"fluent-treeview-part5","date":"2019-04-19T13:18:17.000Z","updated":"2019-04-20T03:22:53.907Z","comments":true,"path":"2019/04/19/fluent-treeview-part5/","link":"","permalink":"https://verrickt.github.io/2019/04/19/fluent-treeview-part5/","excerpt":"é€’å½’é«˜äº®å…ˆæ¥ä¿®æ­£é€‰æ‹©é«˜äº®çš„é—®é¢˜å§ã€‚æˆ‘æ›´æ„¿æ„å›¾ç‰‡ä¸­çš„æ•ˆæœç§°ä¸ºé€’å½’é«˜äº®ã€‚é€’å½’é«˜äº®å¯ä»¥çœ‹ä½œæ˜¯å­èŠ‚ç‚¹éƒ½å¤„äºéé€’å½’é«˜äº®çŠ¶æ€ã€‚è¿™ä¹ˆæƒ³çš„è¯å®ç°èµ·æ¥åº”è¯¥éå¸¸å®¹æ˜“ã€‚ä½†æˆ‘å¸Œæœ›FluentTreeViewèƒ½å¤Ÿæ›´çµæ´»ä¸€äº›ã€‚æœ€å¥½é€šè¿‡å±æ€§æ¥åˆ‡æ¢é«˜äº®æ¨¡å¼ã€‚","text":"é€’å½’é«˜äº®å…ˆæ¥ä¿®æ­£é€‰æ‹©é«˜äº®çš„é—®é¢˜å§ã€‚æˆ‘æ›´æ„¿æ„å›¾ç‰‡ä¸­çš„æ•ˆæœç§°ä¸ºé€’å½’é«˜äº®ã€‚é€’å½’é«˜äº®å¯ä»¥çœ‹ä½œæ˜¯å­èŠ‚ç‚¹éƒ½å¤„äºéé€’å½’é«˜äº®çŠ¶æ€ã€‚è¿™ä¹ˆæƒ³çš„è¯å®ç°èµ·æ¥åº”è¯¥éå¸¸å®¹æ˜“ã€‚ä½†æˆ‘å¸Œæœ›FluentTreeViewèƒ½å¤Ÿæ›´çµæ´»ä¸€äº›ã€‚æœ€å¥½é€šè¿‡å±æ€§æ¥åˆ‡æ¢é«˜äº®æ¨¡å¼ã€‚ è¯´æ¥å°±æ¥ï¼Œè¦å¾€TreeViewItemä¸ŠåŠ æ–°çš„å±æ€§ï¼Œè¦ç”±TreeViewItemå¯¼å‡ºå­ç±»ã€‚è¦ä½¿TreeViewçš„ç›´æ¥ItemContainerä½¿ç”¨æˆ‘ä»¬è‡ªå®šä¹‰çš„å­ç±»ï¼Œéœ€è¦ç»§æ‰¿TreeViewçš„å­ç±»ã€‚ 12345678910111213141516171819202122class FluentTreeViewItem : TreeViewItem&#123; public bool RecursiveHighlightMode &#123; get &#123; return (bool) GetValue (RecursiveHighlightModeProperty); &#125; set &#123; SetValue (RecursiveHighlightModeProperty, value); &#125; &#125; // Using a DependencyProperty as the backing store for RecursiveHighlightMode. This enables animation, styling, binding, etc... public static readonly DependencyProperty RecursiveHighlightModeProperty = DependencyProperty.Register (\"RecursiveHighlightMode\", typeof (bool), typeof (FluentTreeViewItem), new PropertyMetadata (false)); protected override DependencyObject GetContainerForItemOverride () &#123; return new FluentTreeViewItem (); &#125; protected override bool IsItemItsOwnContainerOverride (object item) &#123; return item is FluentTreeViewItem; &#125;&#125; 123456789101112public class FluentTreeView : TreeView&#123; protected override DependencyObject GetContainerForItemOverride () &#123; return new FluentTreeViewItem (); &#125; protected override bool IsItemItsOwnContainerOverride (object item) &#123; return item is FluentTreeViewItem; &#125;&#125; é‡å†™TreeViewçš„GetContainerForItemOverrideæ˜¯å¸¸è§„æ“ä½œï¼Œå¤§å®¶åœ¨è‡ªå®šä¹‰ItemContainerçš„æ—¶å€™è‚¯å®šéƒ½åšè¿‡ã€‚éœ€è¦æ³¨æ„çš„æ˜¯TreeViewItemä¹Ÿæ˜¯ItemsControlï¼Œå®ƒçš„GetContainerForItemOverrideä¹Ÿéœ€è¦è¢«é‡å†™ã€‚ æ¥ä¸‹æ¥æ€è€ƒå¦‚ä½•å®ç°é€’å½’æ¨¡å¼å’Œéé€’å½’æ¨¡å¼çš„åˆ‡æ¢ã€‚ç›´æ¥è®©å­èŠ‚ç‚¹ä¹Ÿå¤„äºé«˜äº®çŠ¶æ€ä¸é”™çš„åŠæ³•ï¼Œä½†é«˜äº®çŠ¶æ€ä¾èµ–çš„è§¦å‘å™¨ï¼Œéœ€è¦ç”±IsSelectedå±æ€§è§¦å‘ã€‚ä¸ºäº†ç•Œé¢è€Œå»ä¿®æ”¹æ•°æ®ï¼Œè¿èƒŒWPFæ•°æ®é©±åŠ¨ç•Œé¢çš„åŸåˆ™ã€‚é‚£ä¹ˆæ¢ä¸€ç§æ€è·¯ï¼Œä¸å†ç”¨åˆ†æ²»çš„æ€è·¯ï¼Œè€Œæ˜¯ç›´æ¥åœ¨å½“å‰èŠ‚ç‚¹ä¸Šå…¨éƒ¨å¤„ç†æ‰ã€‚è®©çˆ¶èŠ‚ç‚¹çš„é«˜äº®åŒºåŸŸè¦†ç›–æ‰€æœ‰çš„å­èŠ‚ç‚¹å³å¯ã€‚å®½åº¦å·²ç»å æ»¡ï¼Œåªå‰©ä¸‹é«˜åº¦äº†ã€‚å¯¹èƒŒæ™¯è‰²ï¼Œå¯ä»¥ç›´æ¥ä¿®æ”¹æœ€å¤–å±‚é¢æ¿çš„èƒŒæ™¯è‰²ã€‚èµ·æŒ‡ç¤ºä½œç”¨çš„çŸ©å½¢ï¼Œåˆ™å¯ä»¥ä¿®æ”¹å…¶Grid.RowSpanè®©å®ƒå……æ»¡æ•´ä¸ªé«˜åº¦ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758&lt;ControlTemplate TargetType=\"cc:FluentTreeViewItem\"&gt; &lt;Grid x:Name=\"globalHighlight\" Background=\"Transparent\"&gt; &lt;Grid.RowDefinitions&gt; &lt;RowDefinition Height=\"24\"&gt;&lt;/RowDefinition&gt; &lt;RowDefinition Height=\"*\"&gt;&lt;/RowDefinition&gt; &lt;/Grid.RowDefinitions&gt; &lt;Rectangle Panel.ZIndex=\"20\" Grid.RowSpan=\"1\" x:Name=\"selector\" Width=\"2\" Visibility=\"Collapsed\" Fill=\"Red\" HorizontalAlignment=\"Left\"&gt;&lt;/Rectangle&gt; &lt;Border x:Name=\"root\"&gt; &lt;Border.Style&gt; &lt;Style TargetType=\"Border\"&gt; &lt;Style.Triggers&gt; &lt;Trigger Property=\"IsMouseOver\" Value=\"True\"&gt; &lt;Setter Property=\"Background\" Value=\"Red\"&gt;&lt;/Setter&gt; &lt;/Trigger&gt; &lt;/Style.Triggers&gt; &lt;/Style&gt; &lt;/Border.Style&gt; &lt;Grid Background=\"Transparent\" x:Name=\"selectorGrid\"&gt; &lt;Grid Margin=\"&#123;Binding RelativeSource=&#123;RelativeSource AncestorType=TreeViewItem&#125;,Converter=&#123;StaticResource TreeLevelToIndentConverter&#125;&#125;\"&gt; &lt;Grid.ColumnDefinitions&gt; &lt;ColumnDefinition Width=\"24\"&gt;&lt;/ColumnDefinition&gt; &lt;ColumnDefinition&gt;&lt;/ColumnDefinition&gt; &lt;/Grid.ColumnDefinitions&gt; &lt;Expander IsExpanded=\"&#123;Binding RelativeSource=&#123;RelativeSource TemplatedParent&#125;,Path=IsExpanded,Mode=TwoWay&#125;\" x:Name=\"expander\"&gt;&lt;/Expander&gt; &lt;ContentPresenter VerticalAlignment=\"Center\" Grid.Column=\"1\" ContentSource=\"Header\"&gt;&lt;/ContentPresenter&gt; &lt;/Grid&gt; &lt;/Grid&gt; &lt;/Border&gt; &lt;ItemsPresenter Visibility=\"&#123;Binding RelativeSource=&#123;RelativeSource TemplatedParent&#125;,Path=IsExpanded,Converter=&#123;StaticResource BoolToVisibilityConverter&#125;&#125;\" Grid.Row=\"1\"&gt;&lt;/ItemsPresenter&gt; &lt;/Grid&gt; &lt;ControlTemplate.Triggers&gt; &lt;Trigger Property=\"HasItems\" Value=\"False\"&gt; &lt;Setter TargetName=\"expander\" Property=\"Visibility\" Value=\"Collapsed\"&gt;&lt;/Setter&gt; &lt;/Trigger&gt; &lt;Trigger Property=\"IsMouseOver\" Value=\"True\"&gt; &lt;/Trigger&gt; &lt;Trigger Property=\"IsSelected\" Value=\"True\"&gt; &lt;Setter TargetName=\"selector\" Property=\"Visibility\" Value=\"Visible\"&gt;&lt;/Setter&gt; &lt;/Trigger&gt; &lt;Trigger Property=\"RecursiveHighlightMode\" Value=\"True\"&gt; &lt;Setter TargetName=\"selector\" Property=\"Grid.RowSpan\" Value=\"2\"&gt;&lt;/Setter&gt; &lt;/Trigger&gt; &lt;MultiTrigger &gt; &lt;MultiTrigger.Conditions&gt; &lt;Condition Property=\"RecursiveHighlightMode\" Value=\"True\"&gt;&lt;/Condition&gt; &lt;Condition Property=\"IsSelected\" Value=\"True\"&gt;&lt;/Condition&gt; &lt;/MultiTrigger.Conditions&gt; &lt;Setter TargetName=\"globalHighlight\" Property=\"Background\" Value=\"Green\"&gt;&lt;/Setter&gt; &lt;/MultiTrigger&gt; &lt;MultiTrigger &gt; &lt;MultiTrigger.Conditions&gt; &lt;Condition Property=\"RecursiveHighlightMode\" Value=\"False\"&gt;&lt;/Condition&gt; &lt;Condition Property=\"IsSelected\" Value=\"True\"&gt;&lt;/Condition&gt; &lt;/MultiTrigger.Conditions&gt; &lt;Setter TargetName=\"selectorGrid\" Property=\"Background\" Value=\"Green\"&gt;&lt;/Setter&gt; &lt;/MultiTrigger&gt; &lt;/ControlTemplate.Triggers&gt;&lt;/ControlTemplate&gt; æˆ‘ä»¬æ ¹æ®RecursiveHighlightModeçš„å€¼åœ¨globalHighlightå’ŒselectorGridé‡Œé€‰å‡ºä½œä¸ºé€‰æ‹©é«˜äº®çš„æ§ä»¶ï¼Œä¿®æ”¹selectorçš„Grid.RowSpanã€‚Grid.RowSpanä¼šä½¿å¸ƒå±€å­ç³»ç»Ÿçš„Measureå¤±æ•ˆã€‚åœ¨ä¾èµ–å±æ€§çš„å…ƒæ•°æ®ä¸­å£°æ˜å±æ€§å˜åŒ–å½±å“Measureé˜¶æ®µï¼Œå°±å®ç°äº†åŠ¨æ€åˆ‡æ¢é«˜äº®æ¨¡å¼ã€‚12public static readonly DependencyProperty RecursiveHighlightModeProperty = DependencyProperty.Register (\"RecursiveHighlightMode\", typeof (bool), typeof (FluentTreeViewItem), new FrameworkPropertyMetadata (false, FrameworkPropertyMetadataOptions.AffectsMeasure)); é«˜äº®ä¼˜å…ˆçº§å›é¡¾ä¸€ä¸‹ä¸Šä¸€ç¯‡ä¸­æ¨¡æ¿çš„å¯è§†åŒ–æ ‘123456Border(x:Name=&quot;root&quot;) Grid(x:Name=&quot;selectorGrid&quot;) Rectangle(x:Name=&quot;selector&quot;) Grid Expander ContentPreserenter å½“é€‰ä¸­ä¸”é¼ æ ‡æ‚¬ç©ºæ—¶ï¼Œrootå’ŒselectorGridçš„è§¦å‘å™¨éƒ½ç”Ÿæ•ˆã€‚å› ä¸ºrootæ˜¯selectorGridçš„çˆ¶çº§å®¹å™¨ï¼Œæ¸²æŸ“æ—¶å°±è¢«ç½®äºé ä¸‹çš„ä¸€å±‚ï¼Œè¿™å°±å¯¼è‡´äº†é€‰æ‹©é«˜äº®è¦†ç›–é¼ æ ‡é«˜äº®çš„è¡¨è±¡ã€‚è¦æ”¹å…¶å®å¾ˆç®€å•ï¼ŒæŠŠè¿™ä»–ä»¬ä¸¤ä¸ªå®¹å™¨çš„ä½ç½®äº’æ¢å°±è¡Œäº†ã€‚123456789101112131415161718192021222324&lt;Grid Background=\"Transparent\" x:Name=\"selectorGrid\"&gt; &lt;Border&gt; &lt;Border.Style&gt; &lt;Style TargetType=\"Border\"&gt; &lt;Style.Triggers&gt; &lt;Trigger Property=\"IsMouseOver\" Value=\"True\"&gt; &lt;Setter Property=\"Background\" Value=\"Red\"&gt;&lt;/Setter&gt; &lt;/Trigger&gt; &lt;/Style.Triggers&gt; &lt;/Style&gt; &lt;/Border.Style&gt; &lt;Grid&gt; &lt;Grid Margin=\"&#123;Binding RelativeSource=&#123;RelativeSource AncestorType=TreeViewItem&#125;,Converter=&#123;StaticResource TreeLevelToIndentConverter&#125;&#125;\"&gt; &lt;Grid.ColumnDefinitions&gt; &lt;ColumnDefinition Width=\"24\"&gt;&lt;/ColumnDefinition&gt; &lt;ColumnDefinition&gt;&lt;/ColumnDefinition&gt; &lt;/Grid.ColumnDefinitions&gt; &lt;Expander IsExpanded=\"&#123;Binding RelativeSource=&#123;RelativeSource TemplatedParent&#125;,Path=IsExpanded,Mode=TwoWay&#125;\" x:Name=\"expander\"&gt;&lt;/Expander&gt; &lt;ContentPresenter VerticalAlignment=\"Center\" Grid.Column=\"1\" ContentSource=\"Header\"&gt;&lt;/ContentPresenter&gt; &lt;/Grid&gt; &lt;/Grid&gt; &lt;/Border&gt;&lt;/Grid&gt; é…è‰²å¤ªä¸‘å‰©ä¸‹çš„å°±æ˜¯ä¸€äº›å°ç»†èŠ‚é—®é¢˜äº†ã€‚æŒ‰ç…§Fluent Designçš„æ ‡å‡†ï¼Œæ‰€æœ‰çš„å›¾æ ‡éƒ½è¦ä½¿ç”¨Segoe MDL2 Assetså®ç°ï¼Œå¹¶ä¸”è¦æ ¹æ®Windowså½“å‰çš„ä¸»é¢˜æ¨¡å¼å’Œä¸»é¢˜è‰²åŠ¨æ€æ›´æ”¹é¢œè‰²ã€‚ Fluent.WPFå¯ä»¥å–å¾—ä¸»é¢˜æ¨¡å¼å’Œä¸»é¢˜è‰²å¯¹åº”çš„ç”»åˆ·ï¼Œä½†åœ¨ä½¿ç”¨å®ƒä¹‹å‰éœ€è¦å…ˆåœ¨FluentTreeViewItemä¸Šæ–°å¢å±æ€§ï¼Œæ–¹ä¾¿ä¿®æ”¹ã€‚ 12345678910111213141516171819public Brush MouseOverBrush&#123; get &#123; return (Brush) GetValue (MouseOverBrushProperty); &#125; set &#123; SetValue (MouseOverBrushProperty, value); &#125;&#125;// Using a DependencyProperty as the backing store for MouseOverBrush. This enables animation, styling, binding, etc...public static readonly DependencyProperty MouseOverBrushProperty = DependencyProperty.Register (\"MouseOverBrush\", typeof (Brush), typeof (FluentTreeViewItem), new PropertyMetadata (new SolidColorBrush (Colors.Red)));public Brush SelectedBrush&#123; get &#123; return (Brush) GetValue (SelectedBrushProperty); &#125; set &#123; SetValue (SelectedBrushProperty, value); &#125;&#125;// Using a DependencyProperty as the backing store for SelectedBrush. This enables animation, styling, binding, etc...public static readonly DependencyProperty SelectedBrushProperty = DependencyProperty.Register (\"SelectedBrush\", typeof (Brush), typeof (FluentTreeViewItem), new PropertyMetadata (new SolidColorBrush (Colors.Green))); é€‰æ‹©é«˜äº®ä½¿ç”¨SystemAltMediumHighColorBrushï¼Œé¼ æ ‡é«˜äº®ä½¿ç”¨SystemBaseMediumLowColorBrushï¼Œé€‰æ‹©æŒ‡ç¤ºç”¨çš„çŸ©å½¢ä½¿ç”¨SystemAccentColorã€‚ å†æŠŠExpanderç”¨Segoe MDL2 Assetså­—ä½“é‡æ–°å®ç°ï¼Œæˆ‘ä»¬çš„FluentTreeViewå°±å®Œæˆäº†ã€‚ é€’å½’é«˜äº® éé€’å½’é«˜äº® æºä»£ç å‚è§https://github.com/Verrickt/Melchior-Sample/tree/master/FluentTreeView_Part5","categories":[{"name":"FluentTreeView","slug":"FluentTreeView","permalink":"https://verrickt.github.io/categories/FluentTreeView/"}],"tags":[]},{"title":"FluentTreeView Part.4","slug":"fluent-treeview-part4","date":"2019-04-19T09:20:45.000Z","updated":"2019-04-19T13:20:46.514Z","comments":true,"path":"2019/04/19/fluent-treeview-part4/","link":"","permalink":"https://verrickt.github.io/2019/04/19/fluent-treeview-part4/","excerpt":"è¿™ç¯‡èµ·æˆ‘ä»¬æ­£å¼å¼€å§‹å®ç°FluentTreeViewã€‚å…ˆçœ‹çœ‹å›¾ç‰‡ TreeViewå·¦ä¾§æœ‰ä¸€é€‰æ‹©é«˜äº®ï¼ŒItemæœ‰ä¸€é¼ æ ‡é«˜äº®ã€‚è¿™ä¸¤ä¸ªé«˜äº®ä¸æ•´ä¸ªTreeViewä¸€æ ·å®½ã€‚å†å›æƒ³ä¸€ä¸‹æˆ‘ä»¬ä¸Šä¸€ç¯‡ç”¨Expanderå®ç°çš„TreeViewï¼ŒItemçš„ç¼©è¿›æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ","text":"è¿™ç¯‡èµ·æˆ‘ä»¬æ­£å¼å¼€å§‹å®ç°FluentTreeViewã€‚å…ˆçœ‹çœ‹å›¾ç‰‡ TreeViewå·¦ä¾§æœ‰ä¸€é€‰æ‹©é«˜äº®ï¼ŒItemæœ‰ä¸€é¼ æ ‡é«˜äº®ã€‚è¿™ä¸¤ä¸ªé«˜äº®ä¸æ•´ä¸ªTreeViewä¸€æ ·å®½ã€‚å†å›æƒ³ä¸€ä¸‹æˆ‘ä»¬ä¸Šä¸€ç¯‡ç”¨Expanderå®ç°çš„TreeViewï¼ŒItemçš„ç¼©è¿›æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ - Column1 Column2 Row1 Expander ContentPreserenter Row2 / ItemsPreserenter ItemsPreserenterå°†ä¼šè¢«å±•å¼€ä¸º1234ItemsPanel TreeViewItem TreeViewItem TreeViewItem è¿™å°±æ„å‘³ç€ï¼Œä¸‹ä¸€çº§çš„TreeViewItemæ°¸è¿œå¤„äºä¸Šä¸€çº§TreeViewItemçš„ç¬¬äºŒåˆ—é‡Œã€‚å°†ç¬¬ä¸€åˆ—çš„åˆ—å®½è®¾ç½®ä¸ºå®šå€¼ï¼Œå°±å®ç°äº†å„ä¸ªå±‚çº§çš„ç¼©è¿›ã€‚ è¿›ä¸€æ­¥æ€è€ƒï¼Œå¦‚æœæˆ‘ä»¬åœ¨è¿™æ ·çš„ç»“æ„é‡Œå»ä¿®æ”¹TreeViewItemçš„é¢æ¿çš„èƒŒæ™¯è‰²å½“ä½œé«˜äº®çš„è¯ï¼Œé‚£è¿™ä¸ªé¢æ¿è‡ªèº«ä¹Ÿæ˜¯è¢«ç¼©è¿›çš„ã€‚æˆ‘ä»¬è¯•ä¸€è¯•ï¼ŒæŠŠStyleæ”¹æˆè¿™æ ·1234567891011121314151617181920212223242526272829&lt;Style TargetType=&quot;TreeViewItem&quot;&gt; &lt;Setter Property=&quot;Template&quot;&gt; &lt;Setter.Value&gt; &lt;ControlTemplate TargetType=&quot;TreeViewItem&quot;&gt; &lt;Grid x:Name=&quot;root&quot;&gt; &lt;Grid.ColumnDefinitions&gt; &lt;ColumnDefinition Width=&quot;24&quot;&gt;&lt;/ColumnDefinition&gt; &lt;ColumnDefinition&gt;&lt;/ColumnDefinition&gt; &lt;/Grid.ColumnDefinitions&gt; &lt;Grid.RowDefinitions&gt; &lt;RowDefinition Height=&quot;Auto&quot;&gt;&lt;/RowDefinition&gt; &lt;RowDefinition Height=&quot;*&quot;&gt;&lt;/RowDefinition&gt; &lt;/Grid.RowDefinitions&gt; &lt;Expander IsExpanded=&quot;&#123;Binding RelativeSource=&#123;RelativeSource TemplatedParent&#125;,Path=IsExpanded,Mode=TwoWay&#125;&quot; x:Name=&quot;expander&quot;&gt;&lt;/Expander&gt; &lt;ContentPresenter VerticalAlignment=&quot;Center&quot; Grid.Column=&quot;1&quot; ContentSource=&quot;Header&quot;&gt;&lt;/ContentPresenter&gt; &lt;ItemsPresenter Visibility=&quot;&#123;Binding RelativeSource=&#123;RelativeSource TemplatedParent&#125;,Path=IsExpanded,Converter=&#123;StaticResource BoolToVisibilityConverter&#125;&#125;&quot; Grid.Row=&quot;1&quot; Grid.Column=&quot;1&quot;&gt;&lt;/ItemsPresenter&gt; &lt;/Grid&gt; &lt;ControlTemplate.Triggers&gt; &lt;Trigger Property=&quot;HasItems&quot; Value=&quot;False&quot;&gt; &lt;Setter TargetName=&quot;expander&quot; Property=&quot;Visibility&quot; Value=&quot;Collapsed&quot;&gt;&lt;/Setter&gt; &lt;/Trigger&gt; &lt;Trigger Property=&quot;IsSelected&quot; Value=&quot;True&quot;&gt; &lt;Setter TargetName=&quot;root&quot; Property=&quot;Background&quot; Value=&quot;Red&quot;&gt;&lt;/Setter&gt; &lt;/Trigger&gt; &lt;/ControlTemplate.Triggers&gt; &lt;/ControlTemplate&gt; &lt;/Setter.Value&gt; &lt;/Setter&gt;&lt;/Style&gt; åœ¨é€‰ä¸­éç¬¬ä¸€çº§Itemæ—¶ï¼Œé«˜äº®è‰²å°±å‡ºç°äº†æˆ‘ä»¬ä¸éœ€è¦çš„å·¦è¾¹è·ã€‚è¿™ä¸ç¬¦åˆæˆ‘ä»¬çš„è¦æ±‚ï¼Œæ‰€ä»¥ä¸èƒ½ç”¨é€’å½’çš„æ–¹å¼æ¥å®ç°ä¸åŒå±‚çº§çš„ç¼©è¿›ã€‚æˆ‘ä»¬æ‰€æƒ³è¦çš„æ˜¯ï¼Œæ¯ä¸€å±‚TreeViewItemçš„å®½åº¦éƒ½ä¸TreeViewæœ¬èº«ä¿æŒä¸€è‡´ï¼Œæ‰€ä»¥TreeViewItemè‡ªå·±å¿…é¡»æ˜¯æ‰“å¹³çš„ã€‚éœ€è¦ç‰¹æ®Šå¤„ç†çš„æ˜¯ContentPreserenterã€‚å¯ä»¥æ ¹æ®TreeViewItemçš„å±‚çº§è®¡ç®—å‡ºæ‰€éœ€è¦çš„å·¦è¾¹è·ã€‚ å†æ¬¡è€ƒè™‘æ•´ä¸ªTreeViewItemçš„å¸ƒå±€ï¼Œé¼ æ ‡å’Œé€‰æ‹©é«˜äº®åº”è¯¥æ’‘æ»¡å¯ç”¨å®½åº¦ï¼Œå€’ä¸‰è§’ç¬¦å·(â–½)å’ŒContentPreserenteråˆ™åº”è¯¥éšç€å±‚çº§ç¼©è¿›ã€‚æœ‰äº†è¿™äº›åšå‚ç…§ï¼Œå¾ˆå®¹æ˜“èƒ½å†™å‡ºè¿™æ ·çš„æ¨¡æ¿:123456789101112131415161718&lt;Grid &gt; &lt;Grid.RowDefinitions&gt; &lt;RowDefinition Height=\"Auto\"&gt;&lt;/RowDefinition&gt; &lt;RowDefinition Height=\"*\"&gt;&lt;/RowDefinition&gt; &lt;/Grid.RowDefinitions&gt; &lt;Grid x:Name=\"root\"&gt; &lt;Rectangle x:Name=\"selector\" Width=\"2\" Visibility=\"Collapsed\" Fill=\"Green\" HorizontalAlignment=\"Left\"&gt;&lt;/Rectangle&gt; &lt;Grid Margin=\"&#123;Binding RelativeSource=&#123;RelativeSource AncestorType=TreeViewItem&#125;,Converter=&#123;StaticResource TreeLevelToIndentConverter&#125;&#125;\"&gt; &lt;Grid.ColumnDefinitions&gt; &lt;ColumnDefinition Width=\"24\"&gt;&lt;/ColumnDefinition&gt; &lt;ColumnDefinition&gt;&lt;/ColumnDefinition&gt; &lt;/Grid.ColumnDefinitions&gt; &lt;Expander IsExpanded=\"&#123;Binding RelativeSource=&#123;RelativeSource TemplatedParent&#125;,Path=IsExpanded,Mode=TwoWay&#125;\" x:Name=\"expander\"&gt;&lt;/Expander&gt; &lt;ContentPresenter VerticalAlignment=\"Center\" Grid.Column=\"1\" ContentSource=\"Header\"&gt;&lt;/ContentPresenter&gt; &lt;/Grid&gt; &lt;/Grid&gt; &lt;ItemsPresenter Visibility=\"&#123;Binding RelativeSource=&#123;RelativeSource TemplatedParent&#125;,Path=IsExpanded,Converter=&#123;StaticResource BoolToVisibilityConverter&#125;&#125;\" Grid.Row=\"1\"&gt;&lt;/ItemsPresenter&gt;&lt;/Grid&gt; TreeLevelToIndentConverteræ˜¯æ ¹æ®ç­‰çº§è®¡ç®—ç¼©è¿›çš„Converterã€‚ 12345678910111213141516171819202122232425262728293031323334public class TreeLevelToIndentConverter : IValueConverter&#123; public Thickness Margin &#123; get; set; &#125; public object Convert (object value, Type targetType, object parameter, CultureInfo culture) &#123; if (value is TreeViewItem ti) &#123; int level = 0; FrameworkElement current = ti; do &#123; if (VisualTreeHelper.GetParent (current) is FrameworkElement fe) &#123; if (fe is TreeViewItem) &#123; level++; &#125; if (fe is TreeView) &#123; break; &#125; current = fe; &#125; &#125; while (current != null); return new Thickness (Margin.Left * level, 0, Margin.Right * level, 0); &#125; return value; &#125; public object ConvertBack (object value, Type targetType, object parameter, CultureInfo culture) &#123; throw new NotSupportedException(); &#125;&#125; é€‰æ‹©é«˜äº®å·²ç»å·®ä¸å¤šäº†ï¼Œä½†é¼ æ ‡é«˜äº®è¿˜æœ‰ç‚¹é—®é¢˜ ä¸€ç•ªæœç´¢å‘ç°ï¼Œå½“å‰é¼ æ ‡æ‚¬ç©ºçš„TreeViewItemä»¥åŠå®ƒæ‰€æœ‰çš„ç¥–å…ˆçš„IsMouseOverè§¦å‘å™¨éƒ½ä¼šèµ·ä½œç”¨ã€‚ å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥åƒæˆ‘ä¸€æ ·å·æ‡’ï¼šç»™Borderè®¾ç½®MouseOverçš„è§¦å‘å™¨ã€‚ 12345678910111213141516171819202122&lt;Border x:Name=\"root\"&gt; &lt;Border.Style&gt; &lt;Style TargetType=\"Border\"&gt; &lt;Style.Triggers&gt; &lt;Trigger Property=\"IsMouseOver\" Value=\"True\"&gt; &lt;Setter Property=\"Background\" Value=\"Red\"&gt;&lt;/Setter&gt; &lt;/Trigger&gt; &lt;/Style.Triggers&gt; &lt;/Style&gt; &lt;/Border.Style&gt; &lt;Grid&gt; &lt;Rectangle x:Name=\"selector\" Width=\"2\" Visibility=\"Collapsed\" Fill=\"Green\" HorizontalAlignment=\"Left\"&gt;&lt;/Rectangle&gt; &lt;Grid Margin=\"&#123;Binding RelativeSource=&#123;RelativeSource AncestorType=TreeViewItem&#125;,Converter=&#123;StaticResource TreeLevelToIndentConverter&#125;&#125;\"&gt; &lt;Grid.ColumnDefinitions&gt; &lt;ColumnDefinition Width=\"24\"&gt;&lt;/ColumnDefinition&gt; &lt;ColumnDefinition&gt;&lt;/ColumnDefinition&gt; &lt;/Grid.ColumnDefinitions&gt; &lt;Expander IsExpanded=\"&#123;Binding RelativeSource=&#123;RelativeSource TemplatedParent&#125;,Path=IsExpanded,Mode=TwoWay&#125;\" x:Name=\"expander\"&gt;&lt;/Expander&gt; &lt;ContentPresenter VerticalAlignment=\"Center\" Grid.Column=\"1\" ContentSource=\"Header\"&gt;&lt;/ContentPresenter&gt; &lt;/Grid&gt; &lt;/Grid&gt;&lt;/Border&gt; çœ‹èµ·æ¥å·²ç»åƒæ¨¡åƒæ ·äº†ï¼Œä½†è¿˜æœ‰ç‘•ç–µï¼š é€‰æ‹©é«˜äº®å¹¶ä¸å¯¹æ‰€æœ‰çš„å­èŠ‚ç‚¹ç”Ÿæ•ˆã€‚ é¼ æ ‡é«˜äº®æ²¡æœ‰è¦†ç›–é€‰æ‹©é«˜äº® é…è‰²ä¸å¯¹ï¼Œä¸‘ æˆ‘ä»¬ä¼šåœ¨ä¸‹ä¸€ç¯‡ä¸­æ”¹æ­£è¿™äº›é—®é¢˜ æºä»£ç å‚è§https://github.com/Verrickt/Melchior-Sample/tree/master/FluentTreeView_Part4","categories":[{"name":"FluentTreeView","slug":"FluentTreeView","permalink":"https://verrickt.github.io/categories/FluentTreeView/"}],"tags":[]},{"title":"FluentTreeView Part.3","slug":"fluent-treeview-part3","date":"2019-04-19T07:22:06.000Z","updated":"2019-04-19T09:23:58.343Z","comments":true,"path":"2019/04/19/fluent-treeview-part3/","link":"","permalink":"https://verrickt.github.io/2019/04/19/fluent-treeview-part3/","excerpt":"ä¸Šä¸€ç¯‡ä¸­æˆ‘ä»¬ç”¨æ•°æ®é©±åŠ¨ç•Œé¢çš„æ–¹å¼ä½¿ç”¨äº†TreeViewã€‚è¿™ä¸€ç¯‡æˆ‘ä»¬ç¨ç¨æ”¹ä¸€æ”¹TreeViewçš„æ ·å¼ã€‚æŠŠTreeViewè¡¨ç¤ºèŠ‚ç‚¹å¯ä»¥å±•å¼€çš„å°ä¸‰è§’æ›¿æ¢æˆExpanderæ˜¯ä¸ªä¸é”™çš„å¼€å§‹ã€‚æ—¢èƒ½å¤ä¹ TreeViewçš„å¯è§†åŒ–æ ‘ï¼Œåˆé¿å…æ­¥å­å¤ªå¤§æ‰¯åˆ°è›‹ã€‚","text":"ä¸Šä¸€ç¯‡ä¸­æˆ‘ä»¬ç”¨æ•°æ®é©±åŠ¨ç•Œé¢çš„æ–¹å¼ä½¿ç”¨äº†TreeViewã€‚è¿™ä¸€ç¯‡æˆ‘ä»¬ç¨ç¨æ”¹ä¸€æ”¹TreeViewçš„æ ·å¼ã€‚æŠŠTreeViewè¡¨ç¤ºèŠ‚ç‚¹å¯ä»¥å±•å¼€çš„å°ä¸‰è§’æ›¿æ¢æˆExpanderæ˜¯ä¸ªä¸é”™çš„å¼€å§‹ã€‚æ—¢èƒ½å¤ä¹ TreeViewçš„å¯è§†åŒ–æ ‘ï¼Œåˆé¿å…æ­¥å­å¤ªå¤§æ‰¯åˆ°è›‹ã€‚ è‡ªå®šä¹‰TreeViewæ ·å¼å›é¡¾ä¸€ä¸‹ï¼ŒTreeViewä¸­æˆ‘ä»¬æ‰€çœ‹åˆ°çš„æ‰€æœ‰Itemï¼Œéƒ½æ˜¯TreeViewItemè´Ÿè´£å‘ˆç°çš„ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦é‡ç°å®ç°TreeViewItemçš„Templateã€‚TreeViewItemè¦è´Ÿè´£å±•ç¤ºItemçš„å†…å®¹ï¼Œæ‰€ä»¥Templateé‡Œåº”è¯¥è¦æœ‰ä¸€ä¸ªContentPreserenterï¼›TreeViewItemè‡ªèº«ä¹Ÿæ˜¯ä¸ªItemsControlï¼ŒTemplateé‡Œä¹Ÿåº”æœ‰ä¸€ä¸ªItemsPreserenterã€‚é™¤æ­¤ä¹‹å¤–å°±æ˜¯è¡¨ç¤ºItemæ˜¯å¦å¯ä»¥å±•å¼€çš„å°ä¸‰è§’ï¼Œå³æˆ‘ä»¬è¦æ¢æˆExpanderçš„éƒ¨åˆ†ã€‚ ç»“åˆå›¾ç‰‡åˆ†æä¸€ä¸‹TreeViewItemçš„å¯è§†åŒ–æ ‘ã€‚é¦–å…ˆåº”æœ‰ä¸¤è¡Œï¼Œç¬¬ä¸€è¡Œæ˜¾ç¤ºå½“å‰Itemï¼Œç¬¬äºŒè¡Œæ˜¾ç¤ºä¸‹ä¸€çº§Itemï¼›å…¶æ¬¡åº”æœ‰ä¸¤åˆ—ï¼Œç¬¬ä¸€åˆ—æ”¾ç½®å°ä¸‰è§’ï¼Œç¬¬äºŒåˆ—å±•ç¤ºå†…å®¹ã€‚åº”è¯¥æ˜¯è¿™æ ·çš„ç»“æ„ï¼š|-|Column1|Column2||â€”â€”-|â€”â€”-|â€”â€”-||Row1|Expander|ContentPreserenter||Row2|/|ItemsPreserenter| è·Ÿå…¶ä»–æ§ä»¶ä¸ä¸€æ ·çš„æ˜¯ï¼Œåœ¨è®¾è®¡TreeViewItemçš„æ¨¡æ¿æ—¶ï¼Œè¦å…ˆä¸ç®¡ItemsPreserenteré‚£éƒ¨åˆ†ï¼Œå°±åƒå®ƒå·²ç»åšå¥½äº†ä¸€æ ·ã€‚å¾…åˆ°æŠŠå…¶ä½™éƒ¨åˆ†çš„ç»“æ„éƒ½å®šä¸‹æ¥äº†ï¼ŒItemsPreserenteréƒ¨åˆ†è‡ªç„¶å°±å¦‚æ„¿äº†ã€‚è¿™æœ‰å®é™…ä¸Šå°±æ˜¯é€’å½’ï¼šItemsPreserenteré‡Œæœ‰TreeViewItemçš„æ¨¡æ¿éœ€è¦å±•å¼€ï¼Œè¿™è·Ÿå½“å‰æ‰€åšçš„é—®é¢˜ï¼Œå³é‡æ–°å®ç°TreeViewItemçš„æ¨¡æ¿ï¼Œæ˜¯ä¸€æ ·çš„ã€‚æˆ‘ä»¬åœ¨ItemsPreserenterçš„é—®é¢˜å·²ç»è§£å†³çš„å‡è®¾ä¸Šï¼Œè§£å†³äº†TreeViewItemçš„æ¨¡æ¿ã€‚è¿™åƒæäº†æ±‰è¯ºå¡”ã€‚ ä¹ æƒ¯äº†è¿™æ ·çš„é€’å½’æ€è€ƒåï¼ŒæŠŠå‡ ä¸ªæ˜¾ç¤ºéšè—çš„å°ç»†èŠ‚å¤„ç†å¥½ï¼Œè¿™å°±å¾—åˆ°äº†ä¸‹é¢çš„XAML: 1234567891011121314151617181920212223242526&lt;Style TargetType=\"TreeViewItem\"&gt; &lt;Setter Property=\"Template\"&gt; &lt;Setter.Value&gt; &lt;ControlTemplate TargetType=\"TreeViewItem\"&gt; &lt;Grid&gt; &lt;Grid.ColumnDefinitions&gt; &lt;ColumnDefinition Width=\"24\"&gt;&lt;/ColumnDefinition&gt; &lt;ColumnDefinition&gt;&lt;/ColumnDefinition&gt; &lt;/Grid.ColumnDefinitions&gt; &lt;Grid.RowDefinitions&gt; &lt;RowDefinition Height=\"Auto\"&gt;&lt;/RowDefinition&gt; &lt;RowDefinition Height=\"*\"&gt;&lt;/RowDefinition&gt; &lt;/Grid.RowDefinitions&gt; &lt;Expander IsExpanded=\"&#123;Binding RelativeSource=&#123;RelativeSource TemplatedParent&#125;,Path=IsExpanded,Mode=TwoWay&#125;\" x:Name=\"expander\"&gt;&lt;/Expander&gt; &lt;ContentPresenter VerticalAlignment=\"Center\" Grid.Column=\"1\" ContentSource=\"Header\"&gt;&lt;/ContentPresenter&gt; &lt;ItemsPresenter Visibility=\"&#123;Binding RelativeSource=&#123;RelativeSource TemplatedParent&#125;,Path=IsExpanded,Converter=&#123;StaticResource BoolToVisibilityConverter&#125;&#125;\" Grid.Row=\"1\" Grid.Column=\"1\"&gt;&lt;/ItemsPresenter&gt; &lt;/Grid&gt; &lt;ControlTemplate.Triggers&gt; &lt;Trigger Property=\"HasItems\" Value=\"False\"&gt; &lt;Setter TargetName=\"expander\" Property=\"Visibility\" Value=\"Collapsed\"&gt;&lt;/Setter&gt; &lt;/Trigger&gt; &lt;/ControlTemplate.Triggers&gt; &lt;/ControlTemplate&gt; &lt;/Setter.Value&gt; &lt;/Setter&gt;&lt;/Style&gt; å¤§åŠŸå‘Šæˆ! æºä»£ç å‚è§https://github.com/Verrickt/Melchior-Sample/tree/master/FluentTreeView_Part3","categories":[{"name":"FluentTreeView","slug":"FluentTreeView","permalink":"https://verrickt.github.io/categories/FluentTreeView/"}],"tags":[]},{"title":"FluentTreeView Part.2","slug":"fluent-treeview-part2","date":"2019-04-19T06:18:40.000Z","updated":"2019-04-19T07:13:08.423Z","comments":true,"path":"2019/04/19/fluent-treeview-part2/","link":"","permalink":"https://verrickt.github.io/2019/04/19/fluent-treeview-part2/","excerpt":"ä½¿ç”¨TreeViewä¸Šæ¬¡è¯´åˆ°äº†TreeViewå…·æœ‰é€’å½’çš„ç»“æ„ï¼Œè€Œåœ¨WPFä¸­æ˜¯æ•°æ®é©±åŠ¨ç•Œé¢ï¼Œè¿™å°±è¦æ±‚æˆ‘ä»¬çš„æ•°æ®æºä¹Ÿå…·æœ‰ä¸€å®šçš„é€’å½’ç»“æ„","text":"ä½¿ç”¨TreeViewä¸Šæ¬¡è¯´åˆ°äº†TreeViewå…·æœ‰é€’å½’çš„ç»“æ„ï¼Œè€Œåœ¨WPFä¸­æ˜¯æ•°æ®é©±åŠ¨ç•Œé¢ï¼Œè¿™å°±è¦æ±‚æˆ‘ä»¬çš„æ•°æ®æºä¹Ÿå…·æœ‰ä¸€å®šçš„é€’å½’ç»“æ„ æ•°æ®çš„å‡†å¤‡æŒ‰ç…§æ•°æ®æºæ˜¯å¦å¯ä»¥ç»§ç»­å±•å¼€ä¸‹å»ï¼Œæˆ‘ä»¬å°†æ•°æ®æºå®šä¹‰ä¸ºä¸¤ä¸ªViewModel:TreeNodeVM,TreeLeafVMï¼Œå…¶ä¸­TreeNodeVMä½œä¸ºæ ‘çš„ä¸­é—´èŠ‚ç‚¹å‡ºç°ï¼Œå…¶ä¸‹å¯ç»§ç»­å‡ºç°ä¸­é—´èŠ‚ç‚¹å’Œå¶å­èŠ‚ç‚¹ï¼ŒTreeLeafVMä½œä¸ºæ ‘çš„å¶å­èŠ‚ç‚¹å‡ºç°ï¼Œä¸èƒ½å†å‡ºç°å…¶ä»–èŠ‚ç‚¹ã€‚TreeNodeVMä¸­çš„å­èŠ‚ç‚¹çš„ä¸ªæ•°æ˜¯ä¸å®šçš„ï¼Œæ‰€ä»¥åº”è¯¥ç”±é›†åˆè¡¨ç¤ºã€‚è€ŒTreeNodeVMçš„å­èŠ‚ç‚¹å¯èƒ½æ˜¯TreeNodeVMå’ŒTreeLeafVMçš„ä»»æ„ä¸€ç§ï¼Œè¿™å°±éœ€è¦ä»–ä»¬æœ‰ä¸€ä¸ªå…¬å…±çš„çˆ¶ç±»ã€‚è¿™ç»™æˆ‘ä»¬å¦‚ä¸‹çš„æ•°æ®å®šä¹‰:1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859abstract class TreeVMBase : ViewModelBase&#123; public abstract ObservableCollection&lt;TreeVMBase&gt; Items &#123; get; set; &#125; private string _name; public string Name &#123; get &#123; return _name; &#125; private set &#123; Set (ref _name, value); &#125; &#125; protected static IEnumerable&lt;TreeVMBase&gt; Empty =&gt; Enumerable.Empty&lt;TreeVMBase&gt; (); public TreeVMBase (string name) &#123; Name = name; &#125;&#125;class TreeNodeVM : TreeVMBase&#123; private ObservableCollection&lt;TreeVMBase&gt; _items; public override ObservableCollection&lt;TreeVMBase&gt; Items &#123; get &#123; return _items; &#125; set &#123; Set (ref _items, value); &#125; &#125; public TreeNodeVM (string name, IEnumerable&lt;TreeVMBase&gt; items) : base (name) &#123; _items = new ObservableCollection&lt;TreeVMBase&gt; (items??Empty); &#125;&#125;class TreeLeafVM : TreeVMBase&#123; private static readonly ObservableCollection&lt;TreeVMBase&gt; _items = new ObservableCollection&lt;TreeVMBase&gt; (); public override ObservableCollection&lt;TreeVMBase&gt; Items &#123; get &#123; return _items; &#125; set &#123; &#125; &#125; public TreeLeafVM (string name) : base (name) &#123; &#125;&#125; æˆ‘ä»¬çš„MainViewModeléœ€è¦ç»™TreeViewæä¾›æ•°æ®æºã€‚ä¸Šä¸€èŠ‚é‡Œæåˆ°ï¼Œæ¯ä¸€ä¸ªTreeViewIteméƒ½æ˜¯ä¸€æ£µæ ‘çš„æ ¹èŠ‚ç‚¹ã€‚è€Œæˆ‘ä»¬çš„TreeViewï¼Œä½œä¸ºæœ€é¡¶çº§TreeViewItemçš„ç›´æ¥çˆ¶èŠ‚ç‚¹ï¼Œåº”è¯¥æ˜¯æ£®æ—ã€‚TreeViewçš„ItemsSourceçš„ç±»å‹åº”è¯¥æ˜¯IEnumerable&lt;TreeVMBase&gt; 12345678910111213141516171819202122232425262728293031class MainViewModel : ViewModelBase&#123; private ObservableCollection&lt;TreeVMBase&gt; _treeViewBase; public ObservableCollection&lt;TreeVMBase&gt; TreeViewBase &#123; get &#123; return _treeViewBase; &#125; set &#123; Set (ref _treeViewBase, value); &#125; &#125; public MainViewModel () &#123; var leafs = new [] &#123; new TreeLeafVM (\"Leaf1\"), new TreeLeafVM (\"Leaf2\"), new TreeLeafVM (\"Leaf3\") &#125;; var nodes = new [] &#123; new TreeNodeVM (\"Node1\", null), new TreeNodeVM (\"Node2\", leafs), new TreeNodeVM (\"Node3\", leafs.Skip (1).Take(1)) &#125;; TreeViewBase = new ObservableCollection&lt;TreeVMBase&gt; (new [] &#123; new TreeNodeVM (\"Root1\", nodes), new TreeNodeVM (\"Root2\", nodes) &#125;); &#125;&#125; ç•Œé¢çš„å‡†å¤‡ç›¸æ¯”æœ‰ç»§æ‰¿å…³ç³»çš„æ•°æ®ï¼Œç•Œé¢è¿™è¾¹å°±ç®€å•ä¸€äº›äº†ã€‚ç•Œé¢çš„ä¸»è¦é—®é¢˜æ˜¯ï¼Œéœ€è¦ä¸€ä¸ªåŠæ³•æ¥å‘Šè¯‰TreeViewItemåº”è¯¥å¦‚ä½•å‘ˆç°æ•°æ®ï¼Œåº”è¯¥æ•°æ®ä¸Šä¸‹æ–‡çš„å“ªä¸€ä¸ªå±æ€§ä¸Šå¯»æ‰¾åº”è¯¥ç”Ÿæˆå­©å­çš„æ•°æ®æºï¼Œä»¥åŠé€’å½’åœ°å‘Šè¯‰è‡ªå·±çš„å­©å­å¦‚ä½•å‘ˆç°æ•°æ®ï¼Œå¦‚ä½•ç”Ÿæˆå­©å­çš„å­©å­ã€‚ DataTemplateå·²ç»èƒ½å‘Šè¯‰TreeViewItemå¦‚ä½•å‘ˆç°æ•°æ®ï¼Œå…³é”®åœ¨äºå¦‚ä½•å¯»æ‰¾ç”Ÿæˆå­©å­çš„æ•°æ®æºã€‚è¿™ä¸ªé—®é¢˜çš„ç­”æ¡ˆå°±è—åœ¨HierarchicalDataTemplateé‡Œã€‚Hierarchicalæœ‰å±‚çº§çš„æ„æ€ï¼Œå®ƒæ¯”DataTemplateå¤šçš„ä¸€ä¸ªå±æ€§å«åšItemsSourceã€‚æŠŠItemsSourceè®¾ç½®ä¸ºTreeVMBaseçš„æŠ½è±¡å±æ€§Itemsï¼ŒTreeViewItemå°±ä¼šè‡ªåŠ¨åœ°åœ¨æ•°æ®ä¸Šä¸‹æ–‡ä¸Šå¯»æ‰¾Itemså±æ€§ï¼ŒæŒ‰ç…§å±æ€§å€¼ç”Ÿæˆæ–°çš„TreeViewItemï¼Œå¹¶ä¸”æŠŠè¿™ä¸ªè¿‡ç¨‹é€’å½’åœ°è¿›è¡Œä¸‹å»ã€‚ 123456789&lt;TreeView ItemsSource=\"&#123;Binding TreeViewBase&#125;\"&gt; &lt;TreeView.ItemTemplate&gt; &lt;HierarchicalDataTemplate ItemsSource=\"&#123;Binding Items&#125;\"&gt; &lt;Grid&gt; &lt;TextBlock Text=\"&#123;Binding Name&#125;\"&gt;&lt;/TextBlock&gt; &lt;/Grid&gt; &lt;/HierarchicalDataTemplate&gt; &lt;/TreeView.ItemTemplate&gt;&lt;/TreeView&gt; å¤§åŠŸå‘Šæˆ æºä»£ç å‚è§https://github.com/Verrickt/Melchior-Sample/tree/master/FluentTreeView","categories":[{"name":"FluentTreeView","slug":"FluentTreeView","permalink":"https://verrickt.github.io/categories/FluentTreeView/"}],"tags":[]},{"title":"FluentTreeView Part.1","slug":"fluent-treeview-part1","date":"2019-04-19T01:51:10.000Z","updated":"2019-04-19T07:13:10.857Z","comments":true,"path":"2019/04/19/fluent-treeview-part1/","link":"","permalink":"https://verrickt.github.io/2019/04/19/fluent-treeview-part1/","excerpt":"ItemsControlæœ‰æ—¶éœ€è¦å‘ˆç°ä¸€ç»„é€»è¾‘ä¸Šå¹³çº§çš„æ§ä»¶ï¼Œä»–ä»¬å¯ä»¥æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªç½‘æ ¼ï¼›å¯ä»¥æ¨ªå‘æ’åˆ—ï¼Œä¹Ÿå¯ä»¥çºµå‘æ’åˆ—ï¼›æ•°é‡å¯ä»¥å›ºå®šï¼Œä¹Ÿå¯ä»¥æŒ‰éœ€åŠ è½½ï¼›æ™®é€šæ§ä»¶çš„ç»„åˆæ— èƒ½ä¸ºåŠ›ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦æ–°çš„å·¥å…·ã€‚ItemsControlåº”è¿è€Œç”Ÿã€‚","text":"ItemsControlæœ‰æ—¶éœ€è¦å‘ˆç°ä¸€ç»„é€»è¾‘ä¸Šå¹³çº§çš„æ§ä»¶ï¼Œä»–ä»¬å¯ä»¥æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªç½‘æ ¼ï¼›å¯ä»¥æ¨ªå‘æ’åˆ—ï¼Œä¹Ÿå¯ä»¥çºµå‘æ’åˆ—ï¼›æ•°é‡å¯ä»¥å›ºå®šï¼Œä¹Ÿå¯ä»¥æŒ‰éœ€åŠ è½½ï¼›æ™®é€šæ§ä»¶çš„ç»„åˆæ— èƒ½ä¸ºåŠ›ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦æ–°çš„å·¥å…·ã€‚ItemsControlåº”è¿è€Œç”Ÿã€‚ ItemsControlè‡ªèº«æ˜¯ä¸ªæ§ä»¶ï¼Œæ‰€ä»¥å®ƒå…·æœ‰ç»§æ‰¿è‡ªæ§ä»¶çš„å¸ƒå±€å±æ€§(Margin,Padding,Backgroundç­‰)ï¼›WPFä½œä¸ºä¸€ä¸ªæ•°æ®é©±åŠ¨ç•Œé¢çš„æ¡†æ¶ï¼Œå®ƒè¦è´Ÿè´£æ ¹æ®æ•°æ®ç”Ÿæˆæ¯ä¸ªItemï¼›å¤šä¸ªItemä¹‹é—´éœ€è¦æŸç§æ’åˆ—é€»è¾‘ï¼Œè¿™ä¹Ÿæ˜¯ItmesControlçš„ä»»åŠ¡ï¼›åœ¨Itemå¯è¢«é€‰æ‹©çš„æ—¶å€™ï¼Œé€‰ä¸­çš„å’Œæœªé€‰ä¸­çš„è¦åœ¨è§†è§‰ä¸ŠåšåŒºåˆ†ã€‚è¿™ç§è§†è§‰åŒºåˆ†æœ€å¥½ä¸éœ€è¦å¼€å‘è€…è‡ªå·±æ“å¿ƒã€‚è¿™ä¸ªå…‰è£çš„ä»»åŠ¡åˆè½åœ¨äº†ItemsControlçš„å¤´ä¸Šï¼›ç‹¬ç«‹äºæ•°æ®ï¼ŒItemè‡ªèº«éœ€è¦æ’åºï¼Œè¿‡æ»¤ï¼›é€»è¾‘ä¸Šèƒ½å¤Ÿå½’ä¸ºä¸€ç±»çš„Itemæœ‰æ—¶è¦æ”¾åœ¨ä¸€èµ·ï¼Œè¿™å°±åˆç‰µæ‰¯åˆ°åˆ†ç»„çš„äº†ã€‚ ItemsControlèŒè´£çš„åˆ—è¡¨èƒ½åˆ—å¾ˆé•¿ï¼Œå†µä¸”è¿™è¿˜æ²¡è¯´æ•°æ®è™šæ‹ŸåŒ–å’Œç•Œé¢è™šæ‹ŸåŒ–å‘¢ã€‚ç§‰æŒç€é¢å‘å¯¹è±¡è®¾è®¡çš„åŸåˆ™ï¼ŒItemsControlè¿™é‡Œè‚¯å®šç‰µæ‰¯åˆ°äº†å¾ˆå¤šçš„ç±»ã€‚ äº‹å®ä¹Ÿæ˜¯å¦‚æ­¤ã€‚ä¸ºäº†å®ç°ç»§æ‰¿è‡ªæ§ä»¶çš„å±æ€§ï¼ŒItemsControléœ€è¦æŠŠè‡ªå·±æ”¾åœ¨ä¸€ä¸ªPanelé‡Œã€‚ä¸ºäº†å®ç°æ•°æ®é©±åŠ¨ç•Œé¢ï¼ŒItemsControlå€ŸåŠ©äº†ItemContainerGeneratorï¼Œä¸€ä¸ªç”±æ•°æ®ç”ŸæˆUIç•Œé¢çš„ç±»ï¼›ä¸ºäº†è§£å†³Itemä¹‹é—´çš„æ’å¸ƒæ–¹å¼ï¼Œå¼•å…¥äº†ItemsPanelï¼›ä¸ºäº†å®ç°ä¸éœ€å¼€å‘è€…æ“å¿ƒçš„é€‰ä¸­/æœªé€‰çŠ¶æ€çš„è§†è§‰åŒºåˆ†ï¼Œåœ¨Itemå¤–é¢å¥—äº†ä¸€å±‚å®¹å™¨(ItemContainer)ã€‚è¿™ä¹ˆæ¥çœ‹ï¼ŒItemsControlçš„å¯è§†åŒ–æ ‘ä¼šé•¿æˆè¿™æ ·å°±ä¸å¥‡æ€ªäº†ï¼š12345678910ItemsControl Panel ItemsPreserenter ItemsPanel ItemContainer Item(DataTemplate) ItemContainer Item(DataTemplate) ItemContainer Item(DataTemplate) ItemsControlå…¶å®å¹¶ä¸å¸¸ç”¨ï¼Œæ—¥å¸¸ä½¿ç”¨æ¥è§¦æœ€å¤šçš„æ˜¯å®ƒçš„å­ç±»ï¼š ListView ListBox ComboBox TreeView ç›¸æ¯”èªæ˜çš„ä½ å·²ç»ä»è¿™ä¸ªç³»åˆ—çš„åå­—é‡ŒçŒœå‡ºæ¥äº†ï¼Œæˆ‘ä»¬è¦ç ”ç©¶çš„æ˜¯TreeView TreeView,TreeViewItemä¸HeaderedItemsControlTreeViewæ˜¯ä¸ªå¾ˆç‰¹æ®Šçš„ItemsControlã€‚åˆ—è¡¨ä¹Ÿå¥½ï¼Œç½‘æ ¼ä¹Ÿå¥½ï¼Œå…¶ä»–çš„ItemsControlæ‰€èƒ½å±•ç¤ºçš„éƒ½æ˜¯åŒä¸€ç­‰çº§çš„Itemï¼Œè€ŒTreeViewå´å¯ä»¥å±•ç¤ºå¤šçº§ã€‚è¿™å…¶ä¸­çš„å¥¥ç§˜å°±è—åœ¨ItemContaineré‡Œã€‚ æ¯ä¸ªItemControlçš„å­ç±»éƒ½æœ‰å…¶å¯¹åº”çš„ItemContainerï¼ŒListViewå¯¹åº”ListViewItemï¼ŒComboBoxå¯¹åº”ComboBoxItemï¼Œèªæ˜çš„ä½ ï¼Œå¿«æ¥æƒ³æƒ³TreeViewå¯¹åº”çš„æ˜¯ä»€ä¹ˆğŸ˜‹ ç°åœ¨æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼ŒæŠŠItemsControlçš„å¯è§†åŒ–æ ‘ä¸­çš„ä¸€ä¸ªå“ªä¸€ä¸ªèŠ‚ç‚¹æ›¿æ¢æ‰ï¼Œä¼šè®©ItemsControlå‡ºç°å¤šçº§çš„ç»“æ„ï¼Ÿ//æç¤ºï¼šçœ‹æœ¬èŠ‚åå­— æ­æ™“ç­”æ¡ˆã€‚ä¸€ä¸ªå¾ˆè‡ªç„¶çš„æƒ³æ³•æ˜¯ï¼Œå¦‚æœTreeViewçš„ItemContainerï¼Œå³TreeViewItemï¼Œè‡ªå·±ä¹Ÿæ˜¯ä¸€ä¸ªItemsControlçš„è¯ï¼Œé‚£å°±å¯ä»¥å‡ºç°ä¸¤çº§ç»“æ„äº†ã€‚è¿›ä¸€æ­¥æƒ³ä¸‹å»ï¼ŒTreeViewItemå¦‚æœæ˜¯ä¸ªItemsControlçš„è¯ï¼Œå®ƒå¿…ç„¶è¦æœ‰ItemContainerã€‚å¦‚æœè¿™ä¸ªItemContaineræ°å¥½æ˜¯TreeViewItemå‘¢ï¼Ÿè¦æ˜¯è¿™æ ·çš„è¯ï¼ŒTreeViewItemä¸‹é¢å¯ä»¥å†æœ‰ä»»æ„å¤šä¸ªTreeViewItemã€‚é€’å½’çš„æƒ³ä¸‹å»ï¼Œè¿™æ ·TreeViewItemå°±å¯ä»¥æœ‰æ— æ•°çº§äº†ã€‚ å…¶å®ï¼ŒTreeViewçš„å®ç°è·Ÿæˆ‘ä»¬çŒœæƒ³æ˜¯åŸºæœ¬ä¸€è‡´çš„ã€‚åªæ˜¯æˆ‘ä»¬çš„çŒœæƒ³ä¸­ï¼ŒTreeViewItemé‡Œæ²¡æœ‰ä½ç½®ç”¨æ¥å‘ˆç°å½“å‰çš„Itemï¼Œè¿™å°±å¼•å…¥äº†å¦ä¸€ä¸ªç±»ï¼ŒHeaderedItemsControlã€‚å®ƒç»§æ‰¿è‡ªItemsControlï¼Œæ·»åŠ äº†Headerå±æ€§ã€‚è¿™ä¸ªHeaderå±æ€§å°±å¯ä»¥ç”¨æ¥å‘ˆç°æˆ‘ä»¬çš„Itemã€‚ é‚£ä¹ˆTreeViewçš„å¯è§†åŒ–æ ‘æ˜¯è¿™æ ·çš„123456789101112131415161718TreeView Panel ItemsPreserenter ItemsPanel TreeViewItem Header Item(DataTemplate) ItemsPreserenter ItemsPanel TreeViewItem TreeViewItem TreeViewItem Header Item(DataTemplate) ItemsPreserenter ItemsPanel TreeViewItem TreeViewItem å…¶ä¸­æ¯ä¸€çº§çš„TreeViewIteméƒ½å¯ä»¥å±•å¼€ä¸ºè¿™æ ·çš„ç»“æ„ï¼š123456Header Item(DataTemplate)ItemsPreserenter ItemsPanel TreeViewItem TreeViewItem åœ¨WPFè¿™ä¸ªæ•°æ®é©±åŠ¨ç•Œé¢çš„UIæ¡†æ¶é‡Œï¼Œæƒ³è¦å‘ˆç°é€’å½’çš„UIç•Œé¢ï¼Œæœ€è‡ªç„¶çš„æ–¹æ³•å°±æ˜¯æŠŠæ•°æ®ä¹Ÿå˜å¾—é€’å½’åŒ–ã€‚å³ï¼Œæ•°æ®ä¹Ÿè¦å˜æˆæ ‘çŠ¶ç»“æ„ã€‚(ä¸¥æ ¼æ¥è¯´åº”è¯¥æ˜¯æ•°æ®ç»“æ„ä¸­æ£®æ—çš„æ¦‚å¿µã€‚TreeViewæ˜¯æ£®æ—ï¼ŒTreeViewItemåˆ™æ˜¯ä¸€æ£µæ ‘ã€‚å¯¹åº”åœ°ï¼Œæ•°æ®ä¹Ÿè¦å˜æˆæ£®æ—çš„ç»“æ„ã€‚å³ï¼Œæ ‘çŠ¶çš„é›†åˆ) æ—¢ç„¶UIç»“æ„å·²ç»é€’å½’åŒ–ï¼ŒåŸæ¥æŒ‡æ˜å•å±‚Itemså¦‚ä½•å‘ˆç°çš„ItemTemplateå·²ç»ä¸å¤Ÿç”¨äº†ã€‚HierarchicalItemTemplateé—ªäº®ç™»åœºã€‚æœ€é‡è¦çš„å±æ€§ï¼ŒItemsSourceæ˜¯å¹²ä»€ä¹ˆçš„ï¼Œæˆ‘ä»¬å–ä¸ªå…³å­ã€‚ FluentTreeViewç»ˆäºè¦è®²è®²ä»€ä¹ˆæ˜¯FluentTreeViewäº†ã€‚ä½œä¸ºä¸€ä¸ªåå¤šå²çš„UIæ¡†æ¶ï¼ŒWPFå·²ç»è¿›å…¥äº†ç»´æŠ¤æœŸã€‚æ–°å‡ºç”Ÿçš„UWPåŠŸèƒ½å°šä¸”ä¸å…¨ï¼Œå¯¼è‡´å¾ˆå¤šåº”ç”¨åªå¾—ä½¿ç”¨WPFã€‚ç›¸æ¯”UWPï¼ŒWPFçš„é€Šè‰²çš„åœ°æ–¹å°±åœ¨äºå¤–è§‚ã€‚æ¯æ¬¡åŠŸèƒ½æ›´æ–°ï¼ŒUWPé»˜è®¤çš„å¤–è§‚å°±å‘Windowsçš„æœªæ¥çš„æ ·å­ï¼ŒFluent designé è¿‘ä¸€æ­¥ã€‚ä¸ºäº†è®©WPFä¹Ÿèƒ½å˜å¾—æ›´ç°ä»£ä¸€äº›ï¼Œæœ¬ç³»åˆ—æ—¨åœ¨å°†WPFæ§ä»¶Fluent designåŒ–ã€‚ ç©ºå£æ— å‡­ï¼Œæ¥çœ‹çœ‹æˆ‘ä»¬çš„ç›®æ ‡ å·¦ä¾§æœ‰å½“å‰ä¸»é¢˜è‰²(Accent color)çš„é€‰ä¸­é«˜äº®æŒ‡ç¤º é¼ æ ‡é«˜äº®æ’‘æ»¡æ•´ä¸ªæ§ä»¶å®½åº¦ åœ¨å®ç°FluentTreeViewçš„æ—¶å€™ï¼Œç»å¸¸ItemsControlå’ŒTreeViewçš„ç›¸å…³çŸ¥è¯†ã€‚æ‰€ä»¥çœ‹ä¸æ‡‚åé¢çš„æ—¶å€™ï¼Œå°½ç®¡å›æ¥ç¿»çœ‹ç¬¬ä¸€ç¯‡ã€‚é‚£ä¹ˆæˆ‘ä»¬ä¸‹ç¯‡è§ã€‚","categories":[{"name":"FluentTreeView","slug":"FluentTreeView","permalink":"https://verrickt.github.io/categories/FluentTreeView/"}],"tags":[]},{"title":"è·å–ç¨‹åºçš„ç¼–è¯‘æ—¶é—´","slug":"get-link-time-from-csharp","date":"2018-10-22T15:16:44.000Z","updated":"2018-10-22T16:23:49.590Z","comments":true,"path":"2018/10/22/get-link-time-from-csharp/","link":"","permalink":"https://verrickt.github.io/2018/10/22/get-link-time-from-csharp/","excerpt":"æ—¥å¸¸æ–°éœ€æ±‚æ–°çš„éœ€æ±‚åˆæ¥äº†ã€‚è¿™æ¬¡æ˜¯ç¨‹åºåœ¨ç¼–è¯‘å6ä¸ªæœˆæ‹’ç»å¯åŠ¨ã€‚BETAæ€§è´¨çš„è½¯ä»¶éƒ½æœ‰ç±»ä¼¼çš„éœ€æ±‚ã€‚ä½†å¤§éƒ¨åˆ†è½¯ä»¶è¦ä¹ˆæ˜¯å¯åŠ¨æ—¶æ£€æŸ¥æ›´æ–°ï¼Œè¦ä¹ˆæ˜¯è”ç½‘åˆ¤æ–­æ˜¯å¦è¿‡æœŸã€‚å¯¹äºæˆ‘ä»¬ç°åœ¨åšçš„è¿™ä¸ªå°å·¥å…·å¤ªå°é¢˜å¤§åšäº†ã€‚æ ¹æ®ç¼–è¯‘æ—¶é—´åˆ¤æ–­è¿‡æœŸçš„éœ€æ±‚çœ‹ä¼¼å¥‡è‘©ï¼Œä¹Ÿæ˜¯æœ‰ç‚¹é“ç†çš„ã€‚","text":"æ—¥å¸¸æ–°éœ€æ±‚æ–°çš„éœ€æ±‚åˆæ¥äº†ã€‚è¿™æ¬¡æ˜¯ç¨‹åºåœ¨ç¼–è¯‘å6ä¸ªæœˆæ‹’ç»å¯åŠ¨ã€‚BETAæ€§è´¨çš„è½¯ä»¶éƒ½æœ‰ç±»ä¼¼çš„éœ€æ±‚ã€‚ä½†å¤§éƒ¨åˆ†è½¯ä»¶è¦ä¹ˆæ˜¯å¯åŠ¨æ—¶æ£€æŸ¥æ›´æ–°ï¼Œè¦ä¹ˆæ˜¯è”ç½‘åˆ¤æ–­æ˜¯å¦è¿‡æœŸã€‚å¯¹äºæˆ‘ä»¬ç°åœ¨åšçš„è¿™ä¸ªå°å·¥å…·å¤ªå°é¢˜å¤§åšäº†ã€‚æ ¹æ®ç¼–è¯‘æ—¶é—´åˆ¤æ–­è¿‡æœŸçš„éœ€æ±‚çœ‹ä¼¼å¥‡è‘©ï¼Œä¹Ÿæ˜¯æœ‰ç‚¹é“ç†çš„ã€‚ å®ç°é‡äº‹ä¸å†³é—®SOï¼Œæˆ‘ä»¬è¾“å…¥â€C# get compile timeâ€æ‰¾åˆ°çš„ç¬¬ä¸€ä¸ªé—®é¢˜å°±æ˜¯äº†ã€‚ æ–¹æ³•æœ‰å¾ˆå¤šï¼Œå¤§è‡´åˆ†ä¸ºè¿™å‡ ç±»ã€‚ è¯»å–PEå¤´éƒ¨æ—¶é—´æˆ³ æ·»åŠ Build Taskå°†ç¼–è¯‘æ—¶é—´ä»¥èµ„æºåµŒå…¥ç¨‹åºé›† è¯»å–æ–‡ä»¶åˆ›å»ºæ—¶é—´ ä¸¥æ ¼æ„ä¹‰ä¸Šè¯´ï¼Œæ–‡ä»¶åˆ›å»ºæ—¶é—´ä¸æ–‡ä»¶ç³»ç»Ÿç›¸å…³ï¼Œä¾èµ–ç¨‹åºå¤–éƒ¨ï¼Œç¢°åˆ°ä¸ä¿ç•™åˆ›å»ºæ—¶é—´çš„æ“ä½œå°±åªèƒ½å¹²çªçœ¼äº†ï¼Œæ‰€ä»¥æ’é™¤æ‰ã€‚ è€Œæ·»åŠ Build Taskåˆéœ€è¦ç¨‹åºè¯»å–èµ„æºï¼Œååºåˆ—åŒ–äº‘äº‘ï¼Œæ¯”è¾ƒéº»çƒ¦ã€‚å› æ­¤ä¸»è¦å…³æ³¨1ä¸­çš„æ–¹æ³•ã€‚ .NETçš„ç¨‹åºé›†éƒ½åŒ…å«PEå¤´éƒ¨ã€‚å…ˆæ¥ä¸€å¼ å›¾æ„Ÿå—ä¸€ä¸‹ã€‚ æˆ‘ä»¬éœ€è¦çš„å­—æ®µåœ¨COFFHeaderçš„TimeDateStampå¤„ã€‚ éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œå›¾ä¸­çš„åç§»é‡æ˜¯ç›¸å¯¹PEå¤´çš„ï¼Œè€Œåœ¨PEå¤´éƒ¨ä¹‹å‰è¿˜æœ‰DOSå¤´éƒ¨ã€‚ å†æ¥çœ‹çœ‹StackOverflowä¸Šçš„ç­”æ¡ˆï¼Œæ˜¯ä¸æ˜¯æ¯”è¾ƒç›´è§‚å‘¢ï¼Ÿ 12345678910111213141516171819202122232425262728293031323334353637383940// see https://stackoverflow.com/a/1601079struct _IMAGE_FILE_HEADER&#123; public ushort Machine; public ushort NumberOfSections; public uint TimeDateStamp; public uint PointerToSymbolTable; public uint NumberOfSymbols; public ushort SizeOfOptionalHeader; public ushort Characteristics;&#125;;static DateTime GetBuildDateTime(Assembly assembly)&#123; var path = assembly.GetName().CodeBase; if (File.Exists(path)) &#123; var buffer = new byte[Math.Max(Marshal.SizeOf(typeof(_IMAGE_FILE_HEADER)), 4)]; using (var fileStream = new FileStream(path, FileMode.Open,FileAccess.Read)) &#123; fileStream.Position = 0x3C; fileStream.Read(buffer, 0, 4); fileStream.Position = BitConverter.ToUInt32(buffer, 0); // COFF header offset fileStream.Read(buffer, 0, 4); // \"PE\\0\\0\" fileStream.Read(buffer, 0, buffer.Length); &#125; var pinnedBuffer = GCHandle.Alloc(buffer, GCHandleType.Pinned); try &#123; var coffHeader = (_IMAGE_FILE_HEADER)Marshal.PtrToStructure(pinnedBuffer.AddrOfPinnedObject(),typeof(_IMAGE_FILE_HEADER)); return TimeZone.CurrentTimeZone.ToLocalTime(new DateTime(1970, 1, 1) + new TimeSpan(coffHeader.TimeDateStamp * TimeSpan.TicksPerSecond)); &#125; finally &#123; pinnedBuffer.Free(); &#125; &#125; return new DateTime();&#125; ä»Ox3Cä½ç½®è¯»åˆ°PEå¤´éƒ¨çš„ä½ç½®åSeekåˆ°è¯¥ä½ç½®ï¼Œè¯»å–å†…å®¹åå°†å…¶è½¬æ¢ä¸ºè‡ªå®šä¹‰çš„_IMAGE_FILE_HEADERç»“æ„ï¼Œè¯»å–TimeDateStampå³å¯ã€‚ ç›´æ¥è¿è¡Œçš„ç»“æœæ˜¯1900/1/1 12:00:00ï¼Œä¸å¯¹ã€‚åŸå› æ˜¯AssemblyName.CodeBaseå±æ€§è¿”å›çš„å¹¶ä¸æ˜¯ç¨‹åºé›†æ‰€åœ¨è·¯å¾„ï¼Œè€Œæ˜¯File schemeçš„URI file:\\\\\\c:\\MyDirectory\\MyAssemlby.exeã€‚ä½¿ç”¨AssemblyNameåé—®é¢˜è§£å†³ã€‚ä»Ox3Cä½ç½®è¯»åˆ°PEå¤´éƒ¨çš„ä½ç½®åSeekåˆ°è¯¥ä½ç½®ï¼Œè¯»å–å†…å®¹åå°†å…¶è½¬æ¢ä¸ºè‡ªå®šä¹‰çš„_IMAGE_FILE_HEADER.TimeDateStampï¼Œè¯»å–TimeDateStampå³å¯ã€‚PEå¤´éƒ¨çš„TimeDateStampå­—æ®µæ˜¯ä»unix epollç®—èµ·çš„ï¼Œ8102å¹´çš„.NETä¸­ä¹Ÿæœ‰ä¸“é—¨å¤„ç†è¿™é‡Œæƒ…å†µçš„DateTimeOffSetï¼Œè€Œå¼‚å¸¸æƒ…å†µæˆ‘ä»¬å®Œå…¨å¯ä»¥è¿”å›nullã€‚ä¿®æ”¹åä»£ç å¦‚ä¸‹ 123456789101112131415161718192021222324252627282930static DateTimeOffset? GetBuildDateTime(this Assembly assembly)&#123; var path = assembly.Location; if (File.Exists(path)) &#123; var buffer = new byte[Math.Max(Marshal.SizeOf(typeof(_IMAGE_FILE_HEADER)), 4)]; using (var fileStream = new FileStream(path, FileMode.Open, FileAccess.Read)) &#123; fileStream.Position = 0x3C; fileStream.Read(buffer, 0, 4); fileStream.Position = BitConverter.ToUInt32(buffer, 0); // COFF header offset fileStream.Read(buffer, 0, 4); // \"PE\\0\\0\" fileStream.Read(buffer, 0, buffer.Length); &#125; var pinnedBuffer = GCHandle.Alloc(buffer, GCHandleType.Pinned); try &#123; var coffHeader = (_IMAGE_FILE_HEADER)Marshal.PtrToStructure(pinnedBuffer.AddrOfPinnedObject(), typeof(_IMAGE_FILE_HEADER)); return DateTimeOffset.FromUnixTimeSeconds(coffHeader.TimeDateStamp); &#125; finally &#123; pinnedBuffer.Free(); &#125; &#125; else &#123; return null; &#125;&#125; ä¿®æ”¹åå‘ç°è¿”å›çš„æ˜¯ä¸€ä¸ªåœ¨2090å¹´ä¹‹åçš„æ—¥æœŸï¼Œè¿˜æ˜¯ä¸å¯¹ã€‚ Deterministic Build æ¥èƒŒé”…è¿™æ¬¡çš„åŸå› æ˜¯MSåœ¨æŸä¸ªRoslynç‰ˆæœ¬ä¸­é»˜è®¤å¼€å¯äº†Deterministic Build â€¦.. The /deterministic flag causes the compiler to emit the exact same EXE / DLL, byte for byte, when given the same inputs. æ—¢ç„¶è¾“å…¥ç›¸åŒè¾“å‡ºå¿…å®šç›¸åŒï¼Œé‚£å¯èƒ½ä¼šå˜çš„éƒ¨åˆ†å°±åªèƒ½å›ºå®šä¸‹æ¥äº†ã€‚ä¾‹å¦‚æ—¶é—´æˆ³ã€‚ â€¦ the MVID, PDB ID and Timestamp are the core issues to solve for deterministic builds. MSé€‰äº†ä¸€ä¸ªæ¯”è¾ƒæŠ˜ä¸­çš„æ–¹æ¡ˆâ€”â€”ç”±æ–‡ä»¶å†…å®¹è®¡ç®— Why not just use all 0s for the timestamp? This is actually how the original implementation of determinism functioned in the compiler. Unfortunately it turned out there were a lot of tools we used in our internal process that validated the timestamp. They got a bit cranky when the discovered binaries claiming to be written in 1970, over 25 years before .NET was even invented. The practice of validating the time stamp is questionable but given tools were doing it there was a significant back compat risk. Hence we moved to the current computed value and havenâ€™t seen any issues since then. æ‰€ä»¥æˆ‘ä»¬å¾—åˆ°ä¸€ä¸ªå¥‡æ€ªçš„å€¼ä¹Ÿæ˜¯Work as expectedäº†ğŸ™ƒ è§£å†³åŠæ³•éå¸¸ç®€å•ï¼Œåœ¨.csprojä¸­å°†1&lt;deterministic&gt;true&lt;/deterministic&gt; æ”¹ä¸º1&lt;deterministic&gt;false&lt;/deterministic&gt; å³å¯ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒDeterministic Buildåœ¨.NET Coreä¸Šé»˜è®¤å¼€å¯ï¼Œè¦ä½¿PEå¤´éƒ¨çš„TimeDateStampæœ‰æ„ä¹‰éœ€è¦å°†å…¶å…³é—­ã€‚è€Œåœ¨.NET Frameworkä¸Šåˆ™æ˜¯åªæœ‰åœ¨VS2017çš„æŸä¸ªç‰¹å®šç‰ˆæœ¬åæ–°å»ºçš„å·¥ç¨‹æ‰ä¼šå¼€å¯ã€‚ é¢˜å¤–è¯ï¼Œè¿™ä¸ªé»˜è®¤å¼€å¯çš„Deterministic Buildè¿˜æå‡ºäº†å…¶ä»–å¹ºè›¾å­ï¼Œä¾‹å¦‚è¿™é‡Œ","categories":[],"tags":[{"name":"C#","slug":"C","permalink":"https://verrickt.github.io/tags/C/"}]},{"title":"ä½¿ç”¨MSBuildç¼–å†™æ„å»ºè„šæœ¬","slug":"build-script-with-msbuild","date":"2018-08-30T15:05:54.000Z","updated":"2018-09-01T08:17:17.105Z","comments":true,"path":"2018/08/30/build-script-with-msbuild/","link":"","permalink":"https://verrickt.github.io/2018/08/30/build-script-with-msbuild/","excerpt":"èƒŒæ™¯é¡¹ç›®éœ€æ±‚å˜æ›´ï¼Œéœ€è¦ä»ä¸€ä»½ä»£ç é‡Œç¼–è¯‘å‡ºå¥½å‡ ä¸ªä¸åŒçš„ç‰ˆæœ¬ã€‚ç¼–è¯‘å’Œéƒ¨ç½²çš„å¤æ‚åº¦éƒ½æˆæŒ‡æ•°å¢åŠ ï¼Œç®€å•çš„Releaseæ„å»ºæä¸å®šäº†ï¼Œå†™æ„å»ºè„šæœ¬è¿«åœ¨çœ‰ç«ã€‚","text":"èƒŒæ™¯é¡¹ç›®éœ€æ±‚å˜æ›´ï¼Œéœ€è¦ä»ä¸€ä»½ä»£ç é‡Œç¼–è¯‘å‡ºå¥½å‡ ä¸ªä¸åŒçš„ç‰ˆæœ¬ã€‚ç¼–è¯‘å’Œéƒ¨ç½²çš„å¤æ‚åº¦éƒ½æˆæŒ‡æ•°å¢åŠ ï¼Œç®€å•çš„Releaseæ„å»ºæä¸å®šäº†ï¼Œå†™æ„å»ºè„šæœ¬è¿«åœ¨çœ‰ç«ã€‚ å¤§è‡´ä»‹ç»ä¸‹é¡¹ç›®çš„ç»„æˆå§ã€‚æ•´ä¸ªé¡¹ç›®ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š Installer.vcxproj Main.csproj Updater.csproj Mainæ˜¯é¡¹ç›®æœ¬ä½“ã€‚Installerè´Ÿè´£é¡¹ç›®çš„å®‰è£…å’Œå¸è½½,Updaterè´Ÿè´£é¡¹ç›®çš„æ›´æ–°ã€‚è§£å†³æ–¹æ¡ˆé‡Œé™¤Installerä½¿ä¸ºC++å¤–ï¼Œå…¶ä½™å‡ä¸ºC#ã€‚ è§£å†³æ–¹æ¡ˆçš„ç»“æ„å¦‚ä¸‹ï¼š1234MyProject.sln- Installer.vcxproj - Main.csproj- Updater.csproj ç°åœ¨éœ€è¦ä»MyProject.slnæ¡ä»¶ç¼–è¯‘å‡ºå¤šä¸ªç‰ˆæœ¬ï¼Œè¦æ±‚ å¯¹äºæ¯ä¸ªç‰ˆæœ¬ï¼ŒInstallerå’ŒMainé¡»é‡æ–°ç¼–è¯‘ æ‰€æœ‰ç‰ˆæœ¬å…±äº«åŒä¸€ä»½Updaterçš„äºŒè¿›åˆ¶ã€‚ Roslynä¸MSBuildæ„å»ºçš„è¿‡ç¨‹è‡ªç„¶ç¦»ä¸å¼€ç¼–è¯‘ã€‚ç¼–è¯‘å™¨è™½è½¯èƒ½å°†ä»£ç è½¬åŒ–ä¸ºäºŒè¿›åˆ¶ï¼Œä½†è¿™ä¸ªè½¬æ¢çš„å•ä½æ˜¯æ–‡ä»¶:12gcc --helpUsage: gcc [options] file... ä½œä¸º.NETçš„ç¼–è¯‘å™¨ï¼ŒRoslynä¹Ÿä¸ä¾‹å¤–:123456789101112131415161718192021csc /?......... - INPUT FILES - /recurse:&lt;wildcard&gt; Include all files in the current directory and subdirectories according to the wildcard specifications /reference:&lt;alias&gt;=&lt;file&gt; Reference metadata from the specified assembly file using the given alias (Short form: /r) /reference:&lt;file list&gt; Reference metadata from the specified assembly files (Short form: /r) /addmodule:&lt;file list&gt; Link the specified modules into this assembly /link:&lt;file list&gt; Embed metadata from the specified interop assembly files (Short form: /l) /analyzer:&lt;file list&gt; Run the analyzers from this assembly (Short form: /a) /additionalfile:&lt;file list&gt; Additional files that don&apos;t directly affect code generation but may be used by analyzers for producing errors or warnings. /embed Embed all source files in the PDB. /embed:&lt;file list&gt; Embed specific files in the PDB æˆ‘ä»¬ä¸ä¼šæŠŠæ‰€æœ‰æºæ–‡ä»¶çš„è·¯å¾„ã€æ‰€æœ‰å¼•ç”¨çš„ç¨‹åºé›†çš„éƒ½å‘Šè¯‰ç¼–è¯‘å™¨ï¼Œè¿™æ ·æ—¢ä½æ•ˆåˆä¸åˆ©äºç»´æŠ¤ã€‚æœ€å¥½æœ‰ä¸ªèƒ½æœ‰ä¸ªç¨‹åºï¼Œèƒ½æŠŠæ‰€æœ‰ç¼–è¯‘çš„å‚æ•°éƒ½è®°ä¸‹æ¥ã€‚è¿™ä¸ªè¿‡ç¨‹æœ€å¥½èƒ½è‡ªåŠ¨åŒ–ï¼šåœ¨æ–‡ä»¶å¤¹é‡Œæ·»åŠ ä¸€ä¸ªæºæ–‡ä»¶ã€æ–°å¢ä¸€ä¸ªå¼•ç”¨é¡¹ï¼Œå®ƒéƒ½è‡ªåŠ¨çš„æ›´æ–°ç¼–è¯‘å‚æ•°ã€‚å­˜åœ¨è¿™æ ·çš„å·¥å…·å—ï¼Ÿå½“ç„¶äº†ã€‚åœ¨Visual Studioé‡Œæ·»åŠ ä¸€ä¸ªæ–‡ä»¶æ˜¯ä¸éœ€è¦åŠ¨ç¼–è¯‘é€‰é¡¹çš„ã€‚æœ‰å¿ƒçš„äººä¼šå‘ç°ï¼ŒVisual Studioåœ¨.csprojè®°å½•äº†æ–°å¢çš„æ–‡ä»¶ã€‚.csprojæ˜¯é¡¹ç›®æ–‡ä»¶ã€‚ä¸€ä¸ªå«MSBuildçš„å·¥å…·å¯ä»¥è§£æ.csprojï¼Œå¹¶ç”Ÿæˆå¯¹åº”çš„ç¼–è¯‘é€‰é¡¹è°ƒç”¨ç¼–è¯‘å™¨ã€‚è¿™æ ·çš„å·¥å…·ç§°ä¸ºæ„å»ºè‡ªåŠ¨åŒ–å·¥å…·ã€‚ç”¨å¾®è½¯è‡ªå·±çš„è¯è¯´ï¼Œæ˜¯æ„å»ºå¼•æ“ã€‚å¤§å‹è½¯ä»¶çš„å¼€å‘ç¦»ä¸å¼€æ„å»ºå¼•æ“ã€‚ä¸MSBuildåŒç±»çš„å·¥å…·è¿˜æœ‰æœ‰å¾ˆå¤šå¸¸è§çš„æœ‰make,mavenç­‰ã€‚ ç›¸æ¯”äºRoslynï¼ŒMSBuildçš„ä½¿ç”¨å°±ç®€å•å¤šäº†ï¼Œåªéœ€è¦æŒ‡å®šé¡¹ç›®æ–‡ä»¶å°±ä¸‡äº‹å¤§å‰äº†ã€‚ä¸‹é¢æ˜¯åœ¨ä¸€ä¸ªæ–°å»ºWPFé¡¹ç›®ä¸‹è°ƒç”¨MSbuildçš„è¾“å‡ºã€‚123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101C:\\Users\\Von\\source\\repos\\WpfApp1&gt;msbuild WpfApp1.slnMicrosoft (R) Build Engine version 15.7.180.61344 for .NET FrameworkCopyright (C) Microsoft Corporation. All rights reserved.Building the projects in this solution one at a time. To enable parallel build, please add the \"/m\" switch.Build started 9/1/2018 2:08:01 PM.Project \"C:\\Users\\Von\\source\\repos\\WpfApp1\\WpfApp1.sln\" on node 1 (default targets).ValidateSolutionConfiguration: Building solution configuration \"Debug|Any CPU\".Project \"C:\\Users\\Von\\source\\repos\\WpfApp1\\WpfApp1.sln\" (1) is building \"C:\\Users\\Von\\source\\repos\\WpfApp1\\WpfApp1\\WpfApp1.csproj\" (2) on node 1 (default targets).GenerateBindingRedirects: No suggested binding redirects from ResolveAssemblyReferences.Project \"C:\\Users\\Von\\source\\repos\\WpfApp1\\WpfApp1\\WpfApp1.csproj\" (2) is building \"C:\\Users\\Von\\source\\repos\\WpfApp1\\WpfApp1\\WpfApp1_r1lsxnqk_wpftmp.csproj\" (3) on node 1 (_CompileTemporaryAssembly target(s)).CoreCompile: C:\\Program Files (x86)\\Microsoft Visual Studio\\2017\\Community\\MSBuild\\15.0\\bin\\Roslyn\\csc.exe /noconfig /nowarn:1701, 1702 /nostdlib+ /platform:anycpu32bitpreferred /errorreport:prompt /warn:4 /define:DEBUG;TRACE /highentropyva+ /refer ence:\"C:\\Program Files (x86)\\Reference Assemblies\\Microsoft\\Framework\\.NETFramework\\v4.7.1\\Microsoft.CSharp.dll\" /ref erence:\"C:\\Program Files (x86)\\Reference Assemblies\\Microsoft\\Framework\\.NETFramework\\v4.7.1\\mscorlib.dll\" /reference :\"C:\\Program Files (x86)\\Reference Assemblies\\Microsoft\\Framework\\.NETFramework\\v4.7.1\\PresentationCore.dll\" /referen ce:\"C:\\Program Files (x86)\\Reference Assemblies\\Microsoft\\Framework\\.NETFramework\\v4.7.1\\PresentationFramework.dll\" / reference:\"C:\\Program Files (x86)\\Reference Assemblies\\Microsoft\\Framework\\.NETFramework\\v4.7.1\\System.Core.dll\" /ref erence:\"C:\\Program Files (x86)\\Reference Assemblies\\Microsoft\\Framework\\.NETFramework\\v4.7.1\\System.Data.DataSetExten sions.dll\" /reference:\"C:\\Program Files (x86)\\Reference Assemblies\\Microsoft\\Framework\\.NETFramework\\v4.7.1\\System.Da ta.dll\" /reference:\"C:\\Program Files (x86)\\Reference Assemblies\\Microsoft\\Framework\\.NETFramework\\v4.7.1\\System.dll\" /reference:\"C:\\Program Files (x86)\\Reference Assemblies\\Microsoft\\Framework\\.NETFramework\\v4.7.1\\System.Net.Http.dll\" /reference:\"C:\\Program Files (x86)\\Reference Assemblies\\Microsoft\\Framework\\.NETFramework\\v4.7.1\\System.Xaml.dll\" /r eference:\"C:\\Program Files (x86)\\Reference Assemblies\\Microsoft\\Framework\\.NETFramework\\v4.7.1\\System.Xml.dll\" /refer ence:\"C:\\Program Files (x86)\\Reference Assemblies\\Microsoft\\Framework\\.NETFramework\\v4.7.1\\System.Xml.Linq.dll\" /refe rence:\"C:\\Program Files (x86)\\Reference Assemblies\\Microsoft\\Framework\\.NETFramework\\v4.7.1\\WindowsBase.dll\" /debug+ /debug:full /filealign:512 /optimize- /out:obj\\Debug\\WpfApp1.exe /ruleset:\"C:\\Program Files (x86)\\Microsoft Visual St udio\\2017\\Community\\Team Tools\\Static Analysis Tools\\\\Rule Sets\\MinimumRecommendedRules.ruleset\" /subsystemversion:6. 00 /target:winexe /utf8output App.xaml.cs MainWindow.xaml.cs Properties\\AssemblyInfo.cs Properties\\Resources.Designer .cs Properties\\Settings.Designer.cs C:\\Users\\Von\\source\\repos\\WpfApp1\\WpfApp1\\obj\\Debug\\MainWindow.g.cs C:\\Users\\Von\\ source\\repos\\WpfApp1\\WpfApp1\\obj\\Debug\\App.g.cs Using shared compilation with compiler from directory: C:\\Program Files (x86)\\Microsoft Visual Studio\\2017\\Community\\ MSBuild\\15.0\\bin\\RoslynDone Building Project \"C:\\Users\\Von\\source\\repos\\WpfApp1\\WpfApp1\\WpfApp1_r1lsxnqk_wpftmp.csproj\" (_CompileTemporaryAssembly target(s)).MarkupCompilePass2: MarkupCompilePass2 successfully generated BAML or source code files.CleanupTemporaryTargetAssembly: Deleting file \"obj\\Debug\\WpfApp1.exe\".CoreResGen: \"C:\\Program Files (x86)\\Microsoft SDKs\\Windows\\v10.0A\\bin\\NETFX 4.6.1 Tools\\resgen.exe\" /useSourcePath /r:\"C:\\Program Files (x86)\\Reference Assemblies\\Microsoft\\Framework\\.NETFramework\\v4.7.1\\Microsoft.CSharp.dll\" /r:\"C:\\Program Files (x86)\\Reference Assemblies\\Microsoft\\Framework\\.NETFramework\\v4.7.1\\mscorlib.dll\" /r:\"C:\\Program Files (x86)\\Referen ce Assemblies\\Microsoft\\Framework\\.NETFramework\\v4.7.1\\PresentationCore.dll\" /r:\"C:\\Program Files (x86)\\Reference Ass emblies\\Microsoft\\Framework\\.NETFramework\\v4.7.1\\PresentationFramework.dll\" /r:\"C:\\Program Files (x86)\\Reference Asse mblies\\Microsoft\\Framework\\.NETFramework\\v4.7.1\\System.Core.dll\" /r:\"C:\\Program Files (x86)\\Reference Assemblies\\Micr osoft\\Framework\\.NETFramework\\v4.7.1\\System.Data.DataSetExtensions.dll\" /r:\"C:\\Program Files (x86)\\Reference Assembli es\\Microsoft\\Framework\\.NETFramework\\v4.7.1\\System.Data.dll\" /r:\"C:\\Program Files (x86)\\Reference Assemblies\\Microsof t\\Framework\\.NETFramework\\v4.7.1\\System.dll\" /r:\"C:\\Program Files (x86)\\Reference Assemblies\\Microsoft\\Framework\\.NET Framework\\v4.7.1\\System.Net.Http.dll\" /r:\"C:\\Program Files (x86)\\Reference Assemblies\\Microsoft\\Framework\\.NETFramewo rk\\v4.7.1\\System.Xaml.dll\" /r:\"C:\\Program Files (x86)\\Reference Assemblies\\Microsoft\\Framework\\.NETFramework\\v4.7.1\\S ystem.Xml.dll\" /r:\"C:\\Program Files (x86)\\Reference Assemblies\\Microsoft\\Framework\\.NETFramework\\v4.7.1\\System.Xml.Li nq.dll\" /r:\"C:\\Program Files (x86)\\Reference Assemblies\\Microsoft\\Framework\\.NETFramework\\v4.7.1\\WindowsBase.dll\" /co mpile Properties\\Resources.resx,obj\\Debug\\WpfApp1.Properties.Resources.resources Processing resource file \"Properties\\Resources.resx\" into \"obj\\Debug\\WpfApp1.Properties.Resources.resources\".CoreCompile: C:\\Program Files (x86)\\Microsoft Visual Studio\\2017\\Community\\MSBuild\\15.0\\bin\\Roslyn\\csc.exe /noconfig /nowarn:1701, 1702 /nostdlib+ /platform:anycpu32bitpreferred /errorreport:prompt /warn:4 /define:DEBUG;TRACE /highentropyva+ /refer ence:\"C:\\Program Files (x86)\\Reference Assemblies\\Microsoft\\Framework\\.NETFramework\\v4.7.1\\Microsoft.CSharp.dll\" /ref erence:\"C:\\Program Files (x86)\\Reference Assemblies\\Microsoft\\Framework\\.NETFramework\\v4.7.1\\mscorlib.dll\" /reference :\"C:\\Program Files (x86)\\Reference Assemblies\\Microsoft\\Framework\\.NETFramework\\v4.7.1\\PresentationCore.dll\" /referen ce:\"C:\\Program Files (x86)\\Reference Assemblies\\Microsoft\\Framework\\.NETFramework\\v4.7.1\\PresentationFramework.dll\" / reference:\"C:\\Program Files (x86)\\Reference Assemblies\\Microsoft\\Framework\\.NETFramework\\v4.7.1\\System.Core.dll\" /ref erence:\"C:\\Program Files (x86)\\Reference Assemblies\\Microsoft\\Framework\\.NETFramework\\v4.7.1\\System.Data.DataSetExten sions.dll\" /reference:\"C:\\Program Files (x86)\\Reference Assemblies\\Microsoft\\Framework\\.NETFramework\\v4.7.1\\System.Da ta.dll\" /reference:\"C:\\Program Files (x86)\\Reference Assemblies\\Microsoft\\Framework\\.NETFramework\\v4.7.1\\System.dll\" /reference:\"C:\\Program Files (x86)\\Reference Assemblies\\Microsoft\\Framework\\.NETFramework\\v4.7.1\\System.Net.Http.dll\" /reference:\"C:\\Program Files (x86)\\Reference Assemblies\\Microsoft\\Framework\\.NETFramework\\v4.7.1\\System.Xaml.dll\" /r eference:\"C:\\Program Files (x86)\\Reference Assemblies\\Microsoft\\Framework\\.NETFramework\\v4.7.1\\System.Xml.dll\" /refer ence:\"C:\\Program Files (x86)\\Reference Assemblies\\Microsoft\\Framework\\.NETFramework\\v4.7.1\\System.Xml.Linq.dll\" /refe rence:\"C:\\Program Files (x86)\\Reference Assemblies\\Microsoft\\Framework\\.NETFramework\\v4.7.1\\WindowsBase.dll\" /debug+ /debug:full /filealign:512 /optimize- /out:obj\\Debug\\WpfApp1.exe /ruleset:\"C:\\Program Files (x86)\\Microsoft Visual St udio\\2017\\Community\\Team Tools\\Static Analysis Tools\\\\Rule Sets\\MinimumRecommendedRules.ruleset\" /subsystemversion:6. 00 /resource:obj\\Debug\\WpfApp1.g.resources /resource:obj\\Debug\\WpfApp1.Properties.Resources.resources /target:winexe /utf8output App.xaml.cs MainWindow.xaml.cs Properties\\AssemblyInfo.cs Properties\\Resources.Designer.cs Properties\\Set tings.Designer.cs C:\\Users\\Von\\source\\repos\\WpfApp1\\WpfApp1\\obj\\Debug\\MainWindow.g.cs C:\\Users\\Von\\source\\repos\\WpfAp p1\\WpfApp1\\obj\\Debug\\App.g.cs \"C:\\Users\\Von\\AppData\\Local\\Temp\\.NETFramework,Version=v4.7.1.AssemblyAttributes.cs\" Using shared compilation with compiler from directory: C:\\Program Files (x86)\\Microsoft Visual Studio\\2017\\Community\\ MSBuild\\15.0\\bin\\Roslyn_CopyAppConfigFile: Copying file from \"App.config\" to \"bin\\Debug\\WpfApp1.exe.config\".CopyFilesToOutputDirectory: Copying file from \"obj\\Debug\\WpfApp1.exe\" to \"bin\\Debug\\WpfApp1.exe\". WpfApp1 -&gt; C:\\Users\\Von\\source\\repos\\WpfApp1\\WpfApp1\\bin\\Debug\\WpfApp1.exe Copying file from \"obj\\Debug\\WpfApp1.pdb\" to \"bin\\Debug\\WpfApp1.pdb\".Done Building Project \"C:\\Users\\Von\\source\\repos\\WpfApp1\\WpfApp1\\WpfApp1.csproj\" (default targets).Done Building Project \"C:\\Users\\Von\\source\\repos\\WpfApp1\\WpfApp1.sln\" (default targets).Build succeeded. 0 Warning(s) 0 Error(s)Time Elapsed 00:00:02.60 çœ‹çœ‹CoreCompileé‡Œä¼ ç»™Roslynçš„å‚æ•°ã€‚è‡ªå·±è°ƒç”¨Roslynçš„è¯å…‰ç»™å‡ºæ­£ç¡®çš„å‚æ•°å°±è®©äººå¤´ç—›äº†ã€‚æ‰€ä»¥è¿˜æ˜¯ç›´æ¥è°ƒç”¨MSBuildå¥½äº†ã€‚å•å•è°ƒç”¨ä¸€æ¬¡MSBuildæ— æ³•å®Œæˆæˆ‘ä»¬çš„éœ€æ±‚ï¼Œå› æ­¤æ„å»ºè„šæœ¬æ˜¯å°‘ä¸äº†çš„äº†ã€‚ æ‰¾åˆ°MSBuildé¦–å…ˆåœ¨`Developer command prompt for VS 2017æ‰¾åˆ°MSbuiidçš„å®Œå…¨è·¯å¾„:123$ where msbuild&gt; C:\\Program Files (x86)\\Microsoft Visual Studio\\2017\\Community\\MSBuild\\15.0\\Bin\\MSBuild.exe&gt; C:\\Windows\\Microsoft.NET\\Framework\\v4.0.30319\\MSBuild.exe è¿™é‡Œéœ€è¦çš„æ˜¯Visual Studioç›®å½•ä¸‹çš„é‚£ä¸€ä¸ªã€‚ MSBuildçš„å‘½ä»¤è¡Œé€‰é¡¹ /t:Rebuildå¼ºåˆ¶é‡æ–°ç¼–è¯‘ã€‚ /p:Configuration=RELEASEä»¥Releaseé…ç½®ç¼–è¯‘ã€‚ä¼šå¼€å¯ä¼˜åŒ–ã€‚ /p:DefineConstants=&quot;Value1,Value2,...&quot;å®šä¹‰æ¡ä»¶ç¼–è¯‘å¸¸é‡ã€‚ /p:Platform= æŒ‡å®šç›®æ ‡æ¶æ„ã€‚x86,x64å’ŒAnyCpuä¸‰é€‰ä¸€ã€‚ /p:OutputPathè¾“å‡ºç›®å½•ã€‚å¯æ¥å—ç»å¯¹å’Œç›¸å¯¹è·¯å¾„ã€‚ å„ä¸ªå‚æ•°ä¸­é—´ç”¨ç©ºæ ¼åˆ†å¼€ã€‚ ä¸€ä¸ªä¾‹å­1msbuild WpfApp1.csproj /t:Rebuild /p:Configuration=RELEASE /p:DefineConstants=&quot;TRACE,DEMO&quot; /p:Platform=&quot;x86&quot; /p:OutputPath=&quot;F:\\Release&quot; /p:TargetFrameworkVersion=4.7.1 /tv:15.0 æ›´å¤šå‚æ•°è¯·å‚é˜…è¿™é‡Œ èƒ½é…å¥½å‚æ•°è°ƒç”¨MSBuildæ˜¯æ„å»ºè„šæœ¬ä¸­æœ€é‡è¦çš„ä¸€æ­¥ã€‚è‡³äºéœ€æ±‚é‡Œçš„å…¶ä»–è¦æ±‚æ²¡ä»€ä¹ˆéš¾åº¦ï¼Œæ— éç”¨åˆé€‚çš„æ§åˆ¶æµå»è°ƒç”¨MSBuildã€‚è¿™é‡Œå°±ç•¥è¿‡äº†ã€‚ è¸©å‘éƒ¨åˆ†å‚æ•°æ— æ•ˆå¦‚æœä½ å‘ç°ä½ è®¾ç½®çš„éƒ¨åˆ†å‚æ•°æ— æ•ˆï¼Œé‚£å¯èƒ½æ˜¯è¢«å› ä¸ºé¡¹ç›®æ–‡ä»¶çš„å‚æ•°è¦†ç›–æ‰äº†ã€‚ä¸ºäº†å°‘æ‰å‘ï¼Œè¯·å°†é¡¹ç›®æ–‡ä»¶çš„è·¯å¾„æ”¾ä½œä¸ºç»™MSBuildçš„ç¬¬ä¸€ä¸ªå‚æ•°ã€‚ C++å·¥ç¨‹æŒ‡å®šè¾“å‡ºç›®å½•æ— æ•ˆé…å¥½/p:PlatformåMSbuildä¼šæç¤ºä½ ç”¨/p:OutputPathæŒ‡å®šè¾“å‡ºè·¯å¾„ã€‚å¦‚æœä½ ç”¨äº†OutputPathï¼Œé‚£ä¹ˆæ­å–œä½ æ‰è¿›äº†å¾®è½¯æŒ–çš„æš—å‘ï¼šOutputPathå¯¹C++é¡¹ç›®æ— æ•ˆã€‚è§£å†³æ–¹æ³•ï¼šè¯·ä½¿ç”¨ä½¿ç”¨/p:OutputDiræŒ‡å®šè¾“å‡ºç›®å½•åŸå› ï¼š To expand on what @AndyGerlicher said, we canâ€™t do what youâ€™re asking because we too have lost the reasoning behind this decision. The current team thinks it looks pretty broken. From comments in the targets OutDir and OutputPath are distinguished for legacy reasons, and OutDir should be used if at all possible. It seems like we got stuck in the middle of a transition. However, as youâ€™ve discovered, thereâ€™s a ton of MSBuild code out there that exploits the differences between the two variables. That keeps us from completing the transition (or for that matter backing it out), because it would cause a lot of churn in customer projects. æ›´å¤šè¯¦æƒ…è¯·å‚é˜…è¿™é‡Œ C++å·¥ç¨‹DefineConstantsæ— æ•ˆå–œé—»ä¹è§çš„legacy reasons æ¯”è¾ƒç®€å•çš„ä¸€ä¸ªworkaround åœ¨.vcxprojçš„Labelä¸ºGlobalçš„PropertyGroupä¸­åŠ ä¸Š&lt;DefineConstants&gt;&lt;/DefineConstants&gt; åœ¨æ‰€æœ‰çš„PreprocessorDefinitionså†…å®¹çš„å¼€å¤´æ·»åŠ $(DefineConstants); æœ€ç»ˆç»“æœå¦‚ä¸‹ 12345678910111213141516&lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;&lt;Project DefaultTargets=\"Build\" ToolsVersion=\"14.0\" xmlns=\"http://schemas.microsoft.com/developer/msbuild/2003\"&gt; ..... &lt;PropertyGroup Label=\"Global\"&gt; &lt;DefineConstants&gt;&lt;/DefineConstants&gt; &lt;/PropertyGroup&gt; ...... &lt;ItemDefinitionGroup&gt; &lt;ClCompile&gt; .... &lt;PreprocessorDefinitions&gt;$(DefineConstants);NDEBUG;WIN32;_WINDOWS;NO_EXP10;_CRT_SECURE_NO_WARNINGS;%(PreprocessorDefinitions);&lt;/PreprocessorDefinitions&gt; .... &lt;/ClCompile&gt; &lt;/ItemDefinitionGroup&gt;&lt;/Project&gt; æ›´å¤šè¯¦æƒ…è¯·å‚é˜…è¿™é‡Œ å¯¹PowerShellçš„åæ§½æœ¬ä»¥ä¸ºåŸºäº.NETå¯¹è±¡çš„PowerShellæŒºå¥½ä¸Šæ‰‹çš„ã€‚æ²¡æƒ³åˆ°ç”±JSONååºåˆ—åŒ–å‡ºæ¥çš„å¯¹è±¡æ˜¯PSObjectç±»å‹ï¼ŒåŸæ¥ç±»é‡Œçš„æ–¹æ³•éƒ½ç”¨ä¸äº†äº†ï¼Œæƒ³æŠŠPSObjectè½¬æ¢å›å»ä¹Ÿååˆ†éº»çƒ¦ã€‚å¯èƒ½Shellå¤©ç”Ÿè·ŸOOPåˆä¸æ¥å§ã€‚æœ€åç”¨C#å†™äº†æ„å»ºè„šæœ¬ã€‚C#ï¼Œè„šæœ¬ï¼Œæ˜¯ä¸æ˜¯å“ªé‡Œä¸å¤ªå¯¹å•ŠğŸ¤”","categories":[],"tags":[{"name":"MSBuild","slug":"MSBuild","permalink":"https://verrickt.github.io/tags/MSBuild/"}]},{"title":"Build a (partial) self-contained WPF application","slug":"self-contained-wpf-application","date":"2018-07-31T14:43:47.000Z","updated":"2018-08-03T03:14:31.174Z","comments":true,"path":"2018/07/31/self-contained-wpf-application/","link":"","permalink":"https://verrickt.github.io/2018/07/31/self-contained-wpf-application/","excerpt":"å·¨äººçš„è‚©è†€æ–°äº‹ç‰©çš„äº§ç”Ÿæ€»æ˜¯ä¸è€äº‹ç‰©æœ‰åƒä¸ä¸‡ç¼•çš„è”ç³»ã€‚æˆ–æ˜¯ä»ä¸­å¾—åˆ°å¯å‘ï¼Œæˆ–æ˜¯å¯¹å…¶å…¨é¢æ”¹è‰¯ã€‚æ–°äº‹ç‰©çš„æºå¤´é€šå¸¸å¯ä»¥è¿½æº¯åˆ°å¾ˆä¹…è¿œçš„ä¸€äº›æ¦‚å¿µä¸Šã€‚å› æ­¤æœ‰äº†ã€Œç«™åœ¨å·¨äººçš„è‚©è†€ä¸Šã€ è¿™æ ·çš„è¯´æ³•ã€‚åœ¨ç¨‹åºè®¾è®¡é‡Œé¢ï¼Œã€Œå·¨äººä»¬çš„è‚©è†€ã€ å°±æ˜¯æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä½¿ç”¨çš„åº“äº†ã€‚è¸©åœ¨è¿™äº›ã€Œå·¨äººã€ä»¬çš„è‚©è†€ä¸Šæˆ‘ä»¬çš„ç¨‹åºæ‰å¾—ä»¥é‡è§å¤©æ—¥ï¼›ä¸ºäº†å®ç°ä¸€ä¸ªåº“ï¼Œæœ‰æ—¶å€™ä¼šä½¿ç”¨åˆ°å…¶ä»–çš„åº“ã€‚æˆ‘ä»¬æ‰€ä¾èµ–çš„ã€Œå·¨äººã€åˆè¸©åœ¨äº†å…¶ä»–ã€Œå·¨äººã€çš„è‚©è†€ä¸Šï¼ŒæŠŠä¾èµ–å…³ç³»å˜æˆäº†æ ‘çŠ¶ç»“æ„ï¼Œæˆ‘ä»¬çš„ç¨‹åºå¤„åœ¨æ ¹èŠ‚ç‚¹ã€‚ æ‰¯è¿œäº†:)","text":"å·¨äººçš„è‚©è†€æ–°äº‹ç‰©çš„äº§ç”Ÿæ€»æ˜¯ä¸è€äº‹ç‰©æœ‰åƒä¸ä¸‡ç¼•çš„è”ç³»ã€‚æˆ–æ˜¯ä»ä¸­å¾—åˆ°å¯å‘ï¼Œæˆ–æ˜¯å¯¹å…¶å…¨é¢æ”¹è‰¯ã€‚æ–°äº‹ç‰©çš„æºå¤´é€šå¸¸å¯ä»¥è¿½æº¯åˆ°å¾ˆä¹…è¿œçš„ä¸€äº›æ¦‚å¿µä¸Šã€‚å› æ­¤æœ‰äº†ã€Œç«™åœ¨å·¨äººçš„è‚©è†€ä¸Šã€ è¿™æ ·çš„è¯´æ³•ã€‚åœ¨ç¨‹åºè®¾è®¡é‡Œé¢ï¼Œã€Œå·¨äººä»¬çš„è‚©è†€ã€ å°±æ˜¯æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä½¿ç”¨çš„åº“äº†ã€‚è¸©åœ¨è¿™äº›ã€Œå·¨äººã€ä»¬çš„è‚©è†€ä¸Šæˆ‘ä»¬çš„ç¨‹åºæ‰å¾—ä»¥é‡è§å¤©æ—¥ï¼›ä¸ºäº†å®ç°ä¸€ä¸ªåº“ï¼Œæœ‰æ—¶å€™ä¼šä½¿ç”¨åˆ°å…¶ä»–çš„åº“ã€‚æˆ‘ä»¬æ‰€ä¾èµ–çš„ã€Œå·¨äººã€åˆè¸©åœ¨äº†å…¶ä»–ã€Œå·¨äººã€çš„è‚©è†€ä¸Šï¼ŒæŠŠä¾èµ–å…³ç³»å˜æˆäº†æ ‘çŠ¶ç»“æ„ï¼Œæˆ‘ä»¬çš„ç¨‹åºå¤„åœ¨æ ¹èŠ‚ç‚¹ã€‚ æ‰¯è¿œäº†:) å¼€å‘çš„æ—¶å€™æœ‰åŒ…ç®¡ç†å·¥å…·å¸®æˆ‘ä»¬ç®¡ç†ä¾èµ–ï¼Œè€Œåˆ°äº†åˆ†å‘çš„æ—¶å€™ï¼Œéœ€è¦ä¸€ä¸ªå®¹å™¨æŠŠæˆ‘ä»¬çš„ç¨‹åºå’Œå®ƒçš„ä¾èµ–é¡¹ä¸€èµ·åˆ†å‘ã€‚è¿™å°±éœ€è¦ç”¨åˆ°å®‰è£…ç¨‹åºã€‚æœ€ç»ˆç”¨æˆ·åªè¦æ‹¿åˆ°å®‰è£…ç¨‹åºï¼Œè¿è¡Œå®‰è£…ï¼Œç”±å®‰è£…ç¨‹åºå»æ“å¿ƒä¾èµ–é¡¹åˆ°åº•åº”è¯¥æ”¾åœ¨å“ªã€‚ äººæ˜¯æ‡’æƒ°çš„åŠ¨ç‰©ï¼Œä»ç”¨æˆ·å‘ç°è½¯ä»¶åˆ°çœŸæ­£ç”¨ä¸Šè½¯ä»¶ä¹‹é—´ï¼Œæ¯å¤šä¸€ä¸ªæ­¥éª¤éƒ½ä¼šè®©æŸå¤±ä¸€æ‰¹æ½œåœ¨ç”¨æˆ·ã€‚è€Œç°åœ¨éšç€æ‰‹æœºçš„æµè¡Œï¼Œç”¨æˆ·å·²ç»ä¸æƒ³å®‰è£…äº†ã€‚ä»–ä»¬åªæƒ³ä¸‹è½½ã€Œè½¯ä»¶ã€ï¼ŒåŒå‡»å°±èƒ½ç›´æ¥è¿è¡Œã€‚è‡³äºä»€ä¹ˆå®‰è£…è·¯å¾„ï¼ŒUACæƒé™ä¹‹ç±»çš„ç”¨æˆ·æ‰ä¸æƒ³æ“å¿ƒå‘¢ã€‚ è¿™å°±è¦æ±‚æˆ‘ä»¬çš„ç¨‹åºè¦å°†å®‰è£…è¿™ä¸ªè¿‡ç¨‹éšè—èµ·æ¥ã€‚åœ¨ç”¨æˆ·çœ‹ä¸åˆ°çš„æƒ…å†µä¸‹éƒ¨ç½²è‡ªå·±çš„ä¾èµ–é¡¹ã€‚è¿™æ ·çš„ç¨‹åºåœ¨è‹±æ–‡é‡Œè¢«ç§°ä¸º self-contained self-containedadjective (of a thing) complete, or having all that is needed, in itself. (of a person) quiet and independent; not depending on or influenced by others. è¿™å‡ å¤©æˆ‘ä»¬ä¹Ÿæœ‰äº†å°†æœ€ç»ˆç¨‹åºself-containåŒ–çš„éœ€æ±‚ã€‚ç»ˆäºå¯ä»¥åˆç†çš„æŠ›å¼ƒMFCå†™çš„Installeräº†ğŸ˜ Self-contained in .NET.NETåœ¨è®¾è®¡ä¹‹åˆåªæ˜¯æƒ³æé«˜Windowsç¨‹åºå‘˜çš„å¼€å‘æ•ˆç‡ï¼Œé¡ºä¾¿è§£å†³ä¸€ä¸‹DLL Hellã€‚è‡³äºåº”ç”¨åˆ†å‘æ ¹æœ¬å°±ä¸å†æ—¥ç¨‹ä¸Šã€‚å°±ç®—çœŸçš„è€ƒè™‘è¿‡ï¼Œä¹Ÿä¸€å®šä¼šé‡‡ç”¨åŠ¨æ€é“¾æ¥çš„æ–¹å¼ã€‚å› ä¸ºå½“æ—¶çš„ç¡¬ç›˜è¿˜æ˜¯å¾ˆè´µæ»´ã€‚ æ€»ä¹‹ï¼Œ.NETå°±è¿™æ ·å†³å®šé‡‡ç”¨åŠ¨æ€é“¾æ¥äº†ã€‚.NETé‡Œçš„å‡ ä¸ªåŸºæœ¬æ¦‚å¿µä¹Ÿéƒ½ä¸åŠ¨æ€é“¾æ¥è„±ä¸å¼€å…³ç³»ï¼š ç¨‹åºé›†)æ˜¯.NETä¸–ç•Œé‡Œæœ€å¸¸è§çš„åˆ†å‘å•å…ƒã€‚ç¨‹åºé›†æœ‰ç‹¬ç«‹çš„ç‰ˆæœ¬å·ã€‚åœ¨å¼•ç”¨å…¶ä»–ç¨‹åºé›†çš„æ—¶å€™ï¼Œéœ€è¦æ˜¾å¼æŒ‡æ˜å¯¹åº”çš„ç‰ˆæœ¬ã€‚è¿™æ ·ï¼Œç›¸åŒåå­—ä¸åŒç‰ˆæœ¬çš„ç¨‹åºé›†å°±å¯ä»¥è¢«åŒºåˆ«å¼€ï¼Œä»¥æ­¤ä¸ºåŸºç¡€å°±è§£å†³Dll hellçš„é—®é¢˜ã€‚CLRåœ¨è¿è¡Œçš„æ—¶å€™ä»¥ä¸€å¥—å¤æ‚çš„è§„åˆ™è¯•å›¾åŠ è½½ç¨‹åºçš„ä¾èµ–é¡¹ã€‚ çœ‹èµ·æ¥ä¼¼ä¹.NETä¸é™æ€é“¾æ¥æ— ç¼˜äº†ã€‚ä¸è¿‡ä¹Ÿæœ‰å¥½æ¶ˆæ¯ï¼Œåœ¨Build 2018å¼€å‘è€…å¤§ä¼šä¸Šï¼Œå¾®è½¯å®£å¸ƒç°æœ‰çš„æ¡Œé¢ç¨‹åºå¯ä»¥åœ¨æ˜å¹´æ¨å‡ºçš„.Net core 3ä¸Šé€‰æ‹©ä¸è¿è¡Œæ—¶é™æ€é“¾æ¥åœ¨ä¸€èµ·ï¼Œå°†æ•´ä¸ªç¨‹åºå˜ä¸ºå•ä¸€çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚ Side-by-side and App-local Deployment For cases where the maximum isolation is required, you can deploy .NET Core with your application. Weâ€™re working on new build tools that will bundle your app and .NET Core together as in a single executable, as a new option. Weâ€™ve had requests for deployment options like this for many years, but were never able to deliver those with the .NET Framework. The much more modular architecture used by .NET Core makes these flexible deployment options possible. .Net Core 3.0çš„æ¨å‡ºæ—¶é—´æ˜¯æ˜å¹´ï¼Œæˆ‘ä»¬æ˜¾ç„¶ä¸èƒ½ç­‰åˆ°é‚£ä¸ªæ—¶å€™ã€‚ä¸ºäº†å®ç°éœ€æ±‚ï¼Œå…ˆå‘æœç´¢å¼•æ“æ±‚åŠ©å§ã€‚ é™æ€é“¾æ¥é™æ€é“¾æ¥å°†ä¾èµ–é¡¹æ‰“åŒ…è¿›æˆ‘ä»¬çš„ç¨‹åºï¼Œç”Ÿæˆå•ä¸€çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚è¿™æ˜¯ä¸ªå¾ˆç›´è§‚çš„åˆ‡å…¥ç‚¹ã€‚ä»¥C# static linkä¸ºå…³é”®è¯ï¼Œå‘ç°æœ‰å‡ ä¸ªåŒç±»å‹çš„å·¥å…·ã€‚ä¾‹å¦‚ILMergeã€‚åœ¨.NETçš„ä¸–ç•Œä¸­ï¼Œæºä»£ç ç»è¿‡ç¼–è¯‘åäº§ç”Ÿçš„ç¨‹åºé›†é‡Œå­˜å‚¨çš„å¹¶ä¸æ˜¯æœºå™¨ä»£ç è€Œæ˜¯ä¸€ç§å«MSILçš„ä¸­é—´ä»£ç ã€‚ç¨‹åºé›†ç”±CLRåŠ è½½åè¢«JITå³æ—¶ç¼–è¯‘ä¸ºæœºå™¨ç ã€‚ ILMergeä¹‹ç±»çš„å·¥å…·å·¥ä½œåœ¨ILå±‚é¢ã€‚å®ƒä»¬å°†ä¸åŒç¨‹åºé›†çš„ILä»£ç ç²˜åˆèµ·æ¥ï¼Œç”Ÿæˆå•ä¸€çš„ç¨‹åºé›†ã€‚ å¬èµ·æ¥æ˜¯ä¸æ˜¯å¾ˆç¾å¥½ï¼Ÿå¦‚æœä½ å†™ä¸ªå°demoçš„è¯ä¼šå‘ç°ç¡®å®å¾ˆå¥½ç”¨ã€‚ä½†æ˜¯ILMergeæ— æ³•å¯¹WPFä¸­çš„XAMLèµ„æºè¿›è¡Œæ”¹å†™ã€‚ç¨‹åºæŒ‚åœ¨è¿è¡Œæ—¶ã€‚ å†…åµŒèµ„æº.NETä¸­çš„ç¨‹åºé›†æœ‰èµ„æºçš„æ¦‚å¿µã€‚ä»»ä½•æ–‡ä»¶éƒ½èƒ½ä»¥èµ„æºçš„å½¢å¼åµŒå…¥è¿›ç¨‹åºé›†ã€‚å¦ä¸€ä¸ªæ€è·¯æ˜¯æ˜¯æŠŠä¾èµ–é¡¹å½“ä½œèµ„æºåµŒè¿›æˆ‘ä»¬çš„ä¸»ç¨‹åºã€‚åªè¦èƒ½åœ¨è¿è¡Œæ—¶æŠŠå®ƒä»¬æš´éœ²ç»™CLRï¼Œå°±èƒ½å®ç°self-containã€‚å…ˆæ¥çœ‹çœ‹APIï¼š Assembly.GetManifestResourceStream(string name): 12//Loads the specified manifest resource from this assembly.public virtual System.IO.Stream GetManifestResourceStream (Type type, string name) AppDomain.Load(Byte[]): 12//Loads the Assembly with a common object file format (COFF) based image containing an emitted Assembly.public System.Reflection.Assembly Load (byte[] rawAssembly); AppDomain.AssemblyResolve 12//Occurs when the resolution of an assembly fails.public event ResolveEventHandler AssemblyResolve; æˆ‘ä»¬æŠŠä¾èµ–é¡¹åµŒå…¥åˆ°ç¨‹åºå†…éƒ¨åï¼ŒCLRæ‰¾ä¸åˆ°å¼•ç”¨çš„ç¨‹åºé›†çš„æ—¶å€™å°±ä¼šè§¦å‘AppDomain.AssemblyResolveäº‹ä»¶ã€‚æˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡Œæ‹¿åˆ°ä¾èµ–çš„AssemblyName,Assembly.GetManifestResourceStream(string name)å¾—åˆ°åŒ…å«ä¾èµ–é¡¹çš„çš„streamï¼ŒæŠŠstreamçš„å†…å®¹è¯»å‡ºæ¥æ”¾åˆ°byte[]é‡Œï¼Œè°ƒç”¨AppDomain.Load(Byte[])å°†ç¨‹åºé›†åŠ è½½ã€‚ å¤§è‡´è¿‡ç¨‹èµ°å¾—é€šï¼Œä¸è¿‡æœ‰ç‚¹éº»çƒ¦ã€‚hardcodeä¾èµ–çš„åå­—åï¼Œä»¥åæ·»åŠ æ–°ä¾èµ–é¡¹è¿˜è¦æ›´æ”¹hardcodeçš„åå­—ã€‚æ¯•ç«Ÿç¨‹åºå‘˜ä¹Ÿæ˜¯äººï¼Œä¹Ÿæƒ³å·æ‡’ã€‚è¿™äº›æ´»æœ€å¥½è‡ªåŠ¨åŒ–ã€‚è¦æ˜¯èƒ½å’ŒVSé‡Œçš„ç¼–è¯‘ç»“åˆèµ·æ¥å°±æ›´å¥½äº†ğŸ¤¤ ä½ åˆ«è¯´ï¼Œè¿˜çœŸæœ‰è¿™æ ·çš„å·¥å…·ã€‚Fodyå¯ä»¥å¯¹.NETç¨‹åºé›†åšå¤šç§æ“ä½œã€‚Costuraæ˜¯Fodyçš„ä¸€ä¸ªæ‰©å±•ï¼Œä¸“é—¨ç”¨æ¥å°†ä¾èµ–åµŒå…¥æˆèµ„æºã€‚Fodyä¸VSçš„å®Œç¾é›†æˆï¼Œç¼–è¯‘å®Œæˆåè‡ªåŠ¨å¼€å§‹æ“ä½œã€‚Nugetå®‰è£…å®ŒFodyå’ŒCosturaåï¼Œå¦‚æœè§£å†³æ–¹æ¡ˆæ ¹è·¯å¾„ä¸‹æ²¡æœ‰FodyWeavers.xmlåˆ™æ–°å»ºå®ƒã€‚æŠŠå†…å®¹æ›¿æ¢ä¸º 1234&lt;?xml version=\"1.0\" encoding=\"utf-8\" ?&gt;&lt;Weavers&gt; &lt;Costura/&gt;&lt;/Weavers&gt;` å°±å®Œäº‹äº†ã€‚å¤ªæ˜“ç”¨äº†ã€‚æˆ‘åšäº†æµ‹è¯•ï¼ŒWPFå’Œæ§åˆ¶å°åº”ç”¨éƒ½å¯ä»¥ã€‚çœ‹æ–‡æ¡£ï¼Œå®ƒè¿˜æ”¯æŒ.NET Coreã€‚ Dependencies of my dependencies, is not my dependenciesILMergeä¹Ÿå¥½ï¼ŒFodyä¹Ÿå¥½ï¼Œå®ƒä»¬è§£å†³çš„éƒ½æ˜¯åº”ç”¨ç¨‹åºæ‰€ä¾èµ–åº“çš„é—®é¢˜ã€‚è€Œæˆ‘ä»¬çš„ç¨‹åºä¹‹æ‰€ä»¥å«.NETç¨‹åºï¼Œæ˜¯å› ä¸ºå®ƒä¾èµ–.NET Frameworkã€‚å¦‚æœè¦åšåˆ°fully-self-containedçš„è¯ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æŠŠ.NET Frameworkä¹Ÿå¡è¿›å»ã€‚è¿™å°±æ„å‘³è¿™æˆ‘ä»¬éœ€è¦ä¸€ä¸ªä¸ä¾èµ–.NET Frameworkçš„ç¨‹åºæ¥é‡Šæ”¾.NET Frameworkå’Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºã€‚è¿™å…¶å®å°±æ˜¯é‡æ–°å‘æ˜å®‰è£…ç¨‹åºäº†ã€‚é€€ä¸€æ­¥è¯´ï¼Œå°±ç®—æˆ‘ä»¬çœŸçš„æŠŠ.NET Frameworkæ‰“åŒ…è¿›å»äº†ï¼Œå› ä¸º.NET Frameworkçš„å®‰è£…è¿‡ç¨‹æ¯”è¾ƒè€—æ—¶ï¼Œç”¨æˆ·åœ¨ç‚¹äº†æŒ‰é’®åå‡ ç§’é’Ÿå¦‚æœUIè¿˜æ²¡å‡ºæ¥å¯èƒ½ä¼šè®¤ä¸ºæˆ‘ä»¬çš„ç¨‹åºæœ‰é—®é¢˜ã€‚å› æ­¤ï¼ŒæŠŠç¨‹åºå’Œ.NET Frameworkä¸€èµ·åˆ†å‘çš„äº‹æƒ…å°±äº¤ç»™æ„¿æ„æŠ˜è…¾çš„åŒå­¦ä»¬äº†ã€‚æˆ‘è¿˜æ˜¯æœŸå¾…ä¸‹.NET Core 3.0å§ã€‚ æ€»ç»“å¦‚æœä½ çš„ç¨‹åºæ˜¯WPFç¨‹åºï¼Œè¯·ä½¿ç”¨Fody.Costuraï¼› å¦‚æœä½ çš„ç¨‹åºä¸æ˜¯WPFç¨‹åºï¼Œé‚£ä¹ˆå¯ä»¥ä»»é€‰ILMergeå’ŒFody.Costuraçš„ä¸€ä¸ªã€‚ å¦‚æœä½ çš„ç¨‹åºéœ€è¦ä¸.NET Frameworkä¸€èµ·åˆ†å‘ï¼Œè¯·åœ¨å¤„ç†ä¸»ç¨‹åºåä½¿ç”¨æ”¯æŒé™é»˜å®‰è£…çš„Installerå°†ä¸»ç¨‹åºä¸.NETè¿è¡Œæ—¶ä¸€èµ·æ‰“åŒ…ã€‚ æˆ–è€…ç­‰.Net Core 3.0å‘å¸ƒ Reference .Net Core 3.0 - blogs.msdn.microsoft.com How the Runtime Locates Assemblies - docs.microsoft.com Fody - github.com Costura - github.com .NET Framework deployment guide for developers - docs.microsoft.com","categories":[],"tags":[{"name":"WPF","slug":"WPF","permalink":"https://verrickt.github.io/tags/WPF/"},{"name":".Net Framework","slug":"Net-Framework","permalink":"https://verrickt.github.io/tags/Net-Framework/"}]},{"title":"å¼•ç”¨ç±»å‹çš„å¼€é”€","slug":"overhead-of-reference-types","date":"2018-07-19T12:26:05.000Z","updated":"2018-08-03T03:14:39.131Z","comments":true,"path":"2018/07/19/overhead-of-reference-types/","link":"","permalink":"https://verrickt.github.io/2018/07/19/overhead-of-reference-types/","excerpt":"å€¼ç±»å‹ä¸å¼•ç”¨ç±»å‹C#ä¸­çš„ç±»å‹åˆ†ä¸ºå¼•ç”¨ç±»å‹å’Œå€¼ç±»å‹ã€‚ä½¿ç”¨structæˆ–enumå…³é”®å­—ä¿®é¥°çš„ç±»å‹å®šä¹‰æ˜¯å€¼ç±»å‹ï¼Œä½¿ç”¨classæˆ–delegateå…³é”®å­—ä¿®é¥°çš„ç±»å‹æ˜¯å¼•ç”¨ç±»å‹ã€‚å¼•ç”¨ç±»å‹å’Œå€¼ç±»å‹å„æœ‰é™åˆ¶ï¼Œåˆ†åˆ«é€‚ç”¨äºä¸åŒçš„åœºæ™¯ã€‚ä¸åŒäºC++ï¼ŒC#ä¸­çš„å€¼ç±»å‹åªèƒ½åˆ†é…åœ¨æ ˆä¸Š*1ï¼Œå¼•ç”¨ç±»å‹åªèƒ½åˆ†é…åœ¨GCå †ä¸Šã€‚C#ä¸­çš„GCæ˜¯ç²¾ç¡®å¼GCï¼Œè¿™å°±å¯¹GCå †ä¸Šçš„æŒ‡é’ˆæœ‰äº†ä¸€äº›è¦æ±‚ã€‚è¿™æ˜¯å¼•ç”¨ç±»å‹æœ‰å¼€é”€çš„åŸå› ä¹‹ä¸€ã€‚ Sync block index ä¸ Type object pointerè¯»è¿‡C# vir CLRçš„åŒå­¦ä¼šçŸ¥é“ï¼Œå¼•ç”¨ç±»å‹çš„å¼€é”€æ˜¯Sync blockindexå’ŒType object pointerã€‚ä»–ä»¬çš„é•¿åº¦æ˜¯éƒ½æ˜¯ä¸€ä¸ªå­—é•¿ã€‚å³åœ¨32ä½CLRä¸Šæ˜¯4å­—èŠ‚ï¼Œåœ¨64ä½CLRä¸Šæ˜¯8å­—èŠ‚ã€‚Sync block indexåœ¨CLRä¸­æ˜¯ç”¨äºå®ç°lock,Monitorç­‰çº¿ç¨‹åŒæ­¥åŸè¯­ï¼ŒType object pointeræ˜¯æŒ‡å‘å½“å‰å¯¹è±¡è¿è¡Œæ—¶ç±»å‹ä¿¡æ¯çš„ä¸€ä¸ªæŒ‡é’ˆã€‚Sync block indexä¸Type object pointeråªåœ¨CLRå±‚é¢å­˜åœ¨ï¼Œå¯¹C#ç¨‹åºæ¥è¯´æ˜¯é€æ˜çš„ã€‚ä½†æ˜¯CLRå°†å®ƒä»¬æš´å°è£…åéœ²C#ï¼Œä¾‹å¦‚çº¿ç¨‹åŒæ­¥åŸè¯­å’Œåå°„APIã€‚","text":"å€¼ç±»å‹ä¸å¼•ç”¨ç±»å‹C#ä¸­çš„ç±»å‹åˆ†ä¸ºå¼•ç”¨ç±»å‹å’Œå€¼ç±»å‹ã€‚ä½¿ç”¨structæˆ–enumå…³é”®å­—ä¿®é¥°çš„ç±»å‹å®šä¹‰æ˜¯å€¼ç±»å‹ï¼Œä½¿ç”¨classæˆ–delegateå…³é”®å­—ä¿®é¥°çš„ç±»å‹æ˜¯å¼•ç”¨ç±»å‹ã€‚å¼•ç”¨ç±»å‹å’Œå€¼ç±»å‹å„æœ‰é™åˆ¶ï¼Œåˆ†åˆ«é€‚ç”¨äºä¸åŒçš„åœºæ™¯ã€‚ä¸åŒäºC++ï¼ŒC#ä¸­çš„å€¼ç±»å‹åªèƒ½åˆ†é…åœ¨æ ˆä¸Š*1ï¼Œå¼•ç”¨ç±»å‹åªèƒ½åˆ†é…åœ¨GCå †ä¸Šã€‚C#ä¸­çš„GCæ˜¯ç²¾ç¡®å¼GCï¼Œè¿™å°±å¯¹GCå †ä¸Šçš„æŒ‡é’ˆæœ‰äº†ä¸€äº›è¦æ±‚ã€‚è¿™æ˜¯å¼•ç”¨ç±»å‹æœ‰å¼€é”€çš„åŸå› ä¹‹ä¸€ã€‚ Sync block index ä¸ Type object pointerè¯»è¿‡C# vir CLRçš„åŒå­¦ä¼šçŸ¥é“ï¼Œå¼•ç”¨ç±»å‹çš„å¼€é”€æ˜¯Sync blockindexå’ŒType object pointerã€‚ä»–ä»¬çš„é•¿åº¦æ˜¯éƒ½æ˜¯ä¸€ä¸ªå­—é•¿ã€‚å³åœ¨32ä½CLRä¸Šæ˜¯4å­—èŠ‚ï¼Œåœ¨64ä½CLRä¸Šæ˜¯8å­—èŠ‚ã€‚Sync block indexåœ¨CLRä¸­æ˜¯ç”¨äºå®ç°lock,Monitorç­‰çº¿ç¨‹åŒæ­¥åŸè¯­ï¼ŒType object pointeræ˜¯æŒ‡å‘å½“å‰å¯¹è±¡è¿è¡Œæ—¶ç±»å‹ä¿¡æ¯çš„ä¸€ä¸ªæŒ‡é’ˆã€‚Sync block indexä¸Type object pointeråªåœ¨CLRå±‚é¢å­˜åœ¨ï¼Œå¯¹C#ç¨‹åºæ¥è¯´æ˜¯é€æ˜çš„ã€‚ä½†æ˜¯CLRå°†å®ƒä»¬æš´å°è£…åéœ²C#ï¼Œä¾‹å¦‚çº¿ç¨‹åŒæ­¥åŸè¯­å’Œåå°„APIã€‚ ç‰¹æ®Šçš„ç±»å‹-æ•°ç»„C#ä¸­ç»å¤§éƒ¨åˆ†ç±»å‹çš„å¤§å°åœ¨ç¼–è¯‘æœŸå°±å¯ä»¥ç¡®å®šï¼Œåªè¦æŠŠå¯¹åº”çš„æˆå‘˜çš„å¤§å°ç›¸åŠ å³å¯1SizeOf(T) = T.GetFields.Select(f=&gt;f.IsClass?WordSize:Sizeof(f)).Sum(); æ•°ç»„æ˜¯ä¸ªå¾ˆç‰¹æ®Šçš„å­˜åœ¨ï¼Œç‰¹æ®Šåœ¨å®ƒçš„å¤§å°æ˜¯ä¸å…ƒç´ çš„ç±»å‹å’Œæ•°é‡æœ‰å…³ã€‚æ•°ç»„çš„å†…å­˜å¸ƒå±€åŒ…å«äº†æ‰€æœ‰çš„å…ƒç´ ã€‚(å¦ä¸€ä¸ªè¿™æ ·çš„ç±»å‹æ˜¯string)ã€‚byte[4]å’Œbyte[3]çš„ç±»å‹éƒ½æ˜¯byte[]ï¼Œç„¶è€Œå®ƒä»¬çš„å¤§å°å´ä¸ä¸€æ ·ã€‚æˆ‘ä»¬è¿™æ¬¡å°±å¥½ä»”ç»†è§‚å¯Ÿä¸‹æ•°ç»„ ä½¿ç”¨WinDBGWinDBGæ˜¯Windowsä¸‹å¸¸ç”¨çš„Debuggerã€‚è™½ç„¶æ˜¯ä»¥è°ƒè¯•éæ‰˜ç®¡ä»£ç è®¾è®¡ï¼Œä½†æ˜¯åŠ ä¸Šç›¸å…³çš„æ’ä»¶ä»¥åä¹Ÿå¯ä»¥ç”¨æ¥è°ƒè¯•æ‰˜ç®¡ä»£ç ã€‚SOS.dllæ˜¯ä¸€ä¸ªæä¾›æ‰˜ç®¡ä»£ç è°ƒè¯•æ”¯æŒçš„çš„æ’ä»¶ã€‚å®ƒåŒæ—¶æ”¯æŒCLRå’ŒCoreCLRã€‚ å®‰è£…å¥½WinDBGåï¼Œå°±å¯ä»¥å¼€å§‹è°ƒè¯•äº†ã€‚ç®€å•èµ·è§ï¼Œè¿™é‡Œä½¿ç”¨å¦‚ä¸‹ä»£ç ã€‚1234567891011121314151617namespace SOSFromEE&#123; class Program &#123; const int Length = 10; static void Main(string[] args) &#123; var ints = Enumerable.Range(1, Length).ToArray(); var strs = ints.Select(i =&gt; i.ToString()).ToArray(); Console.ReadLine(); GC.KeepAlive(ints); GC.KeepAlive(strs); Console.Read(); &#125; &#125;&#125; åœ¨WinDBGä¸­é€‰æ‹©Launchå¯¹åº”çš„å¯æ‰§è¡Œç¨‹åºå³å¯ã€‚åœ¨ç¬¬ä¸€ä¸ªæ–­ç‚¹æ—¶CLRè¿˜æ²¡æœ‰åŠ è½½ï¼Œæˆ‘ä»¬ç»§ç»­è®©ç¨‹åºè¿è¡Œï¼Œç­‰åˆ°ä¸å†å‡ºç°ModLoadç›¸å…³çš„æç¤ºæ—¶å°±å¯ä»¥è®©ç¨‹åºæš‚åœäº†ã€‚æˆ‘ä»¬åœ¨è¿™æ—¶åŠ è½½SOSæ‰©å±•ã€‚ 1.loadby sos CLRNameHere sosåè·Ÿçš„æ˜¯CLRçš„åç§° CLR2.0(.Net framework 3.5åŠä»¥å‰)æ˜¯mscorwks CLR4.0(.Net framework 4.0åŠä»¥å)æ˜¯clr .net coreæ˜¯ coreclr åŠ è½½æ¨¡å—çš„è¿‡ç¨‹ä¸­éœ€è¦ä»å¾®è½¯çš„æœåŠ¡å™¨ä¸Šä¸‹è½½ç›¸å…³çš„pdbæ–‡ä»¶ã€‚ç”±äºä½ æ‡‚çš„åŸå› éœ€è¦å¾ˆé•¿æ—¶é—´ CLR2.0 ä¸‹çš„æ•°ç»„æˆ‘ä»¬é¦–å…ˆåœ¨32ä½çš„CLR2.0ä¸‹è§‚å¯Ÿã€‚ é¦–å…ˆä½¿ç”¨.loadby sos mscorwksåŠ è½½SOSæ‰©å±•æ¨¡å—ã€‚ !dumpheap -type TypeNameHereå‘½ä»¤å¯ä»¥æŸ¥çœ‹å½“å‰æ‰˜ç®¡å †ä¸Šç±»å‹åä¸ºTypeNameHereçš„å¯¹è±¡ã€‚ System.String[]æˆ‘ä»¬å…ˆçœ‹çœ‹String[]éƒ½æœ‰å“ªäº›: 123456789100:006&gt; !dumpheap -type System.String[] Address MT Size03591390 78ae46e4 80 ..........................total 17 objectsStatistics: MT Count TotalSize Class Name78ae46e4 17 676 System.Object[]Total 17 objects Addressæ˜¾ç¤ºçš„æ˜¯å¯¹è±¡åœ¨æ‰˜ç®¡å †ä¸­çš„åœ°å€ï¼ŒMethod Tableå°±æ˜¯ä¸Šæ–‡ä¸­è¯´çš„Type object pointeräº†ã€‚ æˆ‘ä»¬æŸ¥çœ‹ä¸‹ä½äºåœ°å€03591390çš„String[]:1234567891011121314151617181920212223240:006&gt; !dumparray 03591390Name: System.String[]MethodTable: 78ae46e4EEClass: 788cda74Size: 80(0x50) bytesArray: Rank 1, Number of elements 16, Type CLASSElement Methodtable: 78b10f14[0] 035911c8[1] 03591250[2] null[3] null[4] null[5] null[6] null[7] null[8] null[9] null[10] null[11] null[12] null[13] null[14] null[15] null å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ•°ç»„ä¸€å…±æœ‰16ä¸ªå…ƒç´ ï¼Œå…ƒç´ çš„ç±»å‹æ˜¯stringã€‚ æˆ‘ä»¬å†æ¥çœ‹çœ‹03591390ä½ç½®çš„å†…å­˜å¸ƒå±€ 12345670:006&gt; dd 03591390 -0x40359138c 00000000 78ae46e4 00000010 78b10f140359139c 035911c8 03591250 00000000 00000000035913ac 00000000 00000000 00000000 00000000035913bc 00000000 00000000 00000000 00000000035913cc 00000000 00000000 00000000 00000000 dd 03591390 -0x4å‘Šè¯‰WinDBGä»03591390å‘å‰åç§»4ä¸ªå­—èŠ‚çš„ä½ç½®å¼€å§‹å±•ç¤ºå†…å­˜ã€‚ä¹‹æ‰€ä»¥å‘å‰åç§»4ä¸ªå­—èŠ‚æ˜¯ä¸ºäº†å±•ç¤ºå¼•ç”¨ç±»å‹çš„å¼€é”€ã€‚0359138cä½ç½®çš„å€¼00000000æ˜¯Sync block indexï¼Œä½äº03591390çš„78ae46e4çœ‹èµ·æ¥æœ‰ç‚¹æ‘¸ä¸ç€å¤´è„‘ï¼Œåœ¨WinDBGçš„è¾“å‡ºä¸­æŸ¥æ‰¾åå‘ç°æ˜¯System.String[]çš„MethodTableã€‚12Name: System.String[]MethodTable: 78ae46e4 MethodTableæ˜¯CLRçº§åˆ«çš„æ¦‚å¿µï¼Œå¯¹åº”åˆ°è¿™é‡Œå°±æ˜¯Type Object Pointerã€‚GCå †ä¸Šçš„å¯¹è±¡å¾€å‰åï¼”å­—èŠ‚å°±èƒ½å¾—åˆ°Sync block indexï¼Œæ¥ä¸‹æ¥æ˜¯å¯¹è±¡çš„Type object pointerã€‚ä¸ºäº†å™è¿°æ–¹ä¾¿ï¼Œä¸‹æ–‡ç»Ÿç§°ä¸ºå¯¹è±¡å¤´:) ç”±æ­¤æ¨æµ‹ï¼Œå¯¹è±¡å¤´é•¿åº¦æ˜¯ä¸¤ä¸ªå­—é•¿ã€‚èµ·å§‹ä½ç½®ä¸ºå½“å‰æŒ‡é’ˆçš„ä½ç½®å¾€å‰åç§»ä¸€ä¸ªå­—é•¿ã€‚æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥åœ¨64ä½CLRä¸Šè‡ªè¡ŒéªŒè¯ã€‚ æ•°ç»„çš„é•¿åº¦æ˜¯16(0x10)ï¼Œåœ°å€03591395çš„å€¼å°±æ˜¯å®ƒã€‚ åœ°å€03591388çš„78b10f14ä¸çŸ¥é“æ˜¯ä»€ä¹ˆã€‚æ²¡å…³ç³»ï¼ŒCTRF+FæŸ¥æ‰¾åå‘ç°å®ƒåœ¨ä¸Šæ–‡å‡ºç°è¿‡ã€‚ 1Element Methodtable: 78b10f14 åº”è¯¥æ˜¯Stringçš„Method tableã€‚ dumpä¸€ä¸‹System.String:12340:006&gt; !dumpheap -type System.String MT Count TotalSize Class Name78b10f14 154 6224 System.String çœ‹æ¥çŒœå¾—æ²¡é”™ã€‚æ€»ç»“ä¸€ä¸‹ï¼Œå¼•ç”¨ç±»å‹çš„æ•°ç»„æœ‰4å­—é•¿çš„å¼€é”€ï¼Œåˆ†åˆ«æ˜¯2å­—é•¿çš„å¯¹è±¡å¤´ï¼Œ1å­—é•¿çš„é•¿åº¦ï¼Œ1å­—é•¿çš„å…ƒç´ ç±»å‹æŒ‡é’ˆ æ¥ä¸‹æ¥çœ‹çœ‹å€¼ç±»å‹æ•°ç»„çš„å¸ƒå±€ System.Int32[]è€æ ·å­ï¼Œé¦–å…ˆå…ˆæ‰¾åˆ°å †ä¸Šçš„Int32[]. 1234567890:006&gt; !dumpheap -type System.Int32[] Address MT Size03591e50 78b130b0 296 ................................total 18 objectsStatistics: MT Count TotalSize Class Name78b130b0 18 1440 System.Int32[]Total 18 objects dumpä¸€ä¸‹ç›¸å…³å±æ€§ 1234567!dumparray 03591e50 Name: System.Int32[]MethodTable: 78b130b0EEClass: 788ce6a8Size: 296(0x128) bytesArray: Rank 1, Number of elements 71, Type Int32Element Methodtable: 78b13160 æŸ¥çœ‹å†…å­˜å¸ƒå±€ 1234567890:006&gt; dd 03591e50 -0x403591e4c 00000000 78b130b0 00000047 0000000003591e5c 00000000 00000000 00000000 0000000003591e6c 00000000 00000000 00000000 0000000003591e7c 00000000 00000000 00000000 0000000003591e8c 00000000 00000000 00000000 0000000003591e9c 00000000 00000000 00000000 0000000003591eac 00000000 00000000 00000000 0000000003591ebc 00000000 00000000 00000000 00000000 é¦–å…ˆInt32[]ä¹Ÿæœ‰å¯¹è±¡å¤´å’Œé•¿åº¦çš„å¼€é”€ï¼Œä½†æ˜¯å´æ²¡æœ‰å…ƒç´ ç±»å‹æŒ‡é’ˆçš„å¼€é”€ã€‚ æœ‰å¿ƒçš„åŒå­¦å¯èƒ½å·²ç»å‘ç°äº†ï¼ŒInt32[]æ˜ç¡®æŒ‡å‡ºäº†å…ƒç´ çš„ç±»å‹ï¼Œè€ŒString[]å´æ²¡æœ‰ã€‚ 123456!dumparray 03591390Name: System.String[]MethodTable: 78ae46e4EEClass: 788cda74Size: 80(0x50) bytesArray: Rank 1, Number of elements 16, Type *CLASS* 123456!dumparray 03591e50 Name: System.Int32[]MethodTable: 78b130b0EEClass: 788ce6a8Size: 296(0x128) bytesArray: Rank 1, Number of elements 71, Type *Int32* String[]çš„Typeæ˜¯ä¸ªCLASSè€Œä¸æ˜¯Stringï¼Œéš¾é“è¯´System.String[]æ˜¯ä¸ªâ€™å‡çš„â€™çš„å­—ç¬¦ä¸²æ•°ç»„ï¼Ÿ â€¦. â€¦. â€¦. æ­å–œä½ çŒœå¯¹äº†ã€‚ä½¿ç”¨!objsizeå‘½ä»¤å‘ç°String[]æ˜¯ä¸ªå¸¦äº†å±‚çš®çš„Object[]1234!objsize 03591e50 sizeof(03591e50) = 296 ( 0x128) bytes (System.Int32[])0:006&gt; !objsize 03591390 sizeof(03591390) = 392 ( 0x188) bytes (System.Object[]) C# in depthä¸­å¯¹æ³›å‹æœ‰è¿™æ ·çš„æè¿° å¯¹äºä¸€ä¸ªæ³›å‹ç±»MyGeneric&lt;T&gt;ï¼Œå¯¹äºTçš„æ˜¯å¼•ç”¨ç±»å‹çš„æƒ…å†µï¼ŒJITåªä¼šä¸ºå…¶ç”Ÿæˆä¸€ä»½ä»£ç ;å¯¹äºTæ˜¯å€¼ç±»å‹çš„æƒ…å†µï¼Œåˆ™ä¸ºæ¯ä¸€ä¸ªä¸åŒçš„Tç”Ÿæˆå„è‡ªçš„ä»£ç ã€‚å…¶ä¸­çš„åŸå› æ˜¯ï¼Œåœ¨JITè¿è¡Œæ—¶ï¼ŒæŒ‡é’ˆçš„é•¿åº¦æ€»æ˜¯å›ºå®šçš„ï¼Œå› è€Œå¯ä»¥å…±ç”¨ä¸€å¥—ä»£ç ç›¸åŒçš„ä»£ç ã€‚è€Œå€¼ç±»å‹çš„é•¿åº¦æ˜¯ä¸ç¡®å®šçš„ï¼Œå› æ­¤éœ€è¦ä¸ºæ¯ä¸ªå€¼ç±»å‹å•ç‹¬ç”Ÿæˆä»£ç ã€‚ è¿™é‡Œå¯èƒ½ä¹Ÿæ˜¯ç›¸åŒçš„åŸå› å§ã€‚æŒ‡é’ˆçš„é•¿åº¦ç›¸åŒï¼Œå› è€Œæ‰éœ€è¦å‚¨å­˜å…ƒç´ çš„ç±»å‹æŒ‡é’ˆï¼Œå®ç°ç±»å‹æ£€æŸ¥ã€‚è€Œå€¼ç±»å‹çš„ä»£ç ä¸å…±ç”¨ï¼Œæ‰€ä»¥ä¸éœ€è¦å‚¨å­˜å…ƒç´ çš„ç±»å‹æŒ‡é’ˆã€‚ æœ¬æ¥åˆ°å·²ç»å¯ä»¥ç»“æŸäº†ï¼Œå¯æ˜¯æˆ‘åœ¨32ä½çš„CLR4.0è§‚å¯Ÿåˆ°çš„ç»“æœå´ä¸å¤ªä¸€æ ·ã€‚ CLR 4.0ä¸‹çš„æ•°ç»„ä¸CLR 2.0ä¸åŒï¼ŒCLR 4.0ä¸‹åŠ è½½SOSçš„åå­—æ˜¯clr .loadby sos clr System.String[]é¦–å…ˆdumpheapï¼š 123456780:006&gt; !dumpheap -type System.String[] Address MT Size02531590 6979dfe0 84 ...........................Statistics: MT Count TotalSize Class Name6979dfe0 24 912 System.String[]Total 24 objects ç„¶åæ˜¯dumparray:1234567Name: System.String[]MethodTable: 6979dfe0EEClass: 69374b80Size: 84(0x54) bytesArray: Rank 1, Number of elements 18, Type CLASSElement Methodtable: 6979d488[0] 02531254 æœ€ådd:12345670:006&gt; dd 02531590 -0x40253158c 00000000 6979dfe0 00000012 025312540253159c 025312d8 00000000 00000000 02531568025315ac 00000000 00000000 00000000 00000000025315bc 00000000 00000000 00000000 00000000025315cc 00000000 00000000 00000000 00000000025315dc 00000000 00000000 ä½äº02531598çš„å€¼02531254æ˜¯ç¬¬ä¸€ä¸ªå…ƒç´ çš„å€¼è€Œä¸æ˜¯Stringçš„Method Table!12345!dumpheap -type StringStatistics: MT Count TotalSize Class Name6979d488 193 5932 System.StringTotal 224 objects CLR 4.0æŠŠMethod Tableå»æ‰äº†ï¼Ÿ ç»è¿‡ç®€å•çš„ç®—æœ¯ï¼Œç¡®å®æ˜¯è¿™æ ·çš„18ä¸ªå…ƒç´ ï¼Œå æ®ç©ºé—´18*4=72ã€‚ å¯¹è±¡å¤´å’Œæ•°ç»„å¤§å°å æ®2*4+4=12 84=72+12ï¼Œè·Ÿdumparrayå‡ºæ¥çš„å€¼ä¸€æ ·ã€‚(æœ‰å…´è¶£çš„åŒå­¦æ ¹æ®ä¸Šæ–‡ä¸­CLR2.0çš„æ•°æ®è®¡ç®—ä¸‹) !objsizeä¹Ÿç¡®è®¤äº†æˆ‘ä»¬çš„çŒœæµ‹120:006&gt; !objsize 02531590sizeof(02531590) = 428 (0x1ac) bytes (System.String[]) System.Int32[]!dumpheap:123456780:006&gt; !dumpheap -type System.Int32[] Address MT Size02531f1c 6979f2a0 300 .............................. Statistics: MT Count TotalSize Class Name6979f2a0 20 844 System.Int32[]Total 20 objects !dumparray:1234567890:006&gt; !dumparray 02531f1c Name: System.Int32[]MethodTable: 6979f2a0EEClass: 693752d8Size: 300(0x12c) bytesArray: Rank 1, Number of elements 72, Type Int32Element Methodtable: 6979f2dc[0] 02531f24[1] 02531f28 dd:1234567890:006&gt; dd 02531f1c -0x402531f18 00000000 6979f2a0 00000048 0000000302531f28 00000007 0000000b 00000011 0000001702531f38 0000001d 00000025 0000002f 0000003b02531f48 00000047 00000059 0000006b 0000008302531f58 000000a3 000000c5 000000ef 0000012502531f68 00000161 000001af 00000209 0000027702531f78 000002f9 00000397 0000044f 0000052f02531f88 0000063d 0000078b 0000091d 00000af1 å€¼ç±»å‹æ•°ç»„å€’æ˜¯æ²¡æœ‰ä»€ä¹ˆå˜åŒ–ã€‚ æ€»ç»“C#ä¸­å¼•ç”¨ç±»å‹æœ‰2ä¸ªå­—é•¿çš„å¯¹è±¡å¤´å¼€é”€ã€‚åˆ†åˆ«æ˜¯Sync block indexå’ŒType Object Pointerã€‚æ•°ç»„æ˜¯ç‰¹æ®Šçš„ç±»å‹ï¼Œå®ƒçš„å¤§å°ä¸åŒ…å«çš„å…ƒç´ ç›¸å…³ï¼Œå› æ­¤å…·æœ‰é¢å¤–çš„å¼€é”€ã€‚ åœ¨CLR 2.0ä¸‹ å¼•ç”¨ç±»å‹çš„æ•°ç»„åŒ…å«é¢å¤–çš„2å­—é•¿çš„å¼€é”€ã€‚åˆ†åˆ«æ˜¯é•¿åº¦å’Œå…ƒç´ çš„ç±»å‹æŒ‡é’ˆ å€¼ç±»å‹çš„æ•°ç»„åŒ…å«é•¿åº¦çš„é¢å¤–å¼€é”€å¼€é”€ã€‚å¤§å°æ˜¯ä¸€ä¸ªå­—é•¿ã€‚ åœ¨CLR 4.0å’ŒCoreCLRä¸­ å¼•ç”¨ç±»å‹å’Œå€¼ç±»å‹çš„æ•°ç»„åŒ…å«é•¿åº¦çš„é¢å¤–å¼€é”€å¼€é”€ã€‚å¤§å°æ˜¯ä¸€ä¸ªå­—é•¿ã€‚ é™äºç¯‡å¹…ï¼ŒCoreCLRçš„æƒ…å†µä¸å†èµ˜è¿°ï¼Œè¿˜è¯·è¯»è€…è‡ªè¡ŒéªŒè¯ã€‚ /*å…¶å®æœ¬æ¥çœ‹åˆ°Stackoverflowçš„å›ç­”åªæ˜¯æƒ³è‡ªå·±éªŒè¯ä¸‹çš„ï¼Œä½†æ˜¯è‡ªå·±åŠ¨æ‰‹çš„ç»“æœå’Œç­”æ¡ˆé‡Œæåˆ°çš„ä¸å¤ªä¸€æ ·ï¼ŒæŸ¥äº†åŸå› å‘ç°ç­”æ¡ˆé‡Œç”¨çš„æ˜¯CLR2.0ï¼Œæˆ‘è‡ªå·±ç”¨çš„æ˜¯CLR4.0ã€‚è¿™å°±æŒ–å‡ºæ¥äº†CLRå®ç°çš„æ›´æ”¹ã€‚CoreCLRé‡Œä½¿ç”¨çš„æ˜¯CLR4.0é‡Œçš„è§„åˆ™ã€‚ç›®å‰è¿˜ä¸æ¸…æ¥šMSä¸ºä½•è¦æ”¹å®ç°*/ å‚è€ƒ Overhead of a .NET array? SOS.dll (SOS Debugging Extension)","categories":[],"tags":[{"name":"C#","slug":"C","permalink":"https://verrickt.github.io/tags/C/"},{"name":"reference type","slug":"reference-type","permalink":"https://verrickt.github.io/tags/reference-type/"},{"name":"overhead","slug":"overhead","permalink":"https://verrickt.github.io/tags/overhead/"}]},{"title":"é¢å‘æŠ½è±¡ç¼–ç¨‹","slug":"program-upon-abstractions","date":"2018-07-12T13:56:26.000Z","updated":"2018-08-04T08:30:08.370Z","comments":true,"path":"2018/07/12/program-upon-abstractions/","link":"","permalink":"https://verrickt.github.io/2018/07/12/program-upon-abstractions/","excerpt":"Prefaceè¯´æ¥æƒ­æ„§ï¼Œç›´åˆ°è¿‘å‡ å¤©æ‰æ˜ç™½äº†ä¸€ç‚¹é¢å‘å¯¹è±¡è®¾è®¡çš„ã€‚ç»™æˆ‘å¸¦æ¥å¯å‘çš„æ˜¯SOLIDä¸­çš„Dï¼Œå®ƒä»£è¡¨Dependency Inversionï¼ˆä¾èµ–åè½¬ï¼‰ã€‚å°½ç®¡å†™/èƒŒå®šä¹‰å¾ˆæ— èŠï¼Œä½†æˆ‘è¿˜æ˜¯æƒ³å†™ä¸€ä¸‹ä¾èµ–åè½¬çš„æ ¸å¿ƒ ä¸Šå±‚æ¨¡å—ä¸åº”è¯¥ä¾èµ–ä¸‹å±‚æ¨¡å—ï¼Œä»–ä»¬éƒ½åº”è¯¥ä¾èµ–æŠ½è±¡ Talk is cheap, show me the codeæœ€è¿‘åœ¨å†™ä¸€ä¸ªéŸ³ä¹ç”µå°åº”ç”¨ï¼Œé‡‡ç”¨æœåŠ¡ç«¯ã€å®¢æˆ·ç«¯çš„æ–¹å¼å®ç°ã€‚åœ¨æœåŠ¡ç«¯ï¼Œç”¨æˆ·å¯ä»¥æŒ‡å®šä¸€ä¸ªè·¯å¾„ï¼Œç¨‹åºæ ¹æ®è¿™ä¸ªè·¯å¾„ç”Ÿæˆæ’­æ”¾åˆ—è¡¨ã€‚ éœ€æ±‚æœåŠ¡å™¨æ˜¯ä¸€ä¸ªä¸€æ—¦å¼€èµ·æ¥å°±ä¸ä¼šè½»æ˜“å…³é—­çš„ç¨‹åºï¼Œæˆ‘å¸Œæœ›æ’­æ”¾åˆ—è¡¨èƒ½å¤Ÿè‡ªåŠ¨åˆ·æ–°ã€‚è¿™æ ·å½“ç”¨æˆ·æ·»åŠ æˆ–åˆ é™¤äº†æŸé¦–éŸ³ä¹åä¸ç”¨é‡å¯æœåŠ¡å™¨å°±å¯ä»¥åæ˜ å˜åŒ–ã€‚è€ƒè™‘åˆ°æ˜“ç”¨æ€§ï¼Œåº”è¯¥æ”¯æŒç”±è·¯å¾„ç›´æ¥ç”Ÿæˆæ’­æ”¾åˆ—è¡¨ã€‚æ­Œæ›²æ˜¯æœ‰å°é¢ç­‰å…¶ä»–ä¿¡æ¯çš„ï¼Œè¦æ»¡è¶³è¿™äº›ä¿¡æ¯çš„å¯å®šåˆ¶åŒ–ï¼Œç¨‹åºä¹Ÿæ”¯æŒç”±é…ç½®æ–‡ä»¶æŒ‡å®šçš„æ’­æ”¾åˆ—è¡¨ã€‚","text":"Prefaceè¯´æ¥æƒ­æ„§ï¼Œç›´åˆ°è¿‘å‡ å¤©æ‰æ˜ç™½äº†ä¸€ç‚¹é¢å‘å¯¹è±¡è®¾è®¡çš„ã€‚ç»™æˆ‘å¸¦æ¥å¯å‘çš„æ˜¯SOLIDä¸­çš„Dï¼Œå®ƒä»£è¡¨Dependency Inversionï¼ˆä¾èµ–åè½¬ï¼‰ã€‚å°½ç®¡å†™/èƒŒå®šä¹‰å¾ˆæ— èŠï¼Œä½†æˆ‘è¿˜æ˜¯æƒ³å†™ä¸€ä¸‹ä¾èµ–åè½¬çš„æ ¸å¿ƒ ä¸Šå±‚æ¨¡å—ä¸åº”è¯¥ä¾èµ–ä¸‹å±‚æ¨¡å—ï¼Œä»–ä»¬éƒ½åº”è¯¥ä¾èµ–æŠ½è±¡ Talk is cheap, show me the codeæœ€è¿‘åœ¨å†™ä¸€ä¸ªéŸ³ä¹ç”µå°åº”ç”¨ï¼Œé‡‡ç”¨æœåŠ¡ç«¯ã€å®¢æˆ·ç«¯çš„æ–¹å¼å®ç°ã€‚åœ¨æœåŠ¡ç«¯ï¼Œç”¨æˆ·å¯ä»¥æŒ‡å®šä¸€ä¸ªè·¯å¾„ï¼Œç¨‹åºæ ¹æ®è¿™ä¸ªè·¯å¾„ç”Ÿæˆæ’­æ”¾åˆ—è¡¨ã€‚ éœ€æ±‚æœåŠ¡å™¨æ˜¯ä¸€ä¸ªä¸€æ—¦å¼€èµ·æ¥å°±ä¸ä¼šè½»æ˜“å…³é—­çš„ç¨‹åºï¼Œæˆ‘å¸Œæœ›æ’­æ”¾åˆ—è¡¨èƒ½å¤Ÿè‡ªåŠ¨åˆ·æ–°ã€‚è¿™æ ·å½“ç”¨æˆ·æ·»åŠ æˆ–åˆ é™¤äº†æŸé¦–éŸ³ä¹åä¸ç”¨é‡å¯æœåŠ¡å™¨å°±å¯ä»¥åæ˜ å˜åŒ–ã€‚è€ƒè™‘åˆ°æ˜“ç”¨æ€§ï¼Œåº”è¯¥æ”¯æŒç”±è·¯å¾„ç›´æ¥ç”Ÿæˆæ’­æ”¾åˆ—è¡¨ã€‚æ­Œæ›²æ˜¯æœ‰å°é¢ç­‰å…¶ä»–ä¿¡æ¯çš„ï¼Œè¦æ»¡è¶³è¿™äº›ä¿¡æ¯çš„å¯å®šåˆ¶åŒ–ï¼Œç¨‹åºä¹Ÿæ”¯æŒç”±é…ç½®æ–‡ä»¶æŒ‡å®šçš„æ’­æ”¾åˆ—è¡¨ã€‚ ç°æœ‰ä»£ç 123456789internal class PlaylistManager&#123; public IReadonlyList&lt;Song&gt; AllSong =&gt; _backLogs.AsReadOnly(); private readonly List&lt;Song&gt; _backLogs; public PlaylistManager(IEnumerable&lt;Song&gt; backlog) &#123; _backLogs = new List&lt;Song&gt;(backlog); &#125;&#125; ç°æœ‰ä»£ç ä¸­æ„é€ å‡½æ•°çš„IEnumerable\\å‚æ•°æŒ‡å®šäº†æ’­æ”¾åˆ—è¡¨ï¼Œå¯æ˜¯åˆ·æ–°å´éœ€è¦å¤–éƒ¨çš„æ”¯æŒï¼šåŸºäºè·¯å¾„çš„åˆ·æ–°å’ŒåŸºäºé…ç½®æ–‡ä»¶çš„åˆ·æ–°æ˜¯å®Œå…¨ä¸ä¸€æ ·çš„ã€‚æˆ‘å®Œå…¨å¯ä»¥æŠŠè¿™ä¸¤ä¸ªåˆ·æ–°éƒ½æ”¾åˆ°PlaylistManageré‡Œï¼Œæ ¹æ®ç”Ÿæˆæ’­æ”¾åˆ—è¡¨çš„ç±»å‹å†³å®šè°ƒç”¨é‚£ä¸ªç‰ˆæœ¬ã€‚è¿™æ ·å°±æŠŠPlaylistManagerå®Œå…¨å’Œåˆ—è¡¨ç”Ÿæˆçš„é€»è¾‘ç»‘æ­»åœ¨ä¸€èµ·äº†ï¼Œå¦‚æœä»¥åè¦åœ¨åŠ ä¸€ä¸ªæ–°çš„ç”Ÿæˆæ–¹å¼å°±è¿˜è¦ä¿®æ”¹PlaylistManagerçš„ä»£ç ï¼Œå°½ç®¡å®ƒè·ŸPlaylistManagerå¹¶æ— å…³ç³» ä¿®æ”¹æ€è·¯å¦‚æœæˆ‘ä»¬å°†ç”Ÿæˆæ’­æ”¾åˆ—è¡¨è¿™ä¸€è¡Œä¸ºæŠ½è±¡ä¸ºæ¥å£IPlaylistProviderçš„è¯ï¼ŒPlaylistManagerå°±å¯ä»¥å®Œå…¨è·Ÿè¿™éƒ¨åˆ†é€»è¾‘åˆ†å¼€äº† 123456789101112131415161718192021222324public interface IPlaylistProvider&#123; IReadonlyList&lt;Song&gt; AllSongs &#123; get; &#125; void Refresh();&#125;internal class PlaylistManager&#123; public IReadonlyList&lt;Song&gt; AllSong =&gt; _backLogs.AsReadOnly(); private readonly List&lt;Song&gt; _backLogs; private readonly IPlaylistProvider _provider; public PlaylistManager(IPlaylistProvider provider) &#123; _provider = provider; _backLogs = new List&lt;Song&gt;(_provider.AllSongs); &#125; internal void Refresh() &#123; Refresh(); _backLogs.Clear(); _backLogs.AddRange(_provider.AllSongs); &#125;&#125; æˆ‘ä»¬å¯ä»¥åˆ†åˆ«å®ç°åŸºäºè·¯å¾„å’Œé…ç½®æ–‡ä»¶çš„IPlaylistProvider 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768public class FileSystemProvider : IPlaylistProvider&#123; public FileSystemProvider(string path,bool recursive) &#123; if (!Directory.Exists(path)) &#123; throw new ArgumentException($\"&#123;path&#125; is not a directory\"); &#125; Path = path; Recursive = recursive; _songs = ReadSongs(); &#125; static readonly string[] MusicExtension = new[] &#123;\".mp3\",\".wma\" &#125;; private List&lt;Song&gt; ReadSongs() &#123; var song = new List&lt;Song&gt;(); var dir = new DirectoryInfo(Path); var files = dir.GetFiles().Where(i =&gt; MusicExtension.Contains(i.Extension)); song.AddRange(files.Select(f =&gt; new Song() &#123; FilePath = f.FullName, Title = f.Name, &#125;)); return song; &#125; public IReadOnlyList&lt;Song&gt; AllSongs =&gt; _songs.AsReadOnly(); public string Path &#123; get; &#125; public bool Recursive &#123; get; &#125; private List&lt;Song&gt; _songs; public void Refresh() &#123; _songs = ReadSongs(); &#125;&#125;public class JsonPlaylistProvider : IPlaylistProvider&#123; public JsonPlaylistProvider(string configPath) &#123; _songs = ReadSongs(); ConfigPath = configPath; if (!File.Exists(ConfigPath)) &#123; throw new ArgumentException($\"Can't find config file at &#123;ConfigPath&#125;\"); &#125; ReadSongs(); &#125; private List&lt;Song&gt; ReadSongs() &#123; var json = File.ReadAllText(ConfigPath); return JsonConvert.DeserializeObject&lt;List&lt;Song&gt;&gt;(json)??new List&lt;Song&gt;(); &#125; private List&lt;Song&gt; _songs; public string ConfigPath &#123; get; &#125; public IReadOnlyList&lt;Song&gt; AllSongs =&gt; _songs.AsReadOnly(); public void Refresh() &#123; ReadSongs(); &#125;&#125; è¿™ä¸ªä¾‹å­ä¸­ï¼ŒPlaylistManagerä¸ä¾èµ–FileSystemProviderå’ŒJsonPlaylistProviderï¼Œå®ƒä»¬ä¸‰è€…éƒ½ä¾èµ–äºIPlaylistProviderè¿™ä¸€æ¥å£ã€‚ä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ç›¸æ¯”äºæŠŠåˆ·æ–°çš„é€»è¾‘æ”¾åœ¨PlaylistManageré‡Œé«˜äº†å¥½å¤š è¿™é‡Œä½“ç°äº†ä¾èµ–åè½¬çš„åŸåˆ™ï¼š ä¸Šå±‚æ¨¡å—ä¸åº”è¯¥ä¾èµ–ä¸‹å±‚æ¨¡å—ï¼Œå®ƒä»¬éƒ½åº”è¯¥ä¾èµ–ä¸æŠ½è±¡ æˆ‘åœ¨ç”¨SOLIDé‡æ„æ‰‹å¤´çš„é¡¹ç›®ï¼Œæ”¹çš„å·®ä¸å¤šçš„æ—¶å€™æ‰“ç®—å†™å†™å¼€å‘ç¬”è®°ã€‚å’•å’•å’•","categories":[],"tags":[{"name":"OOP","slug":"OOP","permalink":"https://verrickt.github.io/tags/OOP/"},{"name":"SOLID","slug":"SOLID","permalink":"https://verrickt.github.io/tags/SOLID/"}]},{"title":"è®°ä¸€æ¬¡æ„‰(dan)å¿«(teng)çš„æ‰è™«","slug":"hell-mode-debugging","date":"2018-05-21T13:03:59.000Z","updated":"2018-08-04T10:24:55.494Z","comments":true,"path":"2018/05/21/hell-mode-debugging/","link":"","permalink":"https://verrickt.github.io/2018/05/21/hell-mode-debugging/","excerpt":"åºŸè¯BUGæ˜¯ä»»ä½•è½¯ä»¶éƒ½ä¼šé‡åˆ°çš„é—®é¢˜ã€‚å®ƒé€šå¸¸æ˜¯å¼€å‘äººå‘˜è€ƒè™‘é—®é¢˜ä¸å…¨é¢è€ŒåŸ‹ä¸‹çš„éšå½¢ç‚¸å¼¹ï¼Œåœ¨æ¡ä»¶åˆé€‚çš„æ—¶å€™å°±ä¼šçˆ†ç‚¸ï¼›å¼€å‘è‡ªå·±åŸ‹BUGå¾€å¾€æ¯”è¾ƒå®¹æ˜“é™¤é”™ï¼Œå› ä¸ºä»£ç éƒ½æ˜¯è‡ªå·±å†™çš„ï¼Œå®šä½é—®é¢˜ågit blameä¸€ä¸‹å°±å¯ä»¥ç”©é”…äº†ï¼›è€Œç¨‹åºä¾èµ–é¡¹é‡Œçš„BUGåˆ™æ’æŸ¥èµ·æ¥åˆ™è®©äººä¸€ç­¹è«å±•ï¼Œå°¤å…¶æ˜¯åœ¨æ²¡æœ‰è¶³å¤Ÿå¤šä¿¡æ¯çš„æƒ…å†µã€‚ é¢å¯¹æ¥è‡ªå®¢æˆ·å’ŒQAçš„å‹åŠ›ï¼Œç»å°½è„‘æ±ä»æ— æ³•å®šä½é—®é¢˜å¼€å‘ä»¬åªèƒ½æ‰¾å€Ÿå£äº†ğŸ¤£ Itâ€™s a feature,not a bug. Thatâ€™s the design decision, so not a bug æˆ‘ä»¥å‰ä¹Ÿé‡åˆ°æ¡†æ¶å‡ºé—®é¢˜çš„æƒ…å†µï¼Œä¸è¿‡éƒ½æ˜¯è‡ªå·±æ”¹ä»£ç æ”¹å‡ºæ¥çš„ï¼Œå€’ä¹Ÿä¸æ˜¯å¾ˆéš¾æ’æŸ¥ã€‚ä½†è¿™æ¬¡æŒ–å‡ºæ¥çš„BUGå°±å®Œå…¨ä¸ä¸€æ ·äº†","text":"åºŸè¯BUGæ˜¯ä»»ä½•è½¯ä»¶éƒ½ä¼šé‡åˆ°çš„é—®é¢˜ã€‚å®ƒé€šå¸¸æ˜¯å¼€å‘äººå‘˜è€ƒè™‘é—®é¢˜ä¸å…¨é¢è€ŒåŸ‹ä¸‹çš„éšå½¢ç‚¸å¼¹ï¼Œåœ¨æ¡ä»¶åˆé€‚çš„æ—¶å€™å°±ä¼šçˆ†ç‚¸ï¼›å¼€å‘è‡ªå·±åŸ‹BUGå¾€å¾€æ¯”è¾ƒå®¹æ˜“é™¤é”™ï¼Œå› ä¸ºä»£ç éƒ½æ˜¯è‡ªå·±å†™çš„ï¼Œå®šä½é—®é¢˜ågit blameä¸€ä¸‹å°±å¯ä»¥ç”©é”…äº†ï¼›è€Œç¨‹åºä¾èµ–é¡¹é‡Œçš„BUGåˆ™æ’æŸ¥èµ·æ¥åˆ™è®©äººä¸€ç­¹è«å±•ï¼Œå°¤å…¶æ˜¯åœ¨æ²¡æœ‰è¶³å¤Ÿå¤šä¿¡æ¯çš„æƒ…å†µã€‚ é¢å¯¹æ¥è‡ªå®¢æˆ·å’ŒQAçš„å‹åŠ›ï¼Œç»å°½è„‘æ±ä»æ— æ³•å®šä½é—®é¢˜å¼€å‘ä»¬åªèƒ½æ‰¾å€Ÿå£äº†ğŸ¤£ Itâ€™s a feature,not a bug. Thatâ€™s the design decision, so not a bug æˆ‘ä»¥å‰ä¹Ÿé‡åˆ°æ¡†æ¶å‡ºé—®é¢˜çš„æƒ…å†µï¼Œä¸è¿‡éƒ½æ˜¯è‡ªå·±æ”¹ä»£ç æ”¹å‡ºæ¥çš„ï¼Œå€’ä¹Ÿä¸æ˜¯å¾ˆéš¾æ’æŸ¥ã€‚ä½†è¿™æ¬¡æŒ–å‡ºæ¥çš„BUGå°±å®Œå…¨ä¸ä¸€æ ·äº† èƒŒæ™¯ä¸€ä¸ªWPFçš„é¡¹ç›®ï¼Œå‹‰å¼ºåœ¨deadlineä¹‹å‰èµ¶å®Œäº†åŠŸèƒ½ã€‚å‡ºäº†æ–°ç‰ˆæœ¬åæ¥åˆ°QAæŠ¥å‘Šï¼Œç¨‹åºåœ¨Windows 8.1ä¸Šæ­»äºOOM: System.OutOfMemoryException: Insufficient memory to continue the execution of the program. at System.Windows.Media.MediaContext.NotifyPartitionIsZombie(Int32 failureCode) at System.Windows.Media.MediaContext.NotifyChannelMessage() at System.Windows.Interop.HwndTarget.HandleMessage(Int32 msg, IntPtr wparam, IntPtr lparam) at System.Windows.Interop.HwndSource.HwndTargetFilterMessage(IntPtr hwnd, Int32 msg, IntPtr wParam, IntPtr lParam, Boolean&amp; handled) at MS.Win32.HwndWrapper.WndProc(IntPtr hwnd, Int32 msg, IntPtr wParam, IntPtr lParam, Boolean&amp; handled) at MS.Win32.HwndSubclass.DispatcherCallbackOperation(Object o) at System.Windows.Threading.ExceptionWrapper.InternalRealCall(Delegate callback, Object args, Boolean isSingleParameter) at System.Windows.Threading.ExceptionWrapper.TryCatchWhen(Object source, Delegate callback, Object args, Boolean isSingleParameter, Delegate catchHandler) at System.Windows.Threading.Dispatcher.WrappedInvoke(Delegate callback, Object args, Boolean isSingleParameter, Delegate catchHandler) at System.Windows.Threading.Dispatcher.InvokeImpl(DispatcherPriority priority, TimeSpan timeout, Delegate method, Object args, Boolean isSingleParameter) at System.Windows.Threading.Dispatcher.Invoke(DispatcherPriority priority, Delegate method, Object arg) at MS.Win32.HwndSubclass.SubclassWndProc(IntPtr hwnd, Int32 msg, IntPtr wParam, IntPtr lParam) at MS.Win32.UnsafeNativeMethods.DispatchMessage(MSG&amp; msg) at System.Windows.Threading.Dispatcher.PushFrameImpl(DispatcherFrame frame) at System.Windows.Threading.Dispatcher.PushFrame(DispatcherFrame frame) at System.Windows.Threading.Dispatcher.Run() æ‰è™«å‡ºå¸ˆä¸åˆ©ç¨‹åºé‡Œç”¨è‡ªå®šä¹‰çš„Window Styleæ›¿ä»£äº†WPFè‡ªå¸¦çš„ã€‚ä½†æ˜¯è‡ªå®šä¹‰çš„Window Styleåœ¨æœ€å¤§åŒ–çš„æ—¶å€™ä¼šè¦†ç›–ä»»åŠ¡æ ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†å›ç­”é‡Œè‡ªå®šä¹‰çš„æ¶ˆæ¯å¾ªç¯ã€‚çœ‹åˆ°è°ƒç”¨æ ˆé‡Œçš„Hwndï¼Œåˆæ­¥æ€€ç–‘æ˜¯è‡ªå®šä¹‰çš„æ¶ˆæ¯å¾ªç¯çš„é—®é¢˜ã€‚æŠŠæ¶ˆæ¯å¾ªç¯ç›¸å…³çš„ä»£ç æ‹¿æ‰ï¼Œé—®é¢˜ä¾æ—§ã€‚çœ‹æ¥ä¸æ˜¯æ¶ˆæ¯å¾ªç¯çš„é—®é¢˜ã€‚ä¸è¿‡ä¸ºä»€ä¹ˆæˆ‘åœ¨å¼€å‘çš„æ—¶å€™æ²¡æœ‰é‡åˆ°é—®é¢˜å‘¢ï¼Ÿ å¯»æ‰¾åŸå› æŠŠå‡ºé—®é¢˜ç‰ˆæœ¬ç›´æ¥æ”¾åœ¨æˆ‘çš„å¼€å‘æœºä¸Šè·‘å‘ç°å¹¶æ²¡æœ‰é—®é¢˜ã€‚æ”¾åœ¨å¦ä¸€ä¸ªåŒäº‹çš„æœºå­ä¸Šä¹Ÿæ²¡é—®é¢˜ã€‚è¿™æ—¶å€™æ„è¯†åˆ°é—®é¢˜æœ‰ç‚¹è¹Šè··ã€‚ä¸€èˆ¬æ¥è¯´è¿™ç§ä¸èƒ½ç¨³å®šé‡ç°çš„é—®é¢˜éƒ½æˆ–å¤šæˆ–å°‘ä¼šå’Œå¤šçº¿ç¨‹å’Œæ­»é”æœ‰å…³ã€‚ç„¶è€Œä¸Šä¸ªç‰ˆæœ¬åˆ°è¿™ä¸ªç‰ˆæœ¬å¹¶æ²¡æœ‰å†™è¿™äº›æ–¹é¢çš„ä»£ç ã€‚è¿™æ—¶å€™å¼€å§‹æ€€ç–‘æ˜¯ç¯å¢ƒçš„é—®é¢˜äº†ã€‚æ‰¾æ¥å„ä¸ªç‰ˆæœ¬çš„Windowsï¼Œä¾æ¬¡å°è¯•åå‘ç°åªåœ¨Windows 8.1ä¸Šæœ‰é—®é¢˜ã€‚éš¾é“æ˜¯OSçš„é—®é¢˜ï¼ŸåŒäº‹æé†’äº†ä¸€å¥ï¼Œè¯´ä»¥å‰çš„ç‰ˆæœ¬æ˜¯å¯ä»¥åœ¨Windows 8.1ä¸Šæ­£å¸¸è·‘çš„ã€‚ç”¨äºŒåˆ†æ³•ï¼Œæ‰¾åˆ°äº†æœ€æ™šçš„èƒ½ç”¨çš„ç‰ˆæœ¬Bå’Œæœ€æ—©çš„ä¸èƒ½ç”¨çš„ç‰ˆæœ¬Aã€‚ åˆå…¥å›°å¢ƒæŒ‰ç†è¯´ï¼Œæ‰¾åˆ°ç‰ˆæœ¬ådiffä¸‹æ”¹åŠ¨çš„ä»£ç å°±èƒ½æ¯”è¾ƒå¿«çš„å®šä½é—®é¢˜äº†ã€‚ä¸è¿‡ç°åœ¨æœ‰äº†ç¨³å®šæµ®ç°çš„ç‰ˆæœ¬Bï¼Œæˆ‘å†³å®šä»å¼‚å¸¸æœ¬èº«å…¥æ‰‹ã€‚ä¸€ç•ªæœç´¢åæ‰¾åˆ°äº†å¾®è½¯çš„ä¸€ç¯‡åšå®¢ï¼Œå…¶ä¸­æåˆ°è¿™ä¸ªé”™è¯¯é€šå¸¸æ˜¯æ¸²æŸ“å­ç³»ç»Ÿå‡ºé—®é¢˜çš„ç—‡çŠ¶ï¼š â€¦ WPF render thread encountered some fatal error â€¦ Most of the time, a failure occurs when calling into DirectX/D3D â€¦ When a failure is detected, The render thread will attempt to map the failure it receives to an appropriate managed exception. The render thread only synchronizes with the UI thread in a few locations â€¦The most common locations when they synchronize are â€¦ or as a result of the UI thread handling a â€œchannelâ€ message from DirectX. If a render thread failure manifests as a System.OutOfMemoryException, then the likelihood is that the render thread was a victim of the process exhausting some resource .The exhausted resource is most often available/contiguous virtual address space â€¦ It might be a situation where sometimes the WPF render thread is the victim of the resource exhaustion â€¦ WPFé‡Œçš„æ¸²æŸ“æ˜¯ç”±éæ‰˜ç®¡çš„DirectXåšçš„ã€‚ä¸ºäº†ä»ç¨‹åºå‘˜çš„è§’åº¦éšè—æ‰æ¸²æŸ“è¿™ä¸ªè¿‡ç¨‹ï¼ŒWPFå°†è‡ªèº«æ‹†åˆ†ä¸ºä¸åŒçš„ç»„ä»¶ã€‚PreserentationFramework.dllå’ŒPreserentationFrameworkCore.dllæ˜¯ç¨‹åºå‘˜ç›´æ¥èƒ½æ¥è§¦åˆ°çš„ã€‚è¿™é‡Œå®ç°çš„æ˜¯ç»„åˆå­ç³»ç»Ÿã€‚æ¸²æŸ“å­ç³»ç»Ÿåˆ™åœ¨éæ‰˜ç®¡çš„milcore.dllé‡Œå®ç°ã€‚System.Windows.Media.Visualæ˜¯WPFç»„åˆå­ç³»ç»Ÿçš„å…¥å£ç‚¹ï¼Œå®ƒé€šè¿‡ç§æœ‰çš„é€šä¿¡åè®®ä¸milcoreé‡Œçš„æ¸²æŸ“å­ç³»ç»Ÿé€šä¿¡ï¼Œä»è€Œå°†ç»„åˆå­ç³»ç»Ÿå’Œæ¸²æŸ“å­ç³»ç»Ÿè¿æ¥èµ·æ¥ã€‚ çœ‹èµ·æ¥æˆ‘ä»¬çš„ä»£ç è€—å°½äº†DirectXé‡Œè¾¹çš„æŸç§èµ„æºï¼Œä»è€Œè®©æ¸²æŸ“å¤±è´¥äº†ã€‚C#åšä¸ºä¸€ä¸ªæ‰˜ç®¡è¯­è¨€ï¼Œå±…ç„¶èƒ½æ…è¿™ä¹ˆå¤§çš„ç¯“å­ï¼Œå®Œå…¨ä¸ç§‘å­¦ã€‚è¿™ä¸ªBUGè¶Šæ¥è¶Šæœ‰æ„æ€äº†ğŸ¤” æ—¢ç„¶å¼‚å¸¸ä¸Šçœ‹ä¸å‡ºæ¥ä»€ä¹ˆå¤´ç»ªé‚£å°±è¦ä»ä»£ç å…¥æ‰‹äº†ã€‚æ‰¾diffçš„æ—¶å€™å‘ç°Bç‰ˆæœ¬æ²¡æœ‰æ‰“tagã€‚ æ²¡æ‰“tagä¸ç®—å¤§é—®é¢˜ï¼Œå¤šèŠ±äº†äº›æ—¶é—´æˆåŠŸæ‰¾åˆ°äº†é‚£ä¸ªcommitï¼Œä½†æ˜¯å¿ƒæƒ…æœ‰ç‚¹ä¸çˆ½ã€‚ diffçš„ä»£ç ä¸å¤šã€‚æ’é™¤æ‰æ— å…³çš„æ–‡ä»¶å°±åªå‰©ä¸‹ä¸€äº›å¸ƒå±€æ–‡ä»¶æ¯”è¾ƒå¯ç–‘ã€‚æ”¹æµç¨‹ï¼Œä¾æ¬¡è·³è¿‡è¿™äº›é¡µé¢ï¼Œå‘ç°ä¸€è·³åˆ°ç™»å½•é¡µé¢å°±æŒ‚äº†ã€‚ç™»å½•é¡µé¢çš„diffæœ‰ç‚¹å¤šï¼ŒäºŒåˆ†åˆ é™¤å¾ˆå¿«å°±å®šä½åˆ°äº†é—®é¢˜çš„æ ¹æº:ImageButtonã€‚ ImageButtonæ˜¯ä¸ªåœ¨æ™®é€šã€é¼ æ ‡æ‚¬åœã€è¢«æŒ‰ä¸‹ä¸‰ç§ä¸åŒçŠ¶æ€æ—¶æ˜¾ç¤ºä¸åŒçš„å›¾ç‰‡çš„æŒ‰é’®ã€‚ ImageButton.cs: 123456789101112131415161718192021222324252627282930313233343536using System.Windows;using System.Windows.Controls;using System.Windows.Media;namespace Debugging&#123; public class ImageButton : Button &#123; public ImageSource Source &#123; get &#123; return (ImageSource)GetValue(SourceProperty); &#125; set &#123; SetValue(SourceProperty, value); &#125; &#125; public static readonly DependencyProperty SourceProperty = DependencyProperty.Register(\"Source\", typeof(ImageSource), typeof(ImageButton), new PropertyMetadata(null)); public ImageSource MouseOverImage &#123; get &#123; return (ImageSource)GetValue(MouseOverImageProperty); &#125; set &#123; SetValue(MouseOverImageProperty, value); &#125; &#125; public static readonly DependencyProperty MouseOverImageProperty = DependencyProperty.Register(\"MouseOverImage\", typeof(ImageSource), typeof(ImageButton), new PropertyMetadata(null)); public ImageSource PressedImage &#123; get &#123; return (ImageSource)GetValue(PressedImageProperty); &#125; set &#123; SetValue(PressedImageProperty, value); &#125; &#125; public static readonly DependencyProperty PressedImageProperty = DependencyProperty.Register(\"PressedImage\", typeof(ImageSource), typeof(ImageButton), new PropertyMetadata(null)); &#125;&#125; ImageButton.xaml: 1234567891011121314151617181920212223&lt;ResourceDictionary xmlns=\"http://schemas.microsoft.com/winfx/2006/xaml/presentation\" xmlns:x=\"http://schemas.microsoft.com/winfx/2006/xaml\" xmlns:local=\"clr-namespace:Debugging\"&gt; &lt;Style TargetType=\"local:ImageButton\"&gt; &lt;Setter Property=\"Template\"&gt; &lt;Setter.Value&gt; &lt;ControlTemplate TargetType=\"local:ImageButton\"&gt; &lt;Grid&gt; &lt;Image x:Name=\"image\" Source=\"&#123;TemplateBinding Source&#125;\" /&gt; &lt;/Grid&gt; &lt;ControlTemplate.Triggers&gt; &lt;Trigger Property=\"IsMouseOver\" Value=\"True\"&gt; &lt;Setter TargetName=\"image\" Property=\"Source\" Value=\"&#123;Binding RelativeSource=&#123;RelativeSource TemplatedParent&#125;, Path=MouseOverImage&#125;\" /&gt; &lt;/Trigger&gt; &lt;Trigger Property=\"IsPressed\" Value=\"True\"&gt; &lt;Setter TargetName=\"image\" Property=\"Source\" Value=\"&#123;Binding RelativeSource=&#123;RelativeSource TemplatedParent&#125;, Path=PressedImage&#125;\" /&gt; &lt;/Trigger&gt; &lt;/ControlTemplate.Triggers&gt; &lt;/ControlTemplate&gt; &lt;/Setter.Value&gt; &lt;/Setter&gt; &lt;/Style&gt;&lt;/ResourceDictionary&gt; ç™»é™†é¡µé¢ä¸­æ˜¯è¿™æ ·ä½¿ç”¨ImageButtonçš„:123....&lt;ImageButton Source=\"&#123;StaticResource SomeImage&#125;\" MouseOverImage=\"&#123;StaticResouce SomeOtherImage&#125;\" PressedImage=\"&#123;StaticResources AnotherImage&#125;\" /&gt;.... æŠŠSource=&quot;{StaticResource SomeImage}&quot;è¿™ä¸€å¥å»æ‰å°±æ­£å¸¸äº†ã€‚ä¼¼ä¹å®ƒå°±æ˜¯ç½ªé­ç¥¸é¦–ã€‚ä½†æ˜¯ï¼ŒæŠŠè¿™éƒ¨åˆ†ä»£ç å’Œå›¾ç‰‡æ‹¿å‡ºæ¥æ”¾åˆ°å¦ä¸€ä¸ªç¨‹åºé‡Œå´åˆä¸€åˆ‡æ­£å¸¸ã€‚ è½¬æœºæ¥ä¸‹æ¥åˆå°è¯•äº† æŠŠImageButtonæ›¿æ¢ä¸ºImage æŠŠTemplate.Triggerå»æ‰ æŠŠSomeImageæŒ‡å‘å…¶ä»–å›¾ç‰‡ ä½†æ˜¯è¿˜æ˜¯æ‰¾ä¸åˆ°root causeã€‚ä¸€æ¨¡ä¸€æ ·çš„ä»£ç ä¸èƒ½åœ¨å…¶ä»–ç¨‹åºå¤ç°ï¼Œé‚£å°±è¯´æ˜BUGæ˜¯æˆ‘ä»¬ç¨‹åºè‡ªå·±é€ æˆçš„ã€‚ä½†æ˜¯è¿™ä¸ªBUGåªåœ¨Windows 8.1ä¸‹å‡ºç°ï¼Œè¯´æ˜è·Ÿç¯å¢ƒä¹Ÿæœ‰å¯èƒ½æœ‰å…³ç³»ã€‚è·ç¦»å‘ç°BUGå·²ç»è¿‡å»ä¸€å¤©åŠäº†ï¼Œæ”¾å¼ƒçš„è¯å®åœ¨æ˜¯ä¸ç”˜å¿ƒï¼Œæ¥ä¸‹æ¥åªèƒ½çŒœäº†ã€‚ å †æ ˆé‡Œæ˜¾ç¤ºç¨‹åºæŒ‚åœ¨WPFçš„ç¨‹åºé›†é‡Œï¼ŒåŸºäºè¿™ä¸ªç°è±¡å†³å®šretargetåˆ°.NET Frameworkçš„æœ€æ–°ç‰ˆæœ¬4.7.2ã€‚ç¼–è¯‘æ‰“åŒ…éƒ¨ç½²ä¸€å¥—æµç¨‹èµ°å®Œï¼Œåœ¨è¿è¡Œçš„æ—¶å€™å‘ç°Windows 8.1æ²¡æœ‰å®‰è£….NET Framework 4.7.2ã€‚å¥½å§ï¼Œé‚£å°±è£…ã€‚å¯æ˜¯å®‰è£…åŒ…å‘Šè¯‰æˆ‘ä¸æ»¡è¶³æ¡ä»¶ï¼š éœ€è¦å®‰è£…KB2919355ï¼Ÿ å¾®è½¯æ¥èƒŒé”…åœ¨å¾®è½¯çš„æ”¯æŒç½‘ç«™ä¸Šè¯¦ç»†åˆ—å‡ºäº†KB2919355çš„change logã€‚ä»¥imageä¸ºå…³é”®å­—CTRL+Få‘ç°è¿™æ ·çš„æè¿°ï¼š Article number Article Title 2929755 Out of memory when you load some image resources in a Windows application æˆ‘å»ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬é‡åˆ°çš„é—®é¢˜ã€‚ å¯¹åº”çš„é¡µé¢ç»™å‡ºçš„æè¿°ï¼š Symptoms When you load some image resources in an application such as Microsoft Visual Studio on a computer that has Windows 8.1, Windows Server 2012 R2, Windows 8, Windows Server 2012, Windows 7, or Windows Server 2008 R2 installed, the application stops responding and memory leaks in Windows. This issue occurs after you install the following update:2670838 Platform update for Windows 7 SP1 and Windows Server 2008 R2 SP1 File Information For all supported x86-based versions of Windows 8: File name File version File size Date Time Platform Windowscodecs.dll 6.2.9200.16809 1,339,392 31-Jan-2014 00:48 x86 Windowscodecs.dll 6.2.9200.20930 1,319,936 31-Jan-2014 06:04 x86 è¿™ä¸ªBUGæ˜¯KB2670838å¼•å…¥çš„ã€‚åœ¨2670838çš„æ›´æ–°ä¸­,å¾®è½¯æ›´æ–°äº†ç°æœ‰çš„Windows Imaging Component (WIC) This update improves the range and performance of the following graphics and imaging components: Windows Imaging Component (WIC) æˆ‘ä»¬åœ¨diffé‡Œé‡ç‚¹å…³æ³¨äº†Imageç›¸æ›´æ”¹ï¼Œå‘ç°æ”¹äº†è¿™ä¹ˆä¸€è¡Œï¼š 123456&lt;Application.Resources&gt; &lt;Style TargetType=\"Image\"&gt; &lt;Setter Property=\"RenderOptions.BitmapScalingMode\" Value=\"Fant\" /&gt; &lt;/Style&gt;&lt;/Application.Resources&gt; RenderOptons.BitmapScalingModeæŒ‡æ˜åœ¨éœ€è¦ç¼©æ”¾æ—¶ä½¿ç”¨çš„ç®—æ³•ã€‚Fantæ˜¯è´¨é‡æœ€é«˜çš„ä¸€ç§ä¹‹ä¸€ã€‚å°è¯•Fantæ”¹ä¸ºLinearåç¨‹åºæ­£å¸¸è¿è¡Œã€‚ç»§ç»­å°è¯•å…¶ä»–çš„å€¼ï¼Œå‘ç°é™¤äº†Linearå’ŒUnspecifiedéƒ½ä¼šå´©æºƒã€‚ åŸå› åˆ†æåœ¨KB2670838é‡Œçš„WICåœ¨ç‰¹å®šæƒ…å†µä¼šOOMçˆ†æ‰ã€‚WPFé‡Œçš„BitmapScalingMode.Fantä¾èµ–WICå®ç°ï¼Œåœ¨è£…äº†KB2670838çš„ç¯å¢ƒé‡Œè·Ÿå°±ä¼šè·ŸWICä¸€èµ·OOMçˆ†æ‰ï¼›å¾®è½¯åœ¨åæ¥å‘è¡Œçš„KB2919355ä¸­ä¿®å¤äº†è¿™ä¸ªBUGã€‚ æˆ‘ä»¬çš„æµ‹è¯•æœºçš„Windowsç³»ç»Ÿç”±RTMçš„é•œåƒå®‰è£…å¹¶ä¸”å…³é—­äº†è‡ªåŠ¨æ›´æ–°ã€‚åœ¨Windows 8.1ä¹‹å‰çš„RTMé•œåƒæ²¡æœ‰è‡ªå¸¦KBB2670838ï¼Œåœ¨Windows 8.1ä¹‹åRTMé•œåƒè‡ªå¸¦äº†KB2919355ã€‚ååè¿™ä¸ªWindows 8.1çš„RTMé•œåƒå†…ç½®äº†KB2670838è€Œæ²¡æœ‰å†…ç½®KB2919355ï¼Œç¨‹åºå°±è¿™æ ·æ­»äºOOMã€‚ éªŒè¯Windowscodecs.dllçš„ç‰ˆæœ¬ä¹Ÿæ”¯æŒè¿™ä¸ªç»“è®ºã€‚ æ€»ç»“ å®šä½ç¯å¢ƒé—®é¢˜çš„æ—¶å€™è¦æ§åˆ¶å˜é‡ äºŒåˆ†æ³•èƒ½å¿«é€Ÿå®šä½å‡ºé”™çš„ä½ç½® æ‰“å¥½Tagå¾ˆé‡è¦ ä¸€ç›´ä»¥æ¥ä¾èµ–çš„åº•å±‚ä¹Ÿä¼šæœ‰BUGã€‚å¤§èƒ†è´¨ç–‘ï¼Œå°å¿ƒæ±‚è¯ã€‚ è¯¥ç”©é”…çš„æ—¶å€™è¦æœæ–­çš„ç”©ç»™å¾®è½¯ ReferenceWPF Architecture - docs.microsoft.com WPF ToolTip Rendering Issue : Application Hang - social.msdn.microsoft.com Windows RT 8.1, Windows 8.1, and Windows Server 2012 R2 update: April 2014 - support.microsoft.com Platform update for Windows 7 SP1 and Windows Server 2008 R2 SP1 - support.microsoft.com Windows Imaging Component - msdn.microsoft.com","categories":[],"tags":[{"name":"C#","slug":"C","permalink":"https://verrickt.github.io/tags/C/"},{"name":"Debugging","slug":"Debugging","permalink":"https://verrickt.github.io/tags/Debugging/"},{"name":"WPF","slug":"WPF","permalink":"https://verrickt.github.io/tags/WPF/"}]},{"title":"é—­åŒ…ï¼Œå˜é‡æ•è·ä¸é‡å…¥é—®é¢˜","slug":"closure-and-re-entrance","date":"2018-03-08T11:59:20.000Z","updated":"2018-08-04T08:26:21.220Z","comments":true,"path":"2018/03/08/closure-and-re-entrance/","link":"","permalink":"https://verrickt.github.io/2018/03/08/closure-and-re-entrance/","excerpt":"é—®é¢˜æè¿°å…¬å¸çš„APPï¼Œåœ¨æ–­ç½‘åè¿›è¡Œä¸€ä¸ª10ç§’çš„å€’è®¡æ—¶æ“ä½œï¼Œæ¯ç§’é’Ÿéƒ½ä¼šå°è¯•é‡æ–°è”ç½‘ã€‚å½“ç§’æ•°åˆ°0æ—¶åˆé‡æ–°å¼€å§‹è®¡æ—¶ï¼Œå€’è®¡æ—¶åœ¨ç”¨æˆ·é€€å‡ºç¨‹åºæˆ–è€…è¿ä¸Šç½‘ç»œç»“æŸã€‚ æŒ‰ç†è¯´æ˜¯ä¸ªå¾ˆç®€å•çš„Caseã€‚QAå´æŠ¥è¿‡æ¥ä¸ªBUGï¼Œè¯´APPçŠ¶æ€ç”± è”ç½‘-&gt;æ–­ç½‘-&gt;è”ç½‘-&gt;æ–­ç½‘ å˜åŒ–åï¼Œå€’è®¡æ—¶çš„ç§’æ•°å˜ä¸º 9 3 8 2 7 1 å˜å¾—ä¸è¿ç»­äº†ã€‚","text":"é—®é¢˜æè¿°å…¬å¸çš„APPï¼Œåœ¨æ–­ç½‘åè¿›è¡Œä¸€ä¸ª10ç§’çš„å€’è®¡æ—¶æ“ä½œï¼Œæ¯ç§’é’Ÿéƒ½ä¼šå°è¯•é‡æ–°è”ç½‘ã€‚å½“ç§’æ•°åˆ°0æ—¶åˆé‡æ–°å¼€å§‹è®¡æ—¶ï¼Œå€’è®¡æ—¶åœ¨ç”¨æˆ·é€€å‡ºç¨‹åºæˆ–è€…è¿ä¸Šç½‘ç»œç»“æŸã€‚ æŒ‰ç†è¯´æ˜¯ä¸ªå¾ˆç®€å•çš„Caseã€‚QAå´æŠ¥è¿‡æ¥ä¸ªBUGï¼Œè¯´APPçŠ¶æ€ç”± è”ç½‘-&gt;æ–­ç½‘-&gt;è”ç½‘-&gt;æ–­ç½‘ å˜åŒ–åï¼Œå€’è®¡æ—¶çš„ç§’æ•°å˜ä¸º 9 3 8 2 7 1 å˜å¾—ä¸è¿ç»­äº†ã€‚ æ€è€ƒäº†ä¸€ä¸‹ï¼Œè§‰å¾—åº”è¯¥æ˜¯ç¬¬ä¸€æ¬¡å€’è®¡æ—¶çš„æ²¡æœ‰é€€å‡ºï¼Œç¬¬äºŒæ¬¡å€’è®¡æ—¶å¼€å§‹åä¸¤è€…éƒ½å¼€å§‹æ›´æ–°UIã€‚ çœ‹äº†ä»£ç ï¼Œæœç„¶æ˜¯è¿™æ ·çš„ 123456789101112131415161718192021222324void OnIPChanged()&#123; ShowOfflineUI();&#125;void ShowOfflineUI()&#123; Task.Factory.Start(delegate &#123; int i = 10; while(true) &#123; i = (i-1)%10; Invoke(UpdateCountDown(i))//update UI on UI thread try &#123; Thread.Sleep(TimeSpan.FromSeconds(1)) if(Connect()) &#123; break; &#125; &#125; &#125; &#125;)&#125; åœ¨ç¬¬äºŒæ¬¡è§¦å‘å€’è®¡æ—¶çš„æ—¶å€™åŸæ¥çš„å€’è®¡æ—¶è¿˜åœ¨ç»§ç»­ï¼Œå³ï¼Œä¸¤ä¸ªå€’è®¡æ—¶åŒæ—¶æ‰§è¡Œæ˜¯ä¸å®‰å…¨çš„ã€‚è¿™æ˜¯å…¸å‹çš„é‡å…¥é—®é¢˜) è¯´å®è¯æˆ‘ä¸æ˜¯å¾ˆå–œæ¬¢ç›´æ¥ç”¨Thread.Sleepæ¥åšæ“ä½œï¼Œè¿™æ ·å ç”¨äº†ä¸€ä¸ªçº¿ç¨‹å¿™ç­‰ï¼Œæµªè´¹äº†èµ„æºã€‚C#ä¸­ä¸€èˆ¬é‡‡ç”¨åŸºäºTaskçš„å¼‚æ­¥ç¼–ç¨‹æ¥åšï¼Œè¿™æ ·ä¸ä¼šæµªè´¹èµ„æºã€‚Taskæä¾›çš„CancellationTokenèƒ½å¤Ÿæ¯”è¾ƒå®¹æ˜“çš„å®ç°å–æ¶ˆã€‚æ”¾åˆ°è¿™ä¸ªCaseé‡Œï¼Œåªè¦å¼€å§‹å€’è®¡æ—¶çš„æ—¶å€™å–æ¶ˆä¸Šä¸€æ¬¡çš„å€’è®¡æ—¶å°±å¥½äº†ã€‚ è¯´å¹²å°±å¹²,æˆ‘æœ€å–œæ¬¢ç”¨Taské‡å†™åŸºäºThreadçš„å¹¶å‘/å¼‚æ­¥äº† 12345678910111213141516171819202122232425262728TaskCancellationToken _cts;void OnIPChanged()&#123; ShowOfflineUI(); ShowOfflineUI();&#125;async Task ShowOfflineUI()&#123; _cts?.Cancel(); _cts = new CancellationToken(); await Task.Run( async ()=&gt; &#123; int i = 0; while(true) &#123; i = (i-1)%10; Invoke(UpdateCountDown(i)); await Task.Delay(TimeSpan.FromSeconds(1),_cts.Token); if(Connect()) &#123; break; &#125; &#125; &#125; );&#125; ä¸ºäº†éªŒè¯æ–¹æ³•çš„æ­£ç¡®æ€§ï¼Œæˆ‘ç‰¹åœ°åœ¨OnIPChanged()è°ƒç”¨äº†ä¸¤æ¬¡ShowOfflineUI()ã€‚ä½†æ˜¯ç¬¬ä¸€ä¸ªTaskå¹¶æ²¡æœ‰è¢«å–æ¶ˆã€‚ åˆ†æé—®é¢˜å†™å‡ºäº†è·Ÿè‡ªå·±é¢„æœŸä¸ä¸€æ ·çš„ä»£ç æ€ä¹ˆåŠï¼Ÿå½“ç„¶æ˜¯ä¸ŠDebuggeräº†ã€‚åœ¨Debuggerçš„ç«çœ¼é‡‘ç›ä¸‹ï¼Œæˆ‘å¾ˆå¿«æ³¨æ„åˆ°äº†æœ€æ˜æ˜¾çš„ç°è±¡ï¼šåœ¨ç¬¬äºŒæ¬¡è°ƒç”¨ShowOfflineUIçš„æ—¶å€™ï¼Œ_cts.Cancel()å¹¶æ²¡æœ‰æŠŠç¬¬ä¸€ä¸ªTaskä¸­çš„CancellationTokençš„IsCancellationRequestå˜ä¸ºTrueã€‚è®¡ç®—æœºç§‘å­¦é‡Œæœ‰å¥è€è¯ï¼Œé‚£å°±æ˜¯æ°¸è¿œä¸è¦æ€€ç–‘è¿‘30å¹´å†…ç¼–è¯‘å™¨çš„æ­£ç¡®æ€§ã€‚ç»è¿‡æ•°ååˆ†é’Ÿçš„æ’(è°·)æŸ¥(æ­Œ)å®šä½äº†é—®é¢˜çš„åŸå› :ä¸¤ä¸ªTaskå¼•ç”¨çš„_ctsæ˜¯åŒä¸€ä¸ªã€‚ åŸå› å‰–æå¦‚æœä¸€ä¸ªåŒ¿åå‡½æ•°å¼•ç”¨äº†ä¸å±äºä»–è‡ªå·±çš„å±€éƒ¨å˜é‡ï¼Œé‚£ä¹ˆè¿™ä¸ªç°è±¡å°±ç§°ä¸ºé—­åŒ…ã€‚å› ä¸ºè¿™å®åœ¨æ˜¯å¤ªè‡ªç„¶äº†æ‰€ä»¥æˆ‘æ‰æ²¡å¾€è¿™ä¸Šé¢æƒ³ã€‚åœ¨ç»™Task.Runä¸­ï¼Œæˆ‘ä¼ å…¥äº†ä¸€ä¸ªActionç±»å‹çš„å‡½æ•°ï¼Œå®ƒæ•è·äº†å¤–éƒ¨å˜é‡_ctsã€‚åœ¨å‡½æ•°ä¸­æ¯æ¬¡ç”¨åˆ°_ctsçš„æ—¶å€™ï¼Œè¢«æ•è·çš„å˜é‡çš„å€¼è¢«é‡æ–°è®¡ç®—ï¼Œç»“æœä½œä¸ºå®é™…çš„å€¼ã€‚è€Œæˆ‘çš„æœ¬æ„æ˜¯è®©ä¸¤ä¸ªTaskæ‹¥æœ‰ä¸åŒçš„_ctsï¼Œè¿™æ ·åè¾¹çš„Taskå°±å¯ä»¥å–æ¶ˆå‰è¾¹çš„Taskäº†ã€‚æ˜ç™½äº†è¿™äº›åå°±å¾ˆå¥½æ”¹äº†ï¼Œåœ¨ShowOfflineUIé‡Œæ”¾ä¸€ä¸ªå±€éƒ¨å˜é‡ï¼Œå­˜å‚¨_ctsçš„å€¼ï¼Œè®©åŒ¿åå‡½æ•°æ•è·è¿™ä¸ªå±€éƒ¨å˜é‡å°±å¥½äº†1234567891011121314151617181920212223async Task ShowOfflineUI()&#123; var local = _cts; local?.Cancel(); _cts = new CancellationToken(); await Task.Run( async ()=&gt; &#123; int i = 0; while(true) &#123; i = (i-1)%10; Invoke(UpdateCountDown(i)); await Task.Delay(TimeSpan.FromSeconds(1),local?.Token??CancellationToken.None); if(Connect()) &#123; break; &#125; &#125; &#125; );&#125; æœ‰å…´è¶£çš„æœ‹å‹å¯ä»¥çŒœä¸€çŒœè¿™ä¸¤æ®µä»£ç çš„ç»“æœï¼Œå†è¿è¡ŒéªŒè¯ä¸€ä¸‹ 123456789101112131415161718public void NonLocal()&#123; List&lt;Action&gt; actions = new List&lt;Action&gt;(); for(int i=0 ;i&lt;10;i++) actions.Add(()=&gt;Console.WriteLine(i)); actions.ForEach(a=&gt;a());&#125;public void Local()&#123; List&lt;Action&gt; actions = new List&lt;Action&gt;(); for(int i=0 ;i&lt;10;i++) &#123; int j = i; actions.Add(()=&gt;Console.WriteLine (j)); &#125; actions.ForEach(a=&gt;a());&#125; ç›¸ä¿¡åå­—å°±ç»™å¤§å®¶è¶³å¤Ÿå¤šçš„æç¤ºäº† æœ€åç¥ä½ èº«ä½“å¥åº·ï¼Œå†è§","categories":[],"tags":[{"name":"Reentrance","slug":"Reentrance","permalink":"https://verrickt.github.io/tags/Reentrance/"},{"name":"async/await","slug":"async-await","permalink":"https://verrickt.github.io/tags/async-await/"},{"name":"lambda","slug":"lambda","permalink":"https://verrickt.github.io/tags/lambda/"}]},{"title":"HTTPClient è¸©å‘è®°","slug":"httpclient-good-part-and-tipfalls","date":"2017-10-24T11:43:28.000Z","updated":"2018-08-02T15:04:19.455Z","comments":true,"path":"2017/10/24/httpclient-good-part-and-tipfalls/","link":"","permalink":"https://verrickt.github.io/2017/10/24/httpclient-good-part-and-tipfalls/","excerpt":"HttpClientæ˜¯éšç€.Net framework 4.5ä¸€èµ·å‘å¸ƒçš„ç°ä»£Httpåº“ã€‚æ¯”èµ·WebClientï¼ŒHttpClientæœ€å¤§çš„ä¼˜ç‚¹å°±æ˜¯åŠ å…¥äº†C#5ä¸­çš„async/awaitå¼‚æ­¥æ–¹æ³•çš„æ”¯æŒã€‚async/awaitçš„å‘æš‚ä¸”ä¸è¡¨ï¼Œä»Šå¤©å°±æ¥è¯´ä¸€è¯´è¿™ä¸ªHttpClient HttpClientçš„å‘HttpClientå®ç°äº†IDisposableæ¥å£ï¼Œå¾ˆå¤šå°ä¼™ä¼´ä¸€çœ‹åˆ°IDisposeableæ¥å£å°±çº·çº·æŠŠHttpClientå¥—åœ¨äº†usingé‡Œè¾¹ 12345//bad httpclient usageusing(var client = new HttpClient())&#123; //do stuffs&#125; è¿™ç§ç”¨æ³•æ˜¯é”™è¯¯çš„.HttpClientåœ¨è®¾è®¡ä¹‹åˆè¢«è®¾è®¡ä¸ºä¸€ä¸ªå¯é‡ç”¨çš„å¯¹è±¡ï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸåº”è¯¥ä¸åº”ç”¨ç¨‹åºç›¸ä¸€è‡´.ä¸Šè¿°é”™è¯¯çš„ç”¨æ³•æ¯å‘èµ·ä¸€ä¸ªè¯·æ±‚å°±ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„HttpClientï¼Œå¹¶ä¸”åœ¨æ”¶åˆ°å›å¤ä¹‹åç«‹å³æŠŠHttpClient disposeæ‰ã€‚ä¼—æ‰€å‘¨çŸ¥TCPè¿æ¥åœ¨çœŸæ­£æ–­å¼€ä¹‹å‰ä¼šæœ‰å‡ åˆ†é’Ÿå¤„äºCLOSE_WAITçŠ¶æ€ã€‚è¿™ä¸ªçŠ¶æ€ä¸‹TCPé“¾æ¥å¹¶æ²¡æœ‰çœŸæ­£æ–­å¼€ã€‚çŸ­æ—¶é—´å†…å¤§é‡å‘å‡ºHttpè¯·æ±‚ä¼šä½¿ç³»ç»Ÿå¯ç”¨çš„ç«¯å£æ€¥å‰§æ¶ˆè€—ã€‚","text":"HttpClientæ˜¯éšç€.Net framework 4.5ä¸€èµ·å‘å¸ƒçš„ç°ä»£Httpåº“ã€‚æ¯”èµ·WebClientï¼ŒHttpClientæœ€å¤§çš„ä¼˜ç‚¹å°±æ˜¯åŠ å…¥äº†C#5ä¸­çš„async/awaitå¼‚æ­¥æ–¹æ³•çš„æ”¯æŒã€‚async/awaitçš„å‘æš‚ä¸”ä¸è¡¨ï¼Œä»Šå¤©å°±æ¥è¯´ä¸€è¯´è¿™ä¸ªHttpClient HttpClientçš„å‘HttpClientå®ç°äº†IDisposableæ¥å£ï¼Œå¾ˆå¤šå°ä¼™ä¼´ä¸€çœ‹åˆ°IDisposeableæ¥å£å°±çº·çº·æŠŠHttpClientå¥—åœ¨äº†usingé‡Œè¾¹ 12345//bad httpclient usageusing(var client = new HttpClient())&#123; //do stuffs&#125; è¿™ç§ç”¨æ³•æ˜¯é”™è¯¯çš„.HttpClientåœ¨è®¾è®¡ä¹‹åˆè¢«è®¾è®¡ä¸ºä¸€ä¸ªå¯é‡ç”¨çš„å¯¹è±¡ï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸåº”è¯¥ä¸åº”ç”¨ç¨‹åºç›¸ä¸€è‡´.ä¸Šè¿°é”™è¯¯çš„ç”¨æ³•æ¯å‘èµ·ä¸€ä¸ªè¯·æ±‚å°±ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„HttpClientï¼Œå¹¶ä¸”åœ¨æ”¶åˆ°å›å¤ä¹‹åç«‹å³æŠŠHttpClient disposeæ‰ã€‚ä¼—æ‰€å‘¨çŸ¥TCPè¿æ¥åœ¨çœŸæ­£æ–­å¼€ä¹‹å‰ä¼šæœ‰å‡ åˆ†é’Ÿå¤„äºCLOSE_WAITçŠ¶æ€ã€‚è¿™ä¸ªçŠ¶æ€ä¸‹TCPé“¾æ¥å¹¶æ²¡æœ‰çœŸæ­£æ–­å¼€ã€‚çŸ­æ—¶é—´å†…å¤§é‡å‘å‡ºHttpè¯·æ±‚ä¼šä½¿ç³»ç»Ÿå¯ç”¨çš„ç«¯å£æ€¥å‰§æ¶ˆè€—ã€‚ MSçš„äººæ¨èé‡ç”¨HttpClientä»¥ä½¿å…¶ç”Ÿå‘½å‘¨æœŸä¸åº”ç”¨ç›¸åŒ 1234567891011//good httpclient usageclass GoodHttpClientSample&#123; private static readonly HttpClient client = new HttpClient(); public Task&lt;string&gt; GetStringAsync(string url) &#123; var resposne = await client.GetAsync(url).ConfigureAwait(false); return response.Content.ReadAsStringAsync(); &#125; &#125; HttpClientçš„ä¼˜ç‚¹è¸©è¿‡äº†å‘æˆ‘ä»¬å†æ¥è¯´è¯´ä»–çš„å¥½å¤„ã€‚å»æ‰async/awaitæ”¯æŒè¿™ä¸ªæœ€å¤§çš„æœ‰ç‚¹ï¼ŒHttpClientçš„ä¸€ä¸ªæ„é€ å‡½æ•°çš„é‡è½½æ¥å—ä¸€ä¸ªHttpMessageHandlerã€‚è¿™ä¸ªé‡è½½å¾ˆæœ‰æ„æ€ã€‚HttpMessageHandlerå¯ä»¥åœ¨å‘å‡ºHttpè¯·æ±‚å’Œæ¥å—Httpå›å¤æ—¶åšå‡ºä¸€äº›å›åº”ã€‚.net frameworké‡Œæœ‰ä¸€ä¸ªç±»å«åšDelegatingHandlerï¼Œå®ƒç»§æ‰¿äº†HttpMessageHandlerã€‚å«åšDelegatingHandleræ˜¯å› ä¸ºå®ƒæœ‰ä¸ªç±»å‹ä¸ºHttpMessageHandlerçš„InnerHandlerå±æ€§ï¼Œå› è€Œå¯ä»¥æŠŠè¯·æ±‚delegateç»™InnerHandlerã€‚é€šè¿‡è¿™ä¸ªDelegatingHandleræˆ‘ä»¬å¯ä»¥è¯·ä»¥å®ç°åƒJava webé‡Œçš„filter chainä¸€æ ·çš„é€»è¾‘ã€‚ ä»Šå¤©é‡æ„äº†å…¬å¸çš„ä»£ç ã€‚å…¬å¸ç°æœ‰çš„HttpManageræä¾›äº†GETå’ŒPOSTä¸¤ç§HttpåŠ¨è¯çš„å¼‚æ­¥æ–¹æ³•ã€‚åœ¨è¿™äº›æ–¹æ³•ä¸­è¿˜è¿›è¡Œäº†æ—¥å¿—è®°å½•å’Œå¤±è´¥é‡è¯•ã€‚æ—¥å¿—è®°å½•å’Œå¤±è´¥é‡è¯•ç›¸å…³çš„ä»£ç éå¸¸é‡å¤ï¼Œä½†æ˜¯åˆæ— æ³•å†™æˆä¸€ä¸ªå‡½æ•°ã€‚å› æ­¤æˆ‘æŠŠè¿™éƒ¨åˆ†é€»è¾‘æŠ½å‡ºæ¥åšæˆäº†ä¸¤ä¸ªDelegatingHandler 12345678910111213141516171819202122232425class LogHandler:DelegatingHandler&#123; private readonly ILog _log; public LogHandler(ILog log,HttpMessageHandler handler):base(handler) &#123; _log = log; &#125; protected async override Task&lt;HttpResponseMessage&gt; SendAsync(HttpRequestMessage request, CancellationToken cancellationToken) &#123; try &#123; var begin = DateTime.Now; _log.I($\"&#123;request.Method&#125; -&gt;&#123;request.RequestUri&#125;\"); var response = await base.SendAsync(request,cancellationToken); var end = DateTime.Now; var diff = (end-begin).TotalMillseconds; _log.I($\"&#123;request.Method&#125; &lt;- &#123;response.Content.ReadAsStringAsync()&#125; cost&#123;diff&#125;ms\"); &#125; catch(Exception e) &#123; _log.E($\"&#123;request.Method&#125; -&gt;&#123;request.RequestUri&#125;,&#123;e&#125;\"); throw; &#125; &#125; 1234567891011121314151617181920212223242526272829303132333435class RetryHandler:DelegatingHandler&#123; protected async override Task&lt;HttpResponseMessage&gt; SendAsync(HttpRequestMessage request,CancellationToken cancellationToken) &#123; HttpResponseMessage response = null; for(int i=0;i&lt;=_retryTimes,i++) &#123; try &#123; response = await base.SendAsync(request,cancellationToken); return response; &#125; catch(Exception) &#123; if(i==_retryTimes) &#123; throw; &#125; &#125; //make compiler happy. return response; &#125; &#125; private readonly int _retryTimes = 0; public RetryHandler(int retryTimes,HttpMessageHandler handler):base(handler) &#123; if(retryTimes&lt;0) &#123; throw new ArgumentOutOfRangeException(nameof(retryTimes)); &#125; _retryTimes = retryTimes; &#125;&#125; HttpClientHandleræ˜¯ä¸ªçœŸæ­£å®ç°HttpClienté€»è¾‘çš„HttpMessageHandlerã€‚å› æ­¤ï¼Œæˆ‘ä»¬åªè¦ä¿è¯æœ€å†…éƒ¨çš„Handleræ—¶HttpClientHandlerå°±OKäº†ã€‚ 1234private static readonly ILog _log;private static readonly HttpClient _client = new HttpClient(new RetryHandler(3,new LogHandler(_log,new HttpClientHandler()))); éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœHttpHandleræ²¡æœ‰è¿”å›HttpResponseMessage,å¯¹åº”çš„å¼‚æ­¥æ–¹æ³•ä¼šåœ¨è¿è¡Œæ—¶æŠ›å‡ºInvalidOperationException é‡æ„ä¹‹åæ•´ä¸ªHttpå°è£…ç±»çš„ä»£ç è¡Œæ•°ä»400è¡Œå‡å°‘åˆ°äº†120è¡Œå·¦å³ï¼Œå¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§æå‡æ˜¾è‘—ã€‚ Further readingFUN WITH THE HTTPCLIENT PIPELINE YOUâ€™RE USING HTTPCLIENT WRONG AND IT IS DESTABILIZING YOUR SOFTWARE Do HttpClient and HttpClientHandler have to be disposed?","categories":[],"tags":[{"name":"C#","slug":"C","permalink":"https://verrickt.github.io/tags/C/"},{"name":"HttpClient","slug":"HttpClient","permalink":"https://verrickt.github.io/tags/HttpClient/"}]}]}