{"meta":{"title":"Melchior on CLR","subtitle":"Verrickt as a Programmer","description":"A programmer focus mainly on Microsoft Technologies","author":"Verrickt","url":"https://verrickt.github.io"},"pages":[{"title":"About","date":"2018-08-04T09:08:39.000Z","updated":"2018-08-04T09:18:10.589Z","comments":true,"path":"about/index.html","permalink":"https://verrickt.github.io/about/index.html","excerpt":"","text":"ç¨‹åºå‘˜ã€‚ å…³é”®è¯ï¼š Windows desktop C# XAML UWP WPF GNU/Linux 1public string ğŸ“§=&gt;\"von@hohm.in\";"}],"posts":[{"title":"Build a (partial) self-contained WPF application","slug":"self-contained-wpf-application","date":"2018-07-31T14:43:47.000Z","updated":"2018-08-03T03:14:31.174Z","comments":true,"path":"2018/07/31/self-contained-wpf-application/","link":"","permalink":"https://verrickt.github.io/2018/07/31/self-contained-wpf-application/","excerpt":"å·¨äººçš„è‚©è†€æ–°äº‹ç‰©çš„äº§ç”Ÿæ€»æ˜¯ä¸è€äº‹ç‰©æœ‰åƒä¸ä¸‡ç¼•çš„è”ç³»ã€‚æˆ–æ˜¯ä»ä¸­å¾—åˆ°å¯å‘ï¼Œæˆ–æ˜¯å¯¹å…¶å…¨é¢æ”¹è‰¯ã€‚æ–°äº‹ç‰©çš„æºå¤´é€šå¸¸å¯ä»¥è¿½æº¯åˆ°å¾ˆä¹…è¿œçš„ä¸€äº›æ¦‚å¿µä¸Šã€‚å› æ­¤æœ‰äº†ã€Œç«™åœ¨å·¨äººçš„è‚©è†€ä¸Šã€ è¿™æ ·çš„è¯´æ³•ã€‚åœ¨ç¨‹åºè®¾è®¡é‡Œé¢ï¼Œã€Œå·¨äººä»¬çš„è‚©è†€ã€ å°±æ˜¯æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä½¿ç”¨çš„åº“äº†ã€‚è¸©åœ¨è¿™äº›ã€Œå·¨äººã€ä»¬çš„è‚©è†€ä¸Šæˆ‘ä»¬çš„ç¨‹åºæ‰å¾—ä»¥é‡è§å¤©æ—¥ï¼›ä¸ºäº†å®ç°ä¸€ä¸ªåº“ï¼Œæœ‰æ—¶å€™ä¼šä½¿ç”¨åˆ°å…¶ä»–çš„åº“ã€‚æˆ‘ä»¬æ‰€ä¾èµ–çš„ã€Œå·¨äººã€åˆè¸©åœ¨äº†å…¶ä»–ã€Œå·¨äººã€çš„è‚©è†€ä¸Šï¼ŒæŠŠä¾èµ–å…³ç³»å˜æˆäº†æ ‘çŠ¶ç»“æ„ï¼Œæˆ‘ä»¬çš„ç¨‹åºå¤„åœ¨æ ¹èŠ‚ç‚¹ã€‚ æ‰¯è¿œäº†:)","text":"å·¨äººçš„è‚©è†€æ–°äº‹ç‰©çš„äº§ç”Ÿæ€»æ˜¯ä¸è€äº‹ç‰©æœ‰åƒä¸ä¸‡ç¼•çš„è”ç³»ã€‚æˆ–æ˜¯ä»ä¸­å¾—åˆ°å¯å‘ï¼Œæˆ–æ˜¯å¯¹å…¶å…¨é¢æ”¹è‰¯ã€‚æ–°äº‹ç‰©çš„æºå¤´é€šå¸¸å¯ä»¥è¿½æº¯åˆ°å¾ˆä¹…è¿œçš„ä¸€äº›æ¦‚å¿µä¸Šã€‚å› æ­¤æœ‰äº†ã€Œç«™åœ¨å·¨äººçš„è‚©è†€ä¸Šã€ è¿™æ ·çš„è¯´æ³•ã€‚åœ¨ç¨‹åºè®¾è®¡é‡Œé¢ï¼Œã€Œå·¨äººä»¬çš„è‚©è†€ã€ å°±æ˜¯æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä½¿ç”¨çš„åº“äº†ã€‚è¸©åœ¨è¿™äº›ã€Œå·¨äººã€ä»¬çš„è‚©è†€ä¸Šæˆ‘ä»¬çš„ç¨‹åºæ‰å¾—ä»¥é‡è§å¤©æ—¥ï¼›ä¸ºäº†å®ç°ä¸€ä¸ªåº“ï¼Œæœ‰æ—¶å€™ä¼šä½¿ç”¨åˆ°å…¶ä»–çš„åº“ã€‚æˆ‘ä»¬æ‰€ä¾èµ–çš„ã€Œå·¨äººã€åˆè¸©åœ¨äº†å…¶ä»–ã€Œå·¨äººã€çš„è‚©è†€ä¸Šï¼ŒæŠŠä¾èµ–å…³ç³»å˜æˆäº†æ ‘çŠ¶ç»“æ„ï¼Œæˆ‘ä»¬çš„ç¨‹åºå¤„åœ¨æ ¹èŠ‚ç‚¹ã€‚ æ‰¯è¿œäº†:) å¼€å‘çš„æ—¶å€™æœ‰åŒ…ç®¡ç†å·¥å…·å¸®æˆ‘ä»¬ç®¡ç†ä¾èµ–ï¼Œè€Œåˆ°äº†åˆ†å‘çš„æ—¶å€™ï¼Œéœ€è¦ä¸€ä¸ªå®¹å™¨æŠŠæˆ‘ä»¬çš„ç¨‹åºå’Œå®ƒçš„ä¾èµ–é¡¹ä¸€èµ·åˆ†å‘ã€‚è¿™å°±éœ€è¦ç”¨åˆ°å®‰è£…ç¨‹åºã€‚æœ€ç»ˆç”¨æˆ·åªè¦æ‹¿åˆ°å®‰è£…ç¨‹åºï¼Œè¿è¡Œå®‰è£…ï¼Œç”±å®‰è£…ç¨‹åºå»æ“å¿ƒä¾èµ–é¡¹åˆ°åº•åº”è¯¥æ”¾åœ¨å“ªã€‚ äººæ˜¯æ‡’æƒ°çš„åŠ¨ç‰©ï¼Œä»ç”¨æˆ·å‘ç°è½¯ä»¶åˆ°çœŸæ­£ç”¨ä¸Šè½¯ä»¶ä¹‹é—´ï¼Œæ¯å¤šä¸€ä¸ªæ­¥éª¤éƒ½ä¼šè®©æŸå¤±ä¸€æ‰¹æ½œåœ¨ç”¨æˆ·ã€‚è€Œç°åœ¨éšç€æ‰‹æœºçš„æµè¡Œï¼Œç”¨æˆ·å·²ç»ä¸æƒ³å®‰è£…äº†ã€‚ä»–ä»¬åªæƒ³ä¸‹è½½ã€Œè½¯ä»¶ã€ï¼ŒåŒå‡»å°±èƒ½ç›´æ¥è¿è¡Œã€‚è‡³äºä»€ä¹ˆå®‰è£…è·¯å¾„ï¼ŒUACæƒé™ä¹‹ç±»çš„ç”¨æˆ·æ‰ä¸æƒ³æ“å¿ƒå‘¢ã€‚ è¿™å°±è¦æ±‚æˆ‘ä»¬çš„ç¨‹åºè¦å°†å®‰è£…è¿™ä¸ªè¿‡ç¨‹éšè—èµ·æ¥ã€‚åœ¨ç”¨æˆ·çœ‹ä¸åˆ°çš„æƒ…å†µä¸‹éƒ¨ç½²è‡ªå·±çš„ä¾èµ–é¡¹ã€‚è¿™æ ·çš„ç¨‹åºåœ¨è‹±æ–‡é‡Œè¢«ç§°ä¸º self-contained self-containedadjective (of a thing) complete, or having all that is needed, in itself. (of a person) quiet and independent; not depending on or influenced by others. è¿™å‡ å¤©æˆ‘ä»¬ä¹Ÿæœ‰äº†å°†æœ€ç»ˆç¨‹åºself-containåŒ–çš„éœ€æ±‚ã€‚ç»ˆäºå¯ä»¥åˆç†çš„æŠ›å¼ƒMFCå†™çš„Installeräº†ğŸ˜ Self-contained in .NET.NETåœ¨è®¾è®¡ä¹‹åˆåªæ˜¯æƒ³æé«˜Windowsç¨‹åºå‘˜çš„å¼€å‘æ•ˆç‡ï¼Œé¡ºä¾¿è§£å†³ä¸€ä¸‹DLL Hellã€‚è‡³äºåº”ç”¨åˆ†å‘æ ¹æœ¬å°±ä¸å†æ—¥ç¨‹ä¸Šã€‚å°±ç®—çœŸçš„è€ƒè™‘è¿‡ï¼Œä¹Ÿä¸€å®šä¼šé‡‡ç”¨åŠ¨æ€é“¾æ¥çš„æ–¹å¼ã€‚å› ä¸ºå½“æ—¶çš„ç¡¬ç›˜è¿˜æ˜¯å¾ˆè´µæ»´ã€‚ æ€»ä¹‹ï¼Œ.NETå°±è¿™æ ·å†³å®šé‡‡ç”¨åŠ¨æ€é“¾æ¥äº†ã€‚.NETé‡Œçš„å‡ ä¸ªåŸºæœ¬æ¦‚å¿µä¹Ÿéƒ½ä¸åŠ¨æ€é“¾æ¥è„±ä¸å¼€å…³ç³»ï¼š ç¨‹åºé›†)æ˜¯.NETä¸–ç•Œé‡Œæœ€å¸¸è§çš„åˆ†å‘å•å…ƒã€‚ç¨‹åºé›†æœ‰ç‹¬ç«‹çš„ç‰ˆæœ¬å·ã€‚åœ¨å¼•ç”¨å…¶ä»–ç¨‹åºé›†çš„æ—¶å€™ï¼Œéœ€è¦æ˜¾å¼æŒ‡æ˜å¯¹åº”çš„ç‰ˆæœ¬ã€‚è¿™æ ·ï¼Œç›¸åŒåå­—ä¸åŒç‰ˆæœ¬çš„ç¨‹åºé›†å°±å¯ä»¥è¢«åŒºåˆ«å¼€ï¼Œä»¥æ­¤ä¸ºåŸºç¡€å°±è§£å†³Dll hellçš„é—®é¢˜ã€‚CLRåœ¨è¿è¡Œçš„æ—¶å€™ä»¥ä¸€å¥—å¤æ‚çš„è§„åˆ™è¯•å›¾åŠ è½½ç¨‹åºçš„ä¾èµ–é¡¹ã€‚ çœ‹èµ·æ¥ä¼¼ä¹.NETä¸é™æ€é“¾æ¥æ— ç¼˜äº†ã€‚ä¸è¿‡ä¹Ÿæœ‰å¥½æ¶ˆæ¯ï¼Œåœ¨Build 2018å¼€å‘è€…å¤§ä¼šä¸Šï¼Œå¾®è½¯å®£å¸ƒç°æœ‰çš„æ¡Œé¢ç¨‹åºå¯ä»¥åœ¨æ˜å¹´æ¨å‡ºçš„.Net core 3ä¸Šé€‰æ‹©ä¸è¿è¡Œæ—¶é™æ€é“¾æ¥åœ¨ä¸€èµ·ï¼Œå°†æ•´ä¸ªç¨‹åºå˜ä¸ºå•ä¸€çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚ Side-by-side and App-local Deployment For cases where the maximum isolation is required, you can deploy .NET Core with your application. Weâ€™re working on new build tools that will bundle your app and .NET Core together as in a single executable, as a new option. Weâ€™ve had requests for deployment options like this for many years, but were never able to deliver those with the .NET Framework. The much more modular architecture used by .NET Core makes these flexible deployment options possible. .Net Core 3.0çš„æ¨å‡ºæ—¶é—´æ˜¯æ˜å¹´ï¼Œæˆ‘ä»¬æ˜¾ç„¶ä¸èƒ½ç­‰åˆ°é‚£ä¸ªæ—¶å€™ã€‚ä¸ºäº†å®ç°éœ€æ±‚ï¼Œå…ˆå‘æœç´¢å¼•æ“æ±‚åŠ©å§ã€‚ é™æ€é“¾æ¥é™æ€é“¾æ¥å°†ä¾èµ–é¡¹æ‰“åŒ…è¿›æˆ‘ä»¬çš„ç¨‹åºï¼Œç”Ÿæˆå•ä¸€çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚è¿™æ˜¯ä¸ªå¾ˆç›´è§‚çš„åˆ‡å…¥ç‚¹ã€‚ä»¥C# static linkä¸ºå…³é”®è¯ï¼Œå‘ç°æœ‰å‡ ä¸ªåŒç±»å‹çš„å·¥å…·ã€‚ä¾‹å¦‚ILMergeã€‚åœ¨.NETçš„ä¸–ç•Œä¸­ï¼Œæºä»£ç ç»è¿‡ç¼–è¯‘åäº§ç”Ÿçš„ç¨‹åºé›†é‡Œå­˜å‚¨çš„å¹¶ä¸æ˜¯æœºå™¨ä»£ç è€Œæ˜¯ä¸€ç§å«MSILçš„ä¸­é—´ä»£ç ã€‚ç¨‹åºé›†ç”±CLRåŠ è½½åè¢«JITå³æ—¶ç¼–è¯‘ä¸ºæœºå™¨ç ã€‚ ILMergeä¹‹ç±»çš„å·¥å…·å·¥ä½œåœ¨ILå±‚é¢ã€‚å®ƒä»¬å°†ä¸åŒç¨‹åºé›†çš„ILä»£ç ç²˜åˆèµ·æ¥ï¼Œç”Ÿæˆå•ä¸€çš„ç¨‹åºé›†ã€‚ å¬èµ·æ¥æ˜¯ä¸æ˜¯å¾ˆç¾å¥½ï¼Ÿå¦‚æœä½ å†™ä¸ªå°demoçš„è¯ä¼šå‘ç°ç¡®å®å¾ˆå¥½ç”¨ã€‚ä½†æ˜¯ILMergeæ— æ³•å¯¹WPFä¸­çš„XAMLèµ„æºè¿›è¡Œæ”¹å†™ã€‚ç¨‹åºæŒ‚åœ¨è¿è¡Œæ—¶ã€‚ å†…åµŒèµ„æº.NETä¸­çš„ç¨‹åºé›†æœ‰èµ„æºçš„æ¦‚å¿µã€‚ä»»ä½•æ–‡ä»¶éƒ½èƒ½ä»¥èµ„æºçš„å½¢å¼åµŒå…¥è¿›ç¨‹åºé›†ã€‚å¦ä¸€ä¸ªæ€è·¯æ˜¯æ˜¯æŠŠä¾èµ–é¡¹å½“ä½œèµ„æºåµŒè¿›æˆ‘ä»¬çš„ä¸»ç¨‹åºã€‚åªè¦èƒ½åœ¨è¿è¡Œæ—¶æŠŠå®ƒä»¬æš´éœ²ç»™CLRï¼Œå°±èƒ½å®ç°self-containã€‚å…ˆæ¥çœ‹çœ‹APIï¼š Assembly.GetManifestResourceStream(string name): 12//Loads the specified manifest resource from this assembly.public virtual System.IO.Stream GetManifestResourceStream (Type type, string name) AppDomain.Load(Byte[]): 12//Loads the Assembly with a common object file format (COFF) based image containing an emitted Assembly.public System.Reflection.Assembly Load (byte[] rawAssembly); AppDomain.AssemblyResolve 12//Occurs when the resolution of an assembly fails.public event ResolveEventHandler AssemblyResolve; æˆ‘ä»¬æŠŠä¾èµ–é¡¹åµŒå…¥åˆ°ç¨‹åºå†…éƒ¨åï¼ŒCLRæ‰¾ä¸åˆ°å¼•ç”¨çš„ç¨‹åºé›†çš„æ—¶å€™å°±ä¼šè§¦å‘AppDomain.AssemblyResolveäº‹ä»¶ã€‚æˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡Œæ‹¿åˆ°ä¾èµ–çš„AssemblyName,Assembly.GetManifestResourceStream(string name)å¾—åˆ°åŒ…å«ä¾èµ–é¡¹çš„çš„streamï¼ŒæŠŠstreamçš„å†…å®¹è¯»å‡ºæ¥æ”¾åˆ°byte[]é‡Œï¼Œè°ƒç”¨AppDomain.Load(Byte[])å°†ç¨‹åºé›†åŠ è½½ã€‚ å¤§è‡´è¿‡ç¨‹èµ°å¾—é€šï¼Œä¸è¿‡æœ‰ç‚¹éº»çƒ¦ã€‚hardcodeä¾èµ–çš„åå­—åï¼Œä»¥åæ·»åŠ æ–°ä¾èµ–é¡¹è¿˜è¦æ›´æ”¹hardcodeçš„åå­—ã€‚æ¯•ç«Ÿç¨‹åºå‘˜ä¹Ÿæ˜¯äººï¼Œä¹Ÿæƒ³å·æ‡’ã€‚è¿™äº›æ´»æœ€å¥½è‡ªåŠ¨åŒ–ã€‚è¦æ˜¯èƒ½å’ŒVSé‡Œçš„ç¼–è¯‘ç»“åˆèµ·æ¥å°±æ›´å¥½äº†ğŸ¤¤ ä½ åˆ«è¯´ï¼Œè¿˜çœŸæœ‰è¿™æ ·çš„å·¥å…·ã€‚Fodyå¯ä»¥å¯¹.NETç¨‹åºé›†åšå¤šç§æ“ä½œã€‚Costuraæ˜¯Fodyçš„ä¸€ä¸ªæ‰©å±•ï¼Œä¸“é—¨ç”¨æ¥å°†ä¾èµ–åµŒå…¥æˆèµ„æºã€‚Fodyä¸VSçš„å®Œç¾é›†æˆï¼Œç¼–è¯‘å®Œæˆåè‡ªåŠ¨å¼€å§‹æ“ä½œã€‚Nugetå®‰è£…å®ŒFodyå’ŒCosturaåï¼Œå¦‚æœè§£å†³æ–¹æ¡ˆæ ¹è·¯å¾„ä¸‹æ²¡æœ‰FodyWeavers.xmlåˆ™æ–°å»ºå®ƒã€‚æŠŠå†…å®¹æ›¿æ¢ä¸º 1234&lt;?xml version=\"1.0\" encoding=\"utf-8\" ?&gt;&lt;Weavers&gt; &lt;Costura/&gt;&lt;/Weavers&gt;` å°±å®Œäº‹äº†ã€‚å¤ªæ˜“ç”¨äº†ã€‚æˆ‘åšäº†æµ‹è¯•ï¼ŒWPFå’Œæ§åˆ¶å°åº”ç”¨éƒ½å¯ä»¥ã€‚çœ‹æ–‡æ¡£ï¼Œå®ƒè¿˜æ”¯æŒ.NET Coreã€‚ Dependencies of my dependencies, is not my dependenciesILMergeä¹Ÿå¥½ï¼ŒFodyä¹Ÿå¥½ï¼Œå®ƒä»¬è§£å†³çš„éƒ½æ˜¯åº”ç”¨ç¨‹åºæ‰€ä¾èµ–åº“çš„é—®é¢˜ã€‚è€Œæˆ‘ä»¬çš„ç¨‹åºä¹‹æ‰€ä»¥å«.NETç¨‹åºï¼Œæ˜¯å› ä¸ºå®ƒä¾èµ–.NET Frameworkã€‚å¦‚æœè¦åšåˆ°fully-self-containedçš„è¯ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æŠŠ.NET Frameworkä¹Ÿå¡è¿›å»ã€‚è¿™å°±æ„å‘³è¿™æˆ‘ä»¬éœ€è¦ä¸€ä¸ªä¸ä¾èµ–.NET Frameworkçš„ç¨‹åºæ¥é‡Šæ”¾.NET Frameworkå’Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºã€‚è¿™å…¶å®å°±æ˜¯é‡æ–°å‘æ˜å®‰è£…ç¨‹åºäº†ã€‚é€€ä¸€æ­¥è¯´ï¼Œå°±ç®—æˆ‘ä»¬çœŸçš„æŠŠ.NET Frameworkæ‰“åŒ…è¿›å»äº†ï¼Œå› ä¸º.NET Frameworkçš„å®‰è£…è¿‡ç¨‹æ¯”è¾ƒè€—æ—¶ï¼Œç”¨æˆ·åœ¨ç‚¹äº†æŒ‰é’®åå‡ ç§’é’Ÿå¦‚æœUIè¿˜æ²¡å‡ºæ¥å¯èƒ½ä¼šè®¤ä¸ºæˆ‘ä»¬çš„ç¨‹åºæœ‰é—®é¢˜ã€‚å› æ­¤ï¼ŒæŠŠç¨‹åºå’Œ.NET Frameworkä¸€èµ·åˆ†å‘çš„äº‹æƒ…å°±äº¤ç»™æ„¿æ„æŠ˜è…¾çš„åŒå­¦ä»¬äº†ã€‚æˆ‘è¿˜æ˜¯æœŸå¾…ä¸‹.NET Core 3.0å§ã€‚ æ€»ç»“å¦‚æœä½ çš„ç¨‹åºæ˜¯WPFç¨‹åºï¼Œè¯·ä½¿ç”¨Fody.Costuraï¼› å¦‚æœä½ çš„ç¨‹åºä¸æ˜¯WPFç¨‹åºï¼Œé‚£ä¹ˆå¯ä»¥ä»»é€‰ILMergeå’ŒFody.Costuraçš„ä¸€ä¸ªã€‚ å¦‚æœä½ çš„ç¨‹åºéœ€è¦ä¸.NET Frameworkä¸€èµ·åˆ†å‘ï¼Œè¯·åœ¨å¤„ç†ä¸»ç¨‹åºåä½¿ç”¨æ”¯æŒé™é»˜å®‰è£…çš„Installerå°†ä¸»ç¨‹åºä¸.NETè¿è¡Œæ—¶ä¸€èµ·æ‰“åŒ…ã€‚ æˆ–è€…ç­‰.Net Core 3.0å‘å¸ƒ Reference .Net Core 3.0 - blogs.msdn.microsoft.com How the Runtime Locates Assemblies - docs.microsoft.com Fody - github.com Costura - github.com .NET Framework deployment guide for developers - docs.microsoft.com","categories":[],"tags":[{"name":"WPF","slug":"WPF","permalink":"https://verrickt.github.io/tags/WPF/"},{"name":".Net Framework","slug":"Net-Framework","permalink":"https://verrickt.github.io/tags/Net-Framework/"}]},{"title":"å¼•ç”¨ç±»å‹çš„å¼€é”€","slug":"overhead-of-reference-types","date":"2018-07-19T12:26:05.000Z","updated":"2018-08-03T03:14:39.131Z","comments":true,"path":"2018/07/19/overhead-of-reference-types/","link":"","permalink":"https://verrickt.github.io/2018/07/19/overhead-of-reference-types/","excerpt":"å€¼ç±»å‹ä¸å¼•ç”¨ç±»å‹C#ä¸­çš„ç±»å‹åˆ†ä¸ºå¼•ç”¨ç±»å‹å’Œå€¼ç±»å‹ã€‚ä½¿ç”¨structæˆ–enumå…³é”®å­—ä¿®é¥°çš„ç±»å‹å®šä¹‰æ˜¯å€¼ç±»å‹ï¼Œä½¿ç”¨classæˆ–delegateå…³é”®å­—ä¿®é¥°çš„ç±»å‹æ˜¯å¼•ç”¨ç±»å‹ã€‚å¼•ç”¨ç±»å‹å’Œå€¼ç±»å‹å„æœ‰é™åˆ¶ï¼Œåˆ†åˆ«é€‚ç”¨äºä¸åŒçš„åœºæ™¯ã€‚ä¸åŒäºC++ï¼ŒC#ä¸­çš„å€¼ç±»å‹åªèƒ½åˆ†é…åœ¨æ ˆä¸Š*1ï¼Œå¼•ç”¨ç±»å‹åªèƒ½åˆ†é…åœ¨GCå †ä¸Šã€‚C#ä¸­çš„GCæ˜¯ç²¾ç¡®å¼GCï¼Œè¿™å°±å¯¹GCå †ä¸Šçš„æŒ‡é’ˆæœ‰äº†ä¸€äº›è¦æ±‚ã€‚è¿™æ˜¯å¼•ç”¨ç±»å‹æœ‰å¼€é”€çš„åŸå› ä¹‹ä¸€ã€‚ Sync block index ä¸ Type object pointerè¯»è¿‡C# vir CLRçš„åŒå­¦ä¼šçŸ¥é“ï¼Œå¼•ç”¨ç±»å‹çš„å¼€é”€æ˜¯Sync blockindexå’ŒType object pointerã€‚ä»–ä»¬çš„é•¿åº¦æ˜¯éƒ½æ˜¯ä¸€ä¸ªå­—é•¿ã€‚å³åœ¨32ä½CLRä¸Šæ˜¯4å­—èŠ‚ï¼Œåœ¨64ä½CLRä¸Šæ˜¯8å­—èŠ‚ã€‚Sync block indexåœ¨CLRä¸­æ˜¯ç”¨äºå®ç°lock,Monitorç­‰çº¿ç¨‹åŒæ­¥åŸè¯­ï¼ŒType object pointeræ˜¯æŒ‡å‘å½“å‰å¯¹è±¡è¿è¡Œæ—¶ç±»å‹ä¿¡æ¯çš„ä¸€ä¸ªæŒ‡é’ˆã€‚Sync block indexä¸Type object pointeråªåœ¨CLRå±‚é¢å­˜åœ¨ï¼Œå¯¹C#ç¨‹åºæ¥è¯´æ˜¯é€æ˜çš„ã€‚ä½†æ˜¯CLRå°†å®ƒä»¬æš´å°è£…åéœ²C#ï¼Œä¾‹å¦‚çº¿ç¨‹åŒæ­¥åŸè¯­å’Œåå°„APIã€‚","text":"å€¼ç±»å‹ä¸å¼•ç”¨ç±»å‹C#ä¸­çš„ç±»å‹åˆ†ä¸ºå¼•ç”¨ç±»å‹å’Œå€¼ç±»å‹ã€‚ä½¿ç”¨structæˆ–enumå…³é”®å­—ä¿®é¥°çš„ç±»å‹å®šä¹‰æ˜¯å€¼ç±»å‹ï¼Œä½¿ç”¨classæˆ–delegateå…³é”®å­—ä¿®é¥°çš„ç±»å‹æ˜¯å¼•ç”¨ç±»å‹ã€‚å¼•ç”¨ç±»å‹å’Œå€¼ç±»å‹å„æœ‰é™åˆ¶ï¼Œåˆ†åˆ«é€‚ç”¨äºä¸åŒçš„åœºæ™¯ã€‚ä¸åŒäºC++ï¼ŒC#ä¸­çš„å€¼ç±»å‹åªèƒ½åˆ†é…åœ¨æ ˆä¸Š*1ï¼Œå¼•ç”¨ç±»å‹åªèƒ½åˆ†é…åœ¨GCå †ä¸Šã€‚C#ä¸­çš„GCæ˜¯ç²¾ç¡®å¼GCï¼Œè¿™å°±å¯¹GCå †ä¸Šçš„æŒ‡é’ˆæœ‰äº†ä¸€äº›è¦æ±‚ã€‚è¿™æ˜¯å¼•ç”¨ç±»å‹æœ‰å¼€é”€çš„åŸå› ä¹‹ä¸€ã€‚ Sync block index ä¸ Type object pointerè¯»è¿‡C# vir CLRçš„åŒå­¦ä¼šçŸ¥é“ï¼Œå¼•ç”¨ç±»å‹çš„å¼€é”€æ˜¯Sync blockindexå’ŒType object pointerã€‚ä»–ä»¬çš„é•¿åº¦æ˜¯éƒ½æ˜¯ä¸€ä¸ªå­—é•¿ã€‚å³åœ¨32ä½CLRä¸Šæ˜¯4å­—èŠ‚ï¼Œåœ¨64ä½CLRä¸Šæ˜¯8å­—èŠ‚ã€‚Sync block indexåœ¨CLRä¸­æ˜¯ç”¨äºå®ç°lock,Monitorç­‰çº¿ç¨‹åŒæ­¥åŸè¯­ï¼ŒType object pointeræ˜¯æŒ‡å‘å½“å‰å¯¹è±¡è¿è¡Œæ—¶ç±»å‹ä¿¡æ¯çš„ä¸€ä¸ªæŒ‡é’ˆã€‚Sync block indexä¸Type object pointeråªåœ¨CLRå±‚é¢å­˜åœ¨ï¼Œå¯¹C#ç¨‹åºæ¥è¯´æ˜¯é€æ˜çš„ã€‚ä½†æ˜¯CLRå°†å®ƒä»¬æš´å°è£…åéœ²C#ï¼Œä¾‹å¦‚çº¿ç¨‹åŒæ­¥åŸè¯­å’Œåå°„APIã€‚ ç‰¹æ®Šçš„ç±»å‹-æ•°ç»„C#ä¸­ç»å¤§éƒ¨åˆ†ç±»å‹çš„å¤§å°åœ¨ç¼–è¯‘æœŸå°±å¯ä»¥ç¡®å®šï¼Œåªè¦æŠŠå¯¹åº”çš„æˆå‘˜çš„å¤§å°ç›¸åŠ å³å¯1SizeOf(T) = T.GetFields.Select(f=&gt;f.IsClass?WordSize:Sizeof(f)).Sum(); æ•°ç»„æ˜¯ä¸ªå¾ˆç‰¹æ®Šçš„å­˜åœ¨ï¼Œç‰¹æ®Šåœ¨å®ƒçš„å¤§å°æ˜¯ä¸å…ƒç´ çš„ç±»å‹å’Œæ•°é‡æœ‰å…³ã€‚æ•°ç»„çš„å†…å­˜å¸ƒå±€åŒ…å«äº†æ‰€æœ‰çš„å…ƒç´ ã€‚(å¦ä¸€ä¸ªè¿™æ ·çš„ç±»å‹æ˜¯string)ã€‚byte[4]å’Œbyte[3]çš„ç±»å‹éƒ½æ˜¯byte[]ï¼Œç„¶è€Œå®ƒä»¬çš„å¤§å°å´ä¸ä¸€æ ·ã€‚æˆ‘ä»¬è¿™æ¬¡å°±å¥½ä»”ç»†è§‚å¯Ÿä¸‹æ•°ç»„ ä½¿ç”¨WinDBGWinDBGæ˜¯Windowsä¸‹å¸¸ç”¨çš„Debuggerã€‚è™½ç„¶æ˜¯ä»¥è°ƒè¯•éæ‰˜ç®¡ä»£ç è®¾è®¡ï¼Œä½†æ˜¯åŠ ä¸Šç›¸å…³çš„æ’ä»¶ä»¥åä¹Ÿå¯ä»¥ç”¨æ¥è°ƒè¯•æ‰˜ç®¡ä»£ç ã€‚SOS.dllæ˜¯ä¸€ä¸ªæä¾›æ‰˜ç®¡ä»£ç è°ƒè¯•æ”¯æŒçš„çš„æ’ä»¶ã€‚å®ƒåŒæ—¶æ”¯æŒCLRå’ŒCoreCLRã€‚ å®‰è£…å¥½WinDBGåï¼Œå°±å¯ä»¥å¼€å§‹è°ƒè¯•äº†ã€‚ç®€å•èµ·è§ï¼Œè¿™é‡Œä½¿ç”¨å¦‚ä¸‹ä»£ç ã€‚1234567891011121314151617namespace SOSFromEE&#123; class Program &#123; const int Length = 10; static void Main(string[] args) &#123; var ints = Enumerable.Range(1, Length).ToArray(); var strs = ints.Select(i =&gt; i.ToString()).ToArray(); Console.ReadLine(); GC.KeepAlive(ints); GC.KeepAlive(strs); Console.Read(); &#125; &#125;&#125; åœ¨WinDBGä¸­é€‰æ‹©Launchå¯¹åº”çš„å¯æ‰§è¡Œç¨‹åºå³å¯ã€‚åœ¨ç¬¬ä¸€ä¸ªæ–­ç‚¹æ—¶CLRè¿˜æ²¡æœ‰åŠ è½½ï¼Œæˆ‘ä»¬ç»§ç»­è®©ç¨‹åºè¿è¡Œï¼Œç­‰åˆ°ä¸å†å‡ºç°ModLoadç›¸å…³çš„æç¤ºæ—¶å°±å¯ä»¥è®©ç¨‹åºæš‚åœäº†ã€‚æˆ‘ä»¬åœ¨è¿™æ—¶åŠ è½½SOSæ‰©å±•ã€‚ 1.loadby sos CLRNameHere sosåè·Ÿçš„æ˜¯CLRçš„åç§° CLR2.0(.Net framework 3.5åŠä»¥å‰)æ˜¯mscorwks CLR4.0(.Net framework 4.0åŠä»¥å)æ˜¯clr .net coreæ˜¯ coreclr åŠ è½½æ¨¡å—çš„è¿‡ç¨‹ä¸­éœ€è¦ä»å¾®è½¯çš„æœåŠ¡å™¨ä¸Šä¸‹è½½ç›¸å…³çš„pdbæ–‡ä»¶ã€‚ç”±äºä½ æ‡‚çš„åŸå› éœ€è¦å¾ˆé•¿æ—¶é—´ CLR2.0 ä¸‹çš„æ•°ç»„æˆ‘ä»¬é¦–å…ˆåœ¨32ä½çš„CLR2.0ä¸‹è§‚å¯Ÿã€‚ é¦–å…ˆä½¿ç”¨.loadby sos mscorwksåŠ è½½SOSæ‰©å±•æ¨¡å—ã€‚ !dumpheap -type TypeNameHereå‘½ä»¤å¯ä»¥æŸ¥çœ‹å½“å‰æ‰˜ç®¡å †ä¸Šç±»å‹åä¸ºTypeNameHereçš„å¯¹è±¡ã€‚ System.String[]æˆ‘ä»¬å…ˆçœ‹çœ‹String[]éƒ½æœ‰å“ªäº›: 123456789100:006&gt; !dumpheap -type System.String[] Address MT Size03591390 78ae46e4 80 ..........................total 17 objectsStatistics: MT Count TotalSize Class Name78ae46e4 17 676 System.Object[]Total 17 objects Addressæ˜¾ç¤ºçš„æ˜¯å¯¹è±¡åœ¨æ‰˜ç®¡å †ä¸­çš„åœ°å€ï¼ŒMethod Tableå°±æ˜¯ä¸Šæ–‡ä¸­è¯´çš„Type object pointeräº†ã€‚ æˆ‘ä»¬æŸ¥çœ‹ä¸‹ä½äºåœ°å€03591390çš„String[]:1234567891011121314151617181920212223240:006&gt; !dumparray 03591390Name: System.String[]MethodTable: 78ae46e4EEClass: 788cda74Size: 80(0x50) bytesArray: Rank 1, Number of elements 16, Type CLASSElement Methodtable: 78b10f14[0] 035911c8[1] 03591250[2] null[3] null[4] null[5] null[6] null[7] null[8] null[9] null[10] null[11] null[12] null[13] null[14] null[15] null å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ•°ç»„ä¸€å…±æœ‰16ä¸ªå…ƒç´ ï¼Œå…ƒç´ çš„ç±»å‹æ˜¯stringã€‚ æˆ‘ä»¬å†æ¥çœ‹çœ‹03591390ä½ç½®çš„å†…å­˜å¸ƒå±€ 12345670:006&gt; dd 03591390 -0x40359138c 00000000 78ae46e4 00000010 78b10f140359139c 035911c8 03591250 00000000 00000000035913ac 00000000 00000000 00000000 00000000035913bc 00000000 00000000 00000000 00000000035913cc 00000000 00000000 00000000 00000000 dd 03591390 -0x4å‘Šè¯‰WinDBGä»03591390å‘å‰åç§»4ä¸ªå­—èŠ‚çš„ä½ç½®å¼€å§‹å±•ç¤ºå†…å­˜ã€‚ä¹‹æ‰€ä»¥å‘å‰åç§»4ä¸ªå­—èŠ‚æ˜¯ä¸ºäº†å±•ç¤ºå¼•ç”¨ç±»å‹çš„å¼€é”€ã€‚0359138cä½ç½®çš„å€¼00000000æ˜¯Sync block indexï¼Œä½äº03591390çš„78ae46e4çœ‹èµ·æ¥æœ‰ç‚¹æ‘¸ä¸ç€å¤´è„‘ï¼Œåœ¨WinDBGçš„è¾“å‡ºä¸­æŸ¥æ‰¾åå‘ç°æ˜¯System.String[]çš„MethodTableã€‚12Name: System.String[]MethodTable: 78ae46e4 MethodTableæ˜¯CLRçº§åˆ«çš„æ¦‚å¿µï¼Œå¯¹åº”åˆ°è¿™é‡Œå°±æ˜¯Type Object Pointerã€‚GCå †ä¸Šçš„å¯¹è±¡å¾€å‰åï¼”å­—èŠ‚å°±èƒ½å¾—åˆ°Sync block indexï¼Œæ¥ä¸‹æ¥æ˜¯å¯¹è±¡çš„Type object pointerã€‚ä¸ºäº†å™è¿°æ–¹ä¾¿ï¼Œä¸‹æ–‡ç»Ÿç§°ä¸ºå¯¹è±¡å¤´:) ç”±æ­¤æ¨æµ‹ï¼Œå¯¹è±¡å¤´é•¿åº¦æ˜¯ä¸¤ä¸ªå­—é•¿ã€‚èµ·å§‹ä½ç½®ä¸ºå½“å‰æŒ‡é’ˆçš„ä½ç½®å¾€å‰åç§»ä¸€ä¸ªå­—é•¿ã€‚æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥åœ¨64ä½CLRä¸Šè‡ªè¡ŒéªŒè¯ã€‚ æ•°ç»„çš„é•¿åº¦æ˜¯16(0x10)ï¼Œåœ°å€03591395çš„å€¼å°±æ˜¯å®ƒã€‚ åœ°å€03591388çš„78b10f14ä¸çŸ¥é“æ˜¯ä»€ä¹ˆã€‚æ²¡å…³ç³»ï¼ŒCTRF+FæŸ¥æ‰¾åå‘ç°å®ƒåœ¨ä¸Šæ–‡å‡ºç°è¿‡ã€‚ 1Element Methodtable: 78b10f14 åº”è¯¥æ˜¯Stringçš„Method tableã€‚ dumpä¸€ä¸‹System.String:12340:006&gt; !dumpheap -type System.String MT Count TotalSize Class Name78b10f14 154 6224 System.String çœ‹æ¥çŒœå¾—æ²¡é”™ã€‚æ€»ç»“ä¸€ä¸‹ï¼Œå¼•ç”¨ç±»å‹çš„æ•°ç»„æœ‰4å­—é•¿çš„å¼€é”€ï¼Œåˆ†åˆ«æ˜¯2å­—é•¿çš„å¯¹è±¡å¤´ï¼Œ1å­—é•¿çš„é•¿åº¦ï¼Œ1å­—é•¿çš„å…ƒç´ ç±»å‹æŒ‡é’ˆ æ¥ä¸‹æ¥çœ‹çœ‹å€¼ç±»å‹æ•°ç»„çš„å¸ƒå±€ System.Int32[]è€æ ·å­ï¼Œé¦–å…ˆå…ˆæ‰¾åˆ°å †ä¸Šçš„Int32[]. 1234567890:006&gt; !dumpheap -type System.Int32[] Address MT Size03591e50 78b130b0 296 ................................total 18 objectsStatistics: MT Count TotalSize Class Name78b130b0 18 1440 System.Int32[]Total 18 objects dumpä¸€ä¸‹ç›¸å…³å±æ€§ 1234567!dumparray 03591e50 Name: System.Int32[]MethodTable: 78b130b0EEClass: 788ce6a8Size: 296(0x128) bytesArray: Rank 1, Number of elements 71, Type Int32Element Methodtable: 78b13160 æŸ¥çœ‹å†…å­˜å¸ƒå±€ 1234567890:006&gt; dd 03591e50 -0x403591e4c 00000000 78b130b0 00000047 0000000003591e5c 00000000 00000000 00000000 0000000003591e6c 00000000 00000000 00000000 0000000003591e7c 00000000 00000000 00000000 0000000003591e8c 00000000 00000000 00000000 0000000003591e9c 00000000 00000000 00000000 0000000003591eac 00000000 00000000 00000000 0000000003591ebc 00000000 00000000 00000000 00000000 é¦–å…ˆInt32[]ä¹Ÿæœ‰å¯¹è±¡å¤´å’Œé•¿åº¦çš„å¼€é”€ï¼Œä½†æ˜¯å´æ²¡æœ‰å…ƒç´ ç±»å‹æŒ‡é’ˆçš„å¼€é”€ã€‚ æœ‰å¿ƒçš„åŒå­¦å¯èƒ½å·²ç»å‘ç°äº†ï¼ŒInt32[]æ˜ç¡®æŒ‡å‡ºäº†å…ƒç´ çš„ç±»å‹ï¼Œè€ŒString[]å´æ²¡æœ‰ã€‚ 123456!dumparray 03591390Name: System.String[]MethodTable: 78ae46e4EEClass: 788cda74Size: 80(0x50) bytesArray: Rank 1, Number of elements 16, Type *CLASS* 123456!dumparray 03591e50 Name: System.Int32[]MethodTable: 78b130b0EEClass: 788ce6a8Size: 296(0x128) bytesArray: Rank 1, Number of elements 71, Type *Int32* String[]çš„Typeæ˜¯ä¸ªCLASSè€Œä¸æ˜¯Stringï¼Œéš¾é“è¯´System.String[]æ˜¯ä¸ªâ€™å‡çš„â€™çš„å­—ç¬¦ä¸²æ•°ç»„ï¼Ÿ â€¦. â€¦. â€¦. æ­å–œä½ çŒœå¯¹äº†ã€‚ä½¿ç”¨!objsizeå‘½ä»¤å‘ç°String[]æ˜¯ä¸ªå¸¦äº†å±‚çš®çš„Object[]1234!objsize 03591e50 sizeof(03591e50) = 296 ( 0x128) bytes (System.Int32[])0:006&gt; !objsize 03591390 sizeof(03591390) = 392 ( 0x188) bytes (System.Object[]) C# in depthä¸­å¯¹æ³›å‹æœ‰è¿™æ ·çš„æè¿° å¯¹äºä¸€ä¸ªæ³›å‹ç±»MyGeneric&lt;T&gt;ï¼Œå¯¹äºTçš„æ˜¯å¼•ç”¨ç±»å‹çš„æƒ…å†µï¼ŒJITåªä¼šä¸ºå…¶ç”Ÿæˆä¸€ä»½ä»£ç ;å¯¹äºTæ˜¯å€¼ç±»å‹çš„æƒ…å†µï¼Œåˆ™ä¸ºæ¯ä¸€ä¸ªä¸åŒçš„Tç”Ÿæˆå„è‡ªçš„ä»£ç ã€‚å…¶ä¸­çš„åŸå› æ˜¯ï¼Œåœ¨JITè¿è¡Œæ—¶ï¼ŒæŒ‡é’ˆçš„é•¿åº¦æ€»æ˜¯å›ºå®šçš„ï¼Œå› è€Œå¯ä»¥å…±ç”¨ä¸€å¥—ä»£ç ç›¸åŒçš„ä»£ç ã€‚è€Œå€¼ç±»å‹çš„é•¿åº¦æ˜¯ä¸ç¡®å®šçš„ï¼Œå› æ­¤éœ€è¦ä¸ºæ¯ä¸ªå€¼ç±»å‹å•ç‹¬ç”Ÿæˆä»£ç ã€‚ è¿™é‡Œå¯èƒ½ä¹Ÿæ˜¯ç›¸åŒçš„åŸå› å§ã€‚æŒ‡é’ˆçš„é•¿åº¦ç›¸åŒï¼Œå› è€Œæ‰éœ€è¦å‚¨å­˜å…ƒç´ çš„ç±»å‹æŒ‡é’ˆï¼Œå®ç°ç±»å‹æ£€æŸ¥ã€‚è€Œå€¼ç±»å‹çš„ä»£ç ä¸å…±ç”¨ï¼Œæ‰€ä»¥ä¸éœ€è¦å‚¨å­˜å…ƒç´ çš„ç±»å‹æŒ‡é’ˆã€‚ æœ¬æ¥åˆ°å·²ç»å¯ä»¥ç»“æŸäº†ï¼Œå¯æ˜¯æˆ‘åœ¨32ä½çš„CLR4.0è§‚å¯Ÿåˆ°çš„ç»“æœå´ä¸å¤ªä¸€æ ·ã€‚ CLR 4.0ä¸‹çš„æ•°ç»„ä¸CLR 2.0ä¸åŒï¼ŒCLR 4.0ä¸‹åŠ è½½SOSçš„åå­—æ˜¯clr .loadby sos clr System.String[]é¦–å…ˆdumpheapï¼š 123456780:006&gt; !dumpheap -type System.String[] Address MT Size02531590 6979dfe0 84 ...........................Statistics: MT Count TotalSize Class Name6979dfe0 24 912 System.String[]Total 24 objects ç„¶åæ˜¯dumparray:1234567Name: System.String[]MethodTable: 6979dfe0EEClass: 69374b80Size: 84(0x54) bytesArray: Rank 1, Number of elements 18, Type CLASSElement Methodtable: 6979d488[0] 02531254 æœ€ådd:12345670:006&gt; dd 02531590 -0x40253158c 00000000 6979dfe0 00000012 025312540253159c 025312d8 00000000 00000000 02531568025315ac 00000000 00000000 00000000 00000000025315bc 00000000 00000000 00000000 00000000025315cc 00000000 00000000 00000000 00000000025315dc 00000000 00000000 ä½äº02531598çš„å€¼02531254æ˜¯ç¬¬ä¸€ä¸ªå…ƒç´ çš„å€¼è€Œä¸æ˜¯Stringçš„Method Table!12345!dumpheap -type StringStatistics: MT Count TotalSize Class Name6979d488 193 5932 System.StringTotal 224 objects CLR 4.0æŠŠMethod Tableå»æ‰äº†ï¼Ÿ ç»è¿‡ç®€å•çš„ç®—æœ¯ï¼Œç¡®å®æ˜¯è¿™æ ·çš„18ä¸ªå…ƒç´ ï¼Œå æ®ç©ºé—´18*4=72ã€‚ å¯¹è±¡å¤´å’Œæ•°ç»„å¤§å°å æ®2*4+4=12 84=72+12ï¼Œè·Ÿdumparrayå‡ºæ¥çš„å€¼ä¸€æ ·ã€‚(æœ‰å…´è¶£çš„åŒå­¦æ ¹æ®ä¸Šæ–‡ä¸­CLR2.0çš„æ•°æ®è®¡ç®—ä¸‹) !objsizeä¹Ÿç¡®è®¤äº†æˆ‘ä»¬çš„çŒœæµ‹120:006&gt; !objsize 02531590sizeof(02531590) = 428 (0x1ac) bytes (System.String[]) System.Int32[]!dumpheap:123456780:006&gt; !dumpheap -type System.Int32[] Address MT Size02531f1c 6979f2a0 300 .............................. Statistics: MT Count TotalSize Class Name6979f2a0 20 844 System.Int32[]Total 20 objects !dumparray:1234567890:006&gt; !dumparray 02531f1c Name: System.Int32[]MethodTable: 6979f2a0EEClass: 693752d8Size: 300(0x12c) bytesArray: Rank 1, Number of elements 72, Type Int32Element Methodtable: 6979f2dc[0] 02531f24[1] 02531f28 dd:1234567890:006&gt; dd 02531f1c -0x402531f18 00000000 6979f2a0 00000048 0000000302531f28 00000007 0000000b 00000011 0000001702531f38 0000001d 00000025 0000002f 0000003b02531f48 00000047 00000059 0000006b 0000008302531f58 000000a3 000000c5 000000ef 0000012502531f68 00000161 000001af 00000209 0000027702531f78 000002f9 00000397 0000044f 0000052f02531f88 0000063d 0000078b 0000091d 00000af1 å€¼ç±»å‹æ•°ç»„å€’æ˜¯æ²¡æœ‰ä»€ä¹ˆå˜åŒ–ã€‚ æ€»ç»“C#ä¸­å¼•ç”¨ç±»å‹æœ‰2ä¸ªå­—é•¿çš„å¯¹è±¡å¤´å¼€é”€ã€‚åˆ†åˆ«æ˜¯Sync block indexå’ŒType Object Pointerã€‚æ•°ç»„æ˜¯ç‰¹æ®Šçš„ç±»å‹ï¼Œå®ƒçš„å¤§å°ä¸åŒ…å«çš„å…ƒç´ ç›¸å…³ï¼Œå› æ­¤å…·æœ‰é¢å¤–çš„å¼€é”€ã€‚ åœ¨CLR 2.0ä¸‹ å¼•ç”¨ç±»å‹çš„æ•°ç»„åŒ…å«é¢å¤–çš„2å­—é•¿çš„å¼€é”€ã€‚åˆ†åˆ«æ˜¯é•¿åº¦å’Œå…ƒç´ çš„ç±»å‹æŒ‡é’ˆ å€¼ç±»å‹çš„æ•°ç»„åŒ…å«é•¿åº¦çš„é¢å¤–å¼€é”€å¼€é”€ã€‚å¤§å°æ˜¯ä¸€ä¸ªå­—é•¿ã€‚ åœ¨CLR 4.0å’ŒCoreCLRä¸­ å¼•ç”¨ç±»å‹å’Œå€¼ç±»å‹çš„æ•°ç»„åŒ…å«é•¿åº¦çš„é¢å¤–å¼€é”€å¼€é”€ã€‚å¤§å°æ˜¯ä¸€ä¸ªå­—é•¿ã€‚ é™äºç¯‡å¹…ï¼ŒCoreCLRçš„æƒ…å†µä¸å†èµ˜è¿°ï¼Œè¿˜è¯·è¯»è€…è‡ªè¡ŒéªŒè¯ã€‚ /*å…¶å®æœ¬æ¥çœ‹åˆ°Stackoverflowçš„å›ç­”åªæ˜¯æƒ³è‡ªå·±éªŒè¯ä¸‹çš„ï¼Œä½†æ˜¯è‡ªå·±åŠ¨æ‰‹çš„ç»“æœå’Œç­”æ¡ˆé‡Œæåˆ°çš„ä¸å¤ªä¸€æ ·ï¼ŒæŸ¥äº†åŸå› å‘ç°ç­”æ¡ˆé‡Œç”¨çš„æ˜¯CLR2.0ï¼Œæˆ‘è‡ªå·±ç”¨çš„æ˜¯CLR4.0ã€‚è¿™å°±æŒ–å‡ºæ¥äº†CLRå®ç°çš„æ›´æ”¹ã€‚CoreCLRé‡Œä½¿ç”¨çš„æ˜¯CLR4.0é‡Œçš„è§„åˆ™ã€‚ç›®å‰è¿˜ä¸æ¸…æ¥šMSä¸ºä½•è¦æ”¹å®ç°*/ å‚è€ƒ Overhead of a .NET array? SOS.dll (SOS Debugging Extension)","categories":[],"tags":[{"name":"C#","slug":"C","permalink":"https://verrickt.github.io/tags/C/"},{"name":"reference type","slug":"reference-type","permalink":"https://verrickt.github.io/tags/reference-type/"},{"name":"overhead","slug":"overhead","permalink":"https://verrickt.github.io/tags/overhead/"}]},{"title":"é¢å‘æŠ½è±¡ç¼–ç¨‹","slug":"program-upon-abstractions","date":"2018-07-12T13:56:26.000Z","updated":"2018-08-04T08:30:08.370Z","comments":true,"path":"2018/07/12/program-upon-abstractions/","link":"","permalink":"https://verrickt.github.io/2018/07/12/program-upon-abstractions/","excerpt":"Prefaceè¯´æ¥æƒ­æ„§ï¼Œç›´åˆ°è¿‘å‡ å¤©æ‰æ˜ç™½äº†ä¸€ç‚¹é¢å‘å¯¹è±¡è®¾è®¡çš„ã€‚ç»™æˆ‘å¸¦æ¥å¯å‘çš„æ˜¯SOLIDä¸­çš„Dï¼Œå®ƒä»£è¡¨Dependency Inversionï¼ˆä¾èµ–åè½¬ï¼‰ã€‚å°½ç®¡å†™/èƒŒå®šä¹‰å¾ˆæ— èŠï¼Œä½†æˆ‘è¿˜æ˜¯æƒ³å†™ä¸€ä¸‹ä¾èµ–åè½¬çš„æ ¸å¿ƒ ä¸Šå±‚æ¨¡å—ä¸åº”è¯¥ä¾èµ–ä¸‹å±‚æ¨¡å—ï¼Œä»–ä»¬éƒ½åº”è¯¥ä¾èµ–æŠ½è±¡ Talk is cheap, show me the codeæœ€è¿‘åœ¨å†™ä¸€ä¸ªéŸ³ä¹ç”µå°åº”ç”¨ï¼Œé‡‡ç”¨æœåŠ¡ç«¯ã€å®¢æˆ·ç«¯çš„æ–¹å¼å®ç°ã€‚åœ¨æœåŠ¡ç«¯ï¼Œç”¨æˆ·å¯ä»¥æŒ‡å®šä¸€ä¸ªè·¯å¾„ï¼Œç¨‹åºæ ¹æ®è¿™ä¸ªè·¯å¾„ç”Ÿæˆæ’­æ”¾åˆ—è¡¨ã€‚ éœ€æ±‚æœåŠ¡å™¨æ˜¯ä¸€ä¸ªä¸€æ—¦å¼€èµ·æ¥å°±ä¸ä¼šè½»æ˜“å…³é—­çš„ç¨‹åºï¼Œæˆ‘å¸Œæœ›æ’­æ”¾åˆ—è¡¨èƒ½å¤Ÿè‡ªåŠ¨åˆ·æ–°ã€‚è¿™æ ·å½“ç”¨æˆ·æ·»åŠ æˆ–åˆ é™¤äº†æŸé¦–éŸ³ä¹åä¸ç”¨é‡å¯æœåŠ¡å™¨å°±å¯ä»¥åæ˜ å˜åŒ–ã€‚è€ƒè™‘åˆ°æ˜“ç”¨æ€§ï¼Œåº”è¯¥æ”¯æŒç”±è·¯å¾„ç›´æ¥ç”Ÿæˆæ’­æ”¾åˆ—è¡¨ã€‚æ­Œæ›²æ˜¯æœ‰å°é¢ç­‰å…¶ä»–ä¿¡æ¯çš„ï¼Œè¦æ»¡è¶³è¿™äº›ä¿¡æ¯çš„å¯å®šåˆ¶åŒ–ï¼Œç¨‹åºä¹Ÿæ”¯æŒç”±é…ç½®æ–‡ä»¶æŒ‡å®šçš„æ’­æ”¾åˆ—è¡¨ã€‚","text":"Prefaceè¯´æ¥æƒ­æ„§ï¼Œç›´åˆ°è¿‘å‡ å¤©æ‰æ˜ç™½äº†ä¸€ç‚¹é¢å‘å¯¹è±¡è®¾è®¡çš„ã€‚ç»™æˆ‘å¸¦æ¥å¯å‘çš„æ˜¯SOLIDä¸­çš„Dï¼Œå®ƒä»£è¡¨Dependency Inversionï¼ˆä¾èµ–åè½¬ï¼‰ã€‚å°½ç®¡å†™/èƒŒå®šä¹‰å¾ˆæ— èŠï¼Œä½†æˆ‘è¿˜æ˜¯æƒ³å†™ä¸€ä¸‹ä¾èµ–åè½¬çš„æ ¸å¿ƒ ä¸Šå±‚æ¨¡å—ä¸åº”è¯¥ä¾èµ–ä¸‹å±‚æ¨¡å—ï¼Œä»–ä»¬éƒ½åº”è¯¥ä¾èµ–æŠ½è±¡ Talk is cheap, show me the codeæœ€è¿‘åœ¨å†™ä¸€ä¸ªéŸ³ä¹ç”µå°åº”ç”¨ï¼Œé‡‡ç”¨æœåŠ¡ç«¯ã€å®¢æˆ·ç«¯çš„æ–¹å¼å®ç°ã€‚åœ¨æœåŠ¡ç«¯ï¼Œç”¨æˆ·å¯ä»¥æŒ‡å®šä¸€ä¸ªè·¯å¾„ï¼Œç¨‹åºæ ¹æ®è¿™ä¸ªè·¯å¾„ç”Ÿæˆæ’­æ”¾åˆ—è¡¨ã€‚ éœ€æ±‚æœåŠ¡å™¨æ˜¯ä¸€ä¸ªä¸€æ—¦å¼€èµ·æ¥å°±ä¸ä¼šè½»æ˜“å…³é—­çš„ç¨‹åºï¼Œæˆ‘å¸Œæœ›æ’­æ”¾åˆ—è¡¨èƒ½å¤Ÿè‡ªåŠ¨åˆ·æ–°ã€‚è¿™æ ·å½“ç”¨æˆ·æ·»åŠ æˆ–åˆ é™¤äº†æŸé¦–éŸ³ä¹åä¸ç”¨é‡å¯æœåŠ¡å™¨å°±å¯ä»¥åæ˜ å˜åŒ–ã€‚è€ƒè™‘åˆ°æ˜“ç”¨æ€§ï¼Œåº”è¯¥æ”¯æŒç”±è·¯å¾„ç›´æ¥ç”Ÿæˆæ’­æ”¾åˆ—è¡¨ã€‚æ­Œæ›²æ˜¯æœ‰å°é¢ç­‰å…¶ä»–ä¿¡æ¯çš„ï¼Œè¦æ»¡è¶³è¿™äº›ä¿¡æ¯çš„å¯å®šåˆ¶åŒ–ï¼Œç¨‹åºä¹Ÿæ”¯æŒç”±é…ç½®æ–‡ä»¶æŒ‡å®šçš„æ’­æ”¾åˆ—è¡¨ã€‚ ç°æœ‰ä»£ç 123456789internal class PlaylistManager&#123; public IReadonlyList&lt;Song&gt; AllSong =&gt; _backLogs.AsReadOnly(); private readonly List&lt;Song&gt; _backLogs; public PlaylistManager(IEnumerable&lt;Song&gt; backlog) &#123; _backLogs = new List&lt;Song&gt;(backlog); &#125;&#125; ç°æœ‰ä»£ç ä¸­æ„é€ å‡½æ•°çš„IEnumerable\\å‚æ•°æŒ‡å®šäº†æ’­æ”¾åˆ—è¡¨ï¼Œå¯æ˜¯åˆ·æ–°å´éœ€è¦å¤–éƒ¨çš„æ”¯æŒï¼šåŸºäºè·¯å¾„çš„åˆ·æ–°å’ŒåŸºäºé…ç½®æ–‡ä»¶çš„åˆ·æ–°æ˜¯å®Œå…¨ä¸ä¸€æ ·çš„ã€‚æˆ‘å®Œå…¨å¯ä»¥æŠŠè¿™ä¸¤ä¸ªåˆ·æ–°éƒ½æ”¾åˆ°PlaylistManageré‡Œï¼Œæ ¹æ®ç”Ÿæˆæ’­æ”¾åˆ—è¡¨çš„ç±»å‹å†³å®šè°ƒç”¨é‚£ä¸ªç‰ˆæœ¬ã€‚è¿™æ ·å°±æŠŠPlaylistManagerå®Œå…¨å’Œåˆ—è¡¨ç”Ÿæˆçš„é€»è¾‘ç»‘æ­»åœ¨ä¸€èµ·äº†ï¼Œå¦‚æœä»¥åè¦åœ¨åŠ ä¸€ä¸ªæ–°çš„ç”Ÿæˆæ–¹å¼å°±è¿˜è¦ä¿®æ”¹PlaylistManagerçš„ä»£ç ï¼Œå°½ç®¡å®ƒè·ŸPlaylistManagerå¹¶æ— å…³ç³» ä¿®æ”¹æ€è·¯å¦‚æœæˆ‘ä»¬å°†ç”Ÿæˆæ’­æ”¾åˆ—è¡¨è¿™ä¸€è¡Œä¸ºæŠ½è±¡ä¸ºæ¥å£IPlaylistProviderçš„è¯ï¼ŒPlaylistManagerå°±å¯ä»¥å®Œå…¨è·Ÿè¿™éƒ¨åˆ†é€»è¾‘åˆ†å¼€äº† 123456789101112131415161718192021222324public interface IPlaylistProvider&#123; IReadonlyList&lt;Song&gt; AllSongs &#123; get; &#125; void Refresh();&#125;internal class PlaylistManager&#123; public IReadonlyList&lt;Song&gt; AllSong =&gt; _backLogs.AsReadOnly(); private readonly List&lt;Song&gt; _backLogs; private readonly IPlaylistProvider _provider; public PlaylistManager(IPlaylistProvider provider) &#123; _provider = provider; _backLogs = new List&lt;Song&gt;(_provider.AllSongs); &#125; internal void Refresh() &#123; Refresh(); _backLogs.Clear(); _backLogs.AddRange(_provider.AllSongs); &#125;&#125; æˆ‘ä»¬å¯ä»¥åˆ†åˆ«å®ç°åŸºäºè·¯å¾„å’Œé…ç½®æ–‡ä»¶çš„IPlaylistProvider 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768public class FileSystemProvider : IPlaylistProvider&#123; public FileSystemProvider(string path,bool recursive) &#123; if (!Directory.Exists(path)) &#123; throw new ArgumentException($\"&#123;path&#125; is not a directory\"); &#125; Path = path; Recursive = recursive; _songs = ReadSongs(); &#125; static readonly string[] MusicExtension = new[] &#123;\".mp3\",\".wma\" &#125;; private List&lt;Song&gt; ReadSongs() &#123; var song = new List&lt;Song&gt;(); var dir = new DirectoryInfo(Path); var files = dir.GetFiles().Where(i =&gt; MusicExtension.Contains(i.Extension)); song.AddRange(files.Select(f =&gt; new Song() &#123; FilePath = f.FullName, Title = f.Name, &#125;)); return song; &#125; public IReadOnlyList&lt;Song&gt; AllSongs =&gt; _songs.AsReadOnly(); public string Path &#123; get; &#125; public bool Recursive &#123; get; &#125; private List&lt;Song&gt; _songs; public void Refresh() &#123; _songs = ReadSongs(); &#125;&#125;public class JsonPlaylistProvider : IPlaylistProvider&#123; public JsonPlaylistProvider(string configPath) &#123; _songs = ReadSongs(); ConfigPath = configPath; if (!File.Exists(ConfigPath)) &#123; throw new ArgumentException($\"Can't find config file at &#123;ConfigPath&#125;\"); &#125; ReadSongs(); &#125; private List&lt;Song&gt; ReadSongs() &#123; var json = File.ReadAllText(ConfigPath); return JsonConvert.DeserializeObject&lt;List&lt;Song&gt;&gt;(json)??new List&lt;Song&gt;(); &#125; private List&lt;Song&gt; _songs; public string ConfigPath &#123; get; &#125; public IReadOnlyList&lt;Song&gt; AllSongs =&gt; _songs.AsReadOnly(); public void Refresh() &#123; ReadSongs(); &#125;&#125; è¿™ä¸ªä¾‹å­ä¸­ï¼ŒPlaylistManagerä¸ä¾èµ–FileSystemProviderå’ŒJsonPlaylistProviderï¼Œå®ƒä»¬ä¸‰è€…éƒ½ä¾èµ–äºIPlaylistProviderè¿™ä¸€æ¥å£ã€‚ä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ç›¸æ¯”äºæŠŠåˆ·æ–°çš„é€»è¾‘æ”¾åœ¨PlaylistManageré‡Œé«˜äº†å¥½å¤š è¿™é‡Œä½“ç°äº†ä¾èµ–åè½¬çš„åŸåˆ™ï¼š ä¸Šå±‚æ¨¡å—ä¸åº”è¯¥ä¾èµ–ä¸‹å±‚æ¨¡å—ï¼Œå®ƒä»¬éƒ½åº”è¯¥ä¾èµ–ä¸æŠ½è±¡ æˆ‘åœ¨ç”¨SOLIDé‡æ„æ‰‹å¤´çš„é¡¹ç›®ï¼Œæ”¹çš„å·®ä¸å¤šçš„æ—¶å€™æ‰“ç®—å†™å†™å¼€å‘ç¬”è®°ã€‚å’•å’•å’•","categories":[],"tags":[{"name":"OOP","slug":"OOP","permalink":"https://verrickt.github.io/tags/OOP/"},{"name":"SOLID","slug":"SOLID","permalink":"https://verrickt.github.io/tags/SOLID/"}]},{"title":"è®°ä¸€æ¬¡æ„‰(dan)å¿«(teng)çš„æ‰è™«","slug":"hell-mode-debugging","date":"2018-05-21T13:03:59.000Z","updated":"2018-08-04T08:26:42.741Z","comments":true,"path":"2018/05/21/hell-mode-debugging/","link":"","permalink":"https://verrickt.github.io/2018/05/21/hell-mode-debugging/","excerpt":"åºŸè¯BUGæ˜¯ä»»ä½•è½¯ä»¶éƒ½ä¼šé‡åˆ°çš„é—®é¢˜ã€‚å®ƒé€šå¸¸æ˜¯å¼€å‘äººå‘˜è€ƒè™‘é—®é¢˜ä¸å…¨é¢è€ŒåŸ‹ä¸‹çš„éšå½¢ç‚¸å¼¹ï¼Œåœ¨æ¡ä»¶åˆé€‚çš„æ—¶å€™å°±ä¼šçˆ†ç‚¸ï¼›å¼€å‘è‡ªå·±åŸ‹BUGå¾€å¾€æ¯”è¾ƒå®¹æ˜“é™¤é”™ï¼Œå› ä¸ºä»£ç éƒ½æ˜¯è‡ªå·±å†™çš„ï¼Œå®šä½é—®é¢˜ågit blameä¸€ä¸‹å°±å¯ä»¥ç”©é”…äº†ï¼›è€Œç¨‹åºä¾èµ–é¡¹é‡Œçš„BUGåˆ™æ’æŸ¥èµ·æ¥åˆ™è®©äººä¸€ç­¹è«å±•ï¼Œå°¤å…¶æ˜¯åœ¨æ²¡æœ‰è¶³å¤Ÿå¤šä¿¡æ¯çš„æƒ…å†µã€‚ é¢å¯¹æ¥è‡ªå®¢æˆ·å’ŒQAçš„å‹åŠ›ï¼Œç»å°½è„‘æ±ä»æ— æ³•å®šä½é—®é¢˜å¼€å‘ä»¬åªèƒ½æ‰¾å€Ÿå£äº†ğŸ¤£ Itâ€™s a feature,not a bug. Thatâ€™s the design decision, so not a bug æˆ‘ä»¥å‰ä¹Ÿé‡åˆ°æ¡†æ¶å‡ºé—®é¢˜çš„æƒ…å†µï¼Œä¸è¿‡éƒ½æ˜¯è‡ªå·±æ”¹ä»£ç æ”¹å‡ºæ¥çš„ï¼Œå€’ä¹Ÿä¸æ˜¯å¾ˆéš¾æ’æŸ¥ã€‚ä½†è¿™æ¬¡æŒ–å‡ºæ¥çš„BUGå°±å®Œå…¨ä¸ä¸€æ ·äº†","text":"åºŸè¯BUGæ˜¯ä»»ä½•è½¯ä»¶éƒ½ä¼šé‡åˆ°çš„é—®é¢˜ã€‚å®ƒé€šå¸¸æ˜¯å¼€å‘äººå‘˜è€ƒè™‘é—®é¢˜ä¸å…¨é¢è€ŒåŸ‹ä¸‹çš„éšå½¢ç‚¸å¼¹ï¼Œåœ¨æ¡ä»¶åˆé€‚çš„æ—¶å€™å°±ä¼šçˆ†ç‚¸ï¼›å¼€å‘è‡ªå·±åŸ‹BUGå¾€å¾€æ¯”è¾ƒå®¹æ˜“é™¤é”™ï¼Œå› ä¸ºä»£ç éƒ½æ˜¯è‡ªå·±å†™çš„ï¼Œå®šä½é—®é¢˜ågit blameä¸€ä¸‹å°±å¯ä»¥ç”©é”…äº†ï¼›è€Œç¨‹åºä¾èµ–é¡¹é‡Œçš„BUGåˆ™æ’æŸ¥èµ·æ¥åˆ™è®©äººä¸€ç­¹è«å±•ï¼Œå°¤å…¶æ˜¯åœ¨æ²¡æœ‰è¶³å¤Ÿå¤šä¿¡æ¯çš„æƒ…å†µã€‚ é¢å¯¹æ¥è‡ªå®¢æˆ·å’ŒQAçš„å‹åŠ›ï¼Œç»å°½è„‘æ±ä»æ— æ³•å®šä½é—®é¢˜å¼€å‘ä»¬åªèƒ½æ‰¾å€Ÿå£äº†ğŸ¤£ Itâ€™s a feature,not a bug. Thatâ€™s the design decision, so not a bug æˆ‘ä»¥å‰ä¹Ÿé‡åˆ°æ¡†æ¶å‡ºé—®é¢˜çš„æƒ…å†µï¼Œä¸è¿‡éƒ½æ˜¯è‡ªå·±æ”¹ä»£ç æ”¹å‡ºæ¥çš„ï¼Œå€’ä¹Ÿä¸æ˜¯å¾ˆéš¾æ’æŸ¥ã€‚ä½†è¿™æ¬¡æŒ–å‡ºæ¥çš„BUGå°±å®Œå…¨ä¸ä¸€æ ·äº† èƒŒæ™¯ä¸€ä¸ªWPFçš„é¡¹ç›®ï¼Œå‹‰å¼ºåœ¨deadlineä¹‹å‰èµ¶å®Œäº†åŠŸèƒ½ã€‚å‡ºäº†æ–°ç‰ˆæœ¬åæ¥åˆ°QAæŠ¥å‘Šï¼Œç¨‹åºåœ¨Windows 8.1ä¸Šæ­»äºOOM: System.OutOfMemoryException: Insufficient memory to continue the execution of the program. at System.Windows.Media.MediaContext.NotifyPartitionIsZombie(Int32 failureCode) at System.Windows.Media.MediaContext.NotifyChannelMessage() at System.Windows.Interop.HwndTarget.HandleMessage(Int32 msg, IntPtr wparam, IntPtr lparam) at System.Windows.Interop.HwndSource.HwndTargetFilterMessage(IntPtr hwnd, Int32 msg, IntPtr wParam, IntPtr lParam, Boolean&amp; handled) at MS.Win32.HwndWrapper.WndProc(IntPtr hwnd, Int32 msg, IntPtr wParam, IntPtr lParam, Boolean&amp; handled) at MS.Win32.HwndSubclass.DispatcherCallbackOperation(Object o) at System.Windows.Threading.ExceptionWrapper.InternalRealCall(Delegate callback, Object args, Boolean isSingleParameter) at System.Windows.Threading.ExceptionWrapper.TryCatchWhen(Object source, Delegate callback, Object args, Boolean isSingleParameter, Delegate catchHandler) at System.Windows.Threading.Dispatcher.WrappedInvoke(Delegate callback, Object args, Boolean isSingleParameter, Delegate catchHandler) at System.Windows.Threading.Dispatcher.InvokeImpl(DispatcherPriority priority, TimeSpan timeout, Delegate method, Object args, Boolean isSingleParameter) at System.Windows.Threading.Dispatcher.Invoke(DispatcherPriority priority, Delegate method, Object arg) at MS.Win32.HwndSubclass.SubclassWndProc(IntPtr hwnd, Int32 msg, IntPtr wParam, IntPtr lParam) at MS.Win32.UnsafeNativeMethods.DispatchMessage(MSG&amp; msg) at System.Windows.Threading.Dispatcher.PushFrameImpl(DispatcherFrame frame) at System.Windows.Threading.Dispatcher.PushFrame(DispatcherFrame frame) at System.Windows.Threading.Dispatcher.Run() æ‰è™«å‡ºå¸ˆä¸åˆ©ç¨‹åºé‡Œç”¨è‡ªå®šä¹‰çš„Window Styleæ›¿ä»£äº†WPFè‡ªå¸¦çš„ã€‚ä½†æ˜¯è‡ªå®šä¹‰çš„Window Styleåœ¨æœ€å¤§åŒ–çš„æ—¶å€™ä¼šè¦†ç›–ä»»åŠ¡æ ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†å›ç­”é‡Œè‡ªå®šä¹‰çš„æ¶ˆæ¯å¾ªç¯ã€‚çœ‹åˆ°è°ƒç”¨æ ˆé‡Œçš„Hwndï¼Œåˆæ­¥æ€€ç–‘æ˜¯è‡ªå®šä¹‰çš„æ¶ˆæ¯å¾ªç¯çš„é—®é¢˜ã€‚æŠŠæ¶ˆæ¯å¾ªç¯ç›¸å…³çš„ä»£ç æ‹¿æ‰ï¼Œé—®é¢˜ä¾æ—§ã€‚çœ‹æ¥ä¸æ˜¯æ¶ˆæ¯å¾ªç¯çš„é—®é¢˜ã€‚ä¸è¿‡ä¸ºä»€ä¹ˆæˆ‘åœ¨å¼€å‘çš„æ—¶å€™æ²¡æœ‰é‡åˆ°é—®é¢˜å‘¢ï¼Ÿ å¯»æ‰¾åŸå› æŠŠå‡ºé—®é¢˜ç‰ˆæœ¬ç›´æ¥æ”¾åœ¨æˆ‘çš„å¼€å‘æœºä¸Šè·‘å‘ç°å¹¶æ²¡æœ‰é—®é¢˜ã€‚æ”¾åœ¨å¦ä¸€ä¸ªåŒäº‹çš„æœºå­ä¸Šä¹Ÿæ²¡é—®é¢˜ã€‚è¿™æ—¶å€™æ„è¯†åˆ°é—®é¢˜æœ‰ç‚¹è¹Šè··ã€‚ä¸€èˆ¬æ¥è¯´è¿™ç§ä¸èƒ½ç¨³å®šé‡ç°çš„é—®é¢˜éƒ½æˆ–å¤šæˆ–å°‘ä¼šå’Œå¤šçº¿ç¨‹å’Œæ­»é”æœ‰å…³ã€‚ç„¶è€Œä¸Šä¸ªç‰ˆæœ¬åˆ°è¿™ä¸ªç‰ˆæœ¬å¹¶æ²¡æœ‰å†™è¿™äº›æ–¹é¢çš„ä»£ç ã€‚è¿™æ—¶å€™å¼€å§‹æ€€ç–‘æ˜¯ç¯å¢ƒçš„é—®é¢˜äº†ã€‚æ‰¾æ¥å„ä¸ªç‰ˆæœ¬çš„Windowsï¼Œä¾æ¬¡å°è¯•åå‘ç°åªåœ¨Windows 8.1ä¸Šæœ‰é—®é¢˜ã€‚éš¾é“æ˜¯OSçš„é—®é¢˜ï¼ŸåŒäº‹æé†’äº†ä¸€å¥ï¼Œè¯´ä»¥å‰çš„ç‰ˆæœ¬æ˜¯å¯ä»¥åœ¨Windows 8.1ä¸Šæ­£å¸¸è·‘çš„ã€‚ç”¨äºŒåˆ†æ³•ï¼Œæ‰¾åˆ°äº†æœ€æ™šçš„èƒ½ç”¨çš„ç‰ˆæœ¬Bå’Œæœ€æ—©çš„ä¸èƒ½ç”¨çš„ç‰ˆæœ¬Aã€‚ åˆå…¥å›°å¢ƒæŒ‰ç†è¯´ï¼Œæ‰¾åˆ°ç‰ˆæœ¬ådiffä¸‹æ”¹åŠ¨çš„ä»£ç å°±èƒ½æ¯”è¾ƒå¿«çš„å®šä½é—®é¢˜äº†ã€‚ä¸è¿‡ç°åœ¨æœ‰äº†ç¨³å®šæµ®ç°çš„ç‰ˆæœ¬Bï¼Œæˆ‘å†³å®šä»å¼‚å¸¸æœ¬èº«å…¥æ‰‹ã€‚ä¸€ç•ªæœç´¢åæ‰¾åˆ°äº†å¾®è½¯çš„ä¸€ç¯‡åšå®¢ï¼Œå…¶ä¸­æåˆ°è¿™ä¸ªé”™è¯¯é€šå¸¸æ˜¯æ¸²æŸ“å­ç³»ç»Ÿå‡ºé—®é¢˜çš„ç—‡çŠ¶ï¼š â€¦ WPF render thread encountered some fatal error â€¦ Most of the time, a failure occurs when calling into DirectX/D3D â€¦ When a failure is detected, The render thread will attempt to map the failure it receives to an appropriate managed exception. The render thread only synchronizes with the UI thread in a few locations â€¦The most common locations when they synchronize are â€¦ or as a result of the UI thread handling a â€œchannelâ€ message from DirectX. If a render thread failure manifests as a System.OutOfMemoryException, then the likelihood is that the render thread was a victim of the process exhausting some resource .The exhausted resource is most often available/contiguous virtual address space â€¦ It might be a situation where sometimes the WPF render thread is the victim of the resource exhaustion â€¦ WPFé‡Œçš„æ¸²æŸ“æ˜¯ç”±éæ‰˜ç®¡çš„DirectXåšçš„ã€‚ä¸ºäº†ä»ç¨‹åºå‘˜çš„è§’åº¦éšè—æ‰æ¸²æŸ“è¿™ä¸ªè¿‡ç¨‹ï¼ŒWPFå°†è‡ªèº«æ‹†åˆ†ä¸ºä¸åŒçš„ç»„ä»¶ã€‚PreserentationFramework.dllå’ŒPreserentationFrameworkCore.dllæ˜¯ç¨‹åºå‘˜ç›´æ¥èƒ½æ¥è§¦åˆ°çš„ã€‚è¿™é‡Œå®ç°çš„æ˜¯ç»„åˆå­ç³»ç»Ÿã€‚æ¸²æŸ“å­ç³»ç»Ÿåˆ™åœ¨éæ‰˜ç®¡çš„milcore.dllé‡Œå®ç°ã€‚System.Windows.Media.Visualæ˜¯WPFç»„åˆå­ç³»ç»Ÿçš„å…¥å£ç‚¹ï¼Œå®ƒé€šè¿‡ç§æœ‰çš„é€šä¿¡åè®®ä¸milcoreé‡Œçš„æ¸²æŸ“å­ç³»ç»Ÿé€šä¿¡ï¼Œä»è€Œå°†ç»„åˆå­ç³»ç»Ÿå’Œæ¸²æŸ“å­ç³»ç»Ÿè¿æ¥èµ·æ¥ã€‚ çœ‹èµ·æ¥æˆ‘ä»¬çš„ä»£ç è€—å°½äº†DirectXé‡Œè¾¹çš„æŸç§èµ„æºï¼Œä»è€Œè®©æ¸²æŸ“å¤±è´¥äº†ã€‚C#åšä¸ºä¸€ä¸ªæ‰˜ç®¡è¯­è¨€ï¼Œå±…ç„¶èƒ½æ…è¿™ä¹ˆå¤§çš„ç¯“å­ï¼Œå®Œå…¨ä¸ç§‘å­¦ã€‚è¿™ä¸ªBUGè¶Šæ¥è¶Šæœ‰æ„æ€äº†ğŸ¤” æ—¢ç„¶å¼‚å¸¸ä¸Šçœ‹ä¸å‡ºæ¥ä»€ä¹ˆå¤´ç»ªé‚£å°±è¦ä»ä»£ç å…¥æ‰‹äº†ã€‚æ‰¾diffçš„æ—¶å€™å‘ç°Bç‰ˆæœ¬æ²¡æœ‰æ‰“tagã€‚ æ²¡æ‰“tagä¸ç®—å¤§é—®é¢˜ï¼Œå¤šèŠ±äº†äº›æ—¶é—´æˆåŠŸæ‰¾åˆ°äº†é‚£ä¸ªcommitï¼Œä½†æ˜¯å¿ƒæƒ…æœ‰ç‚¹ä¸çˆ½ã€‚ diffçš„ä»£ç ä¸å¤šã€‚æ’é™¤æ‰æ— å…³çš„æ–‡ä»¶å°±åªå‰©ä¸‹ä¸€äº›å¸ƒå±€æ–‡ä»¶æ¯”è¾ƒå¯ç–‘ã€‚æ”¹æµç¨‹ï¼Œä¾æ¬¡è·³è¿‡è¿™äº›é¡µé¢ï¼Œå‘ç°ä¸€è·³åˆ°ç™»å½•é¡µé¢å°±æŒ‚äº†ã€‚ç™»å½•é¡µé¢çš„diffæœ‰ç‚¹å¤šï¼ŒäºŒåˆ†åˆ é™¤å¾ˆå¿«å°±å®šä½åˆ°äº†é—®é¢˜çš„æ ¹æº:ImageButtonã€‚ ImageButtonæ˜¯ä¸ªåœ¨æ™®é€šã€é¼ æ ‡æ‚¬åœã€è¢«æŒ‰ä¸‹ä¸‰ç§ä¸åŒçŠ¶æ€æ—¶æ˜¾ç¤ºä¸åŒçš„å›¾ç‰‡çš„æŒ‰é’®ã€‚ç±»å‹å®šä¹‰å’Œæ ·å¼å®šä¹‰åˆ†åˆ«å¦‚ä¸‹ï¼š ç™»é™†é¡µé¢ä¸­æ˜¯è¿™æ ·ä½¿ç”¨ImageButtonçš„:123....&lt;ImageButton Source=\"&#123;StaticResource SomeImage&#125;\" MouseOverImage=\"&#123;StaticResouce SomeOtherImage&#125;\" PressedImage=\"&#123;StaticResources AnotherImage&#125;\" /&gt;.... æŠŠSource=&quot;{StaticResource SomeImage}&quot;è¿™ä¸€å¥å»æ‰å°±æ­£å¸¸äº†ã€‚ä¼¼ä¹å®ƒå°±æ˜¯ç½ªé­ç¥¸é¦–ã€‚ä½†æ˜¯ï¼ŒæŠŠè¿™éƒ¨åˆ†ä»£ç å’Œå›¾ç‰‡æ‹¿å‡ºæ¥æ”¾åˆ°å¦ä¸€ä¸ªç¨‹åºé‡Œå´åˆä¸€åˆ‡æ­£å¸¸ã€‚ è½¬æœºæ¥ä¸‹æ¥åˆå°è¯•äº† æŠŠImageButtonæ›¿æ¢ä¸ºImage æŠŠTemplate.Triggerå»æ‰ æŠŠSomeImageæŒ‡å‘å…¶ä»–å›¾ç‰‡ ä½†æ˜¯è¿˜æ˜¯æ‰¾ä¸åˆ°root causeã€‚ä¸€æ¨¡ä¸€æ ·çš„ä»£ç ä¸èƒ½åœ¨å…¶ä»–ç¨‹åºå¤ç°ï¼Œé‚£å°±è¯´æ˜BUGæ˜¯æˆ‘ä»¬ç¨‹åºè‡ªå·±é€ æˆçš„ã€‚ä½†æ˜¯è¿™ä¸ªBUGåªåœ¨Windows 8.1ä¸‹å‡ºç°ï¼Œè¯´æ˜è·Ÿç¯å¢ƒä¹Ÿæœ‰å¯èƒ½æœ‰å…³ç³»ã€‚è·ç¦»å‘ç°BUGå·²ç»è¿‡å»ä¸€å¤©åŠäº†ï¼Œæ”¾å¼ƒçš„è¯å®åœ¨æ˜¯ä¸ç”˜å¿ƒï¼Œæ¥ä¸‹æ¥åªèƒ½çŒœäº†ã€‚ å †æ ˆé‡Œæ˜¾ç¤ºç¨‹åºæŒ‚åœ¨WPFçš„ç¨‹åºé›†é‡Œï¼ŒåŸºäºè¿™ä¸ªç°è±¡å†³å®šretargetåˆ°.NET Frameworkçš„æœ€æ–°ç‰ˆæœ¬4.7.2ã€‚ç¼–è¯‘æ‰“åŒ…éƒ¨ç½²ä¸€å¥—æµç¨‹èµ°å®Œï¼Œåœ¨è¿è¡Œçš„æ—¶å€™å‘ç°Windows 8.1æ²¡æœ‰å®‰è£….NET Framework 4.7.2ã€‚å¥½å§ï¼Œé‚£å°±è£…ã€‚å¯æ˜¯å®‰è£…åŒ…å‘Šè¯‰æˆ‘ä¸æ»¡è¶³æ¡ä»¶ï¼š éœ€è¦å®‰è£…KB2919355ï¼Ÿ å¾®è½¯æ¥èƒŒé”…åœ¨å¾®è½¯çš„æ”¯æŒç½‘ç«™ä¸Šè¯¦ç»†åˆ—å‡ºäº†KB2919355çš„change logã€‚ä»¥imageä¸ºå…³é”®å­—CTRL+Få‘ç°è¿™æ ·çš„æè¿°ï¼š Article number Article Title 2929755 Out of memory when you load some image resources in a Windows application æˆ‘å»ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬é‡åˆ°çš„é—®é¢˜ã€‚ å¯¹åº”çš„é¡µé¢ç»™å‡ºçš„æè¿°ï¼š Symptoms When you load some image resources in an application such as Microsoft Visual Studio on a computer that has Windows 8.1, Windows Server 2012 R2, Windows 8, Windows Server 2012, Windows 7, or Windows Server 2008 R2 installed, the application stops responding and memory leaks in Windows. This issue occurs after you install the following update:2670838 Platform update for Windows 7 SP1 and Windows Server 2008 R2 SP1 File Information For all supported x86-based versions of Windows 8: File name File version File size Date Time Platform Windowscodecs.dll 6.2.9200.16809 1,339,392 31-Jan-2014 00:48 x86 Windowscodecs.dll 6.2.9200.20930 1,319,936 31-Jan-2014 06:04 x86 è¿™ä¸ªBUGæ˜¯KB2670838å¼•å…¥çš„ã€‚åœ¨2670838çš„æ›´æ–°ä¸­,å¾®è½¯æ›´æ–°äº†ç°æœ‰çš„Windows Imaging Component (WIC) This update improves the range and performance of the following graphics and imaging components: Windows Imaging Component (WIC) æˆ‘ä»¬åœ¨diffé‡Œé‡ç‚¹å…³æ³¨äº†Imageç›¸æ›´æ”¹ï¼Œå‘ç°æ”¹äº†è¿™ä¹ˆä¸€è¡Œï¼š 123456&lt;Application.Resources&gt; &lt;Style TargetType=\"Image\"&gt; &lt;Setter Property=\"RenderOptions.BitmapScalingMode\" Value=\"Fant\" /&gt; &lt;/Style&gt;&lt;/Application.Resources&gt; RenderOptons.BitmapScalingModeæŒ‡æ˜åœ¨éœ€è¦ç¼©æ”¾æ—¶ä½¿ç”¨çš„ç®—æ³•ã€‚Fantæ˜¯è´¨é‡æœ€é«˜çš„ä¸€ç§ä¹‹ä¸€ã€‚å°è¯•Fantæ”¹ä¸ºLinearåç¨‹åºæ­£å¸¸è¿è¡Œã€‚ç»§ç»­å°è¯•å…¶ä»–çš„å€¼ï¼Œå‘ç°é™¤äº†Linearå’ŒUnspecifiedéƒ½ä¼šå´©æºƒã€‚ åŸå› åˆ†æåœ¨KB2670838é‡Œçš„WICåœ¨ç‰¹å®šæƒ…å†µä¼šOOMçˆ†æ‰ã€‚WPFé‡Œçš„BitmapScalingMode.Fantä¾èµ–WICå®ç°ï¼Œåœ¨è£…äº†KB2670838çš„ç¯å¢ƒé‡Œè·Ÿå°±ä¼šè·ŸWICä¸€èµ·OOMçˆ†æ‰ï¼›å¾®è½¯åœ¨åæ¥å‘è¡Œçš„KB2919355ä¸­ä¿®å¤äº†è¿™ä¸ªBUGã€‚ æˆ‘ä»¬çš„æµ‹è¯•æœºçš„Windowsç³»ç»Ÿç”±RTMçš„é•œåƒå®‰è£…å¹¶ä¸”å…³é—­äº†è‡ªåŠ¨æ›´æ–°ã€‚åœ¨Windows 8.1ä¹‹å‰çš„RTMé•œåƒæ²¡æœ‰è‡ªå¸¦KBB2670838ï¼Œåœ¨Windows 8.1ä¹‹åRTMé•œåƒè‡ªå¸¦äº†KB2919355ã€‚ååè¿™ä¸ªWindows 8.1çš„RTMé•œåƒå†…ç½®äº†KB2670838è€Œæ²¡æœ‰å†…ç½®KB2919355ï¼Œç¨‹åºå°±è¿™æ ·æ­»äºOOMã€‚ éªŒè¯Windowscodecs.dllçš„ç‰ˆæœ¬ä¹Ÿæ”¯æŒè¿™ä¸ªç»“è®ºã€‚ æ€»ç»“ å®šä½ç¯å¢ƒé—®é¢˜çš„æ—¶å€™è¦æ§åˆ¶å˜é‡ äºŒåˆ†æ³•èƒ½å¿«é€Ÿå®šä½å‡ºé”™çš„ä½ç½® æ‰“å¥½Tagå¾ˆé‡è¦ ä¸€ç›´ä»¥æ¥ä¾èµ–çš„åº•å±‚ä¹Ÿä¼šæœ‰BUGã€‚å¤§èƒ†è´¨ç–‘ï¼Œå°å¿ƒæ±‚è¯ã€‚ è¯¥ç”©é”…çš„æ—¶å€™è¦æœæ–­çš„ç”©ç»™å¾®è½¯ ReferenceWPF Architecture - docs.microsoft.com WPF ToolTip Rendering Issue : Application Hang - social.msdn.microsoft.com Windows RT 8.1, Windows 8.1, and Windows Server 2012 R2 update: April 2014 - support.microsoft.com Platform update for Windows 7 SP1 and Windows Server 2008 R2 SP1 - support.microsoft.com Windows Imaging Component - msdn.microsoft.com","categories":[],"tags":[{"name":"C#","slug":"C","permalink":"https://verrickt.github.io/tags/C/"},{"name":"Debugging","slug":"Debugging","permalink":"https://verrickt.github.io/tags/Debugging/"},{"name":"WPF","slug":"WPF","permalink":"https://verrickt.github.io/tags/WPF/"}]},{"title":"é—­åŒ…ï¼Œå˜é‡æ•è·ä¸é‡å…¥é—®é¢˜","slug":"closure-and-re-entrance","date":"2018-03-08T11:59:20.000Z","updated":"2018-08-04T08:26:21.220Z","comments":true,"path":"2018/03/08/closure-and-re-entrance/","link":"","permalink":"https://verrickt.github.io/2018/03/08/closure-and-re-entrance/","excerpt":"é—®é¢˜æè¿°å…¬å¸çš„APPï¼Œåœ¨æ–­ç½‘åè¿›è¡Œä¸€ä¸ª10ç§’çš„å€’è®¡æ—¶æ“ä½œï¼Œæ¯ç§’é’Ÿéƒ½ä¼šå°è¯•é‡æ–°è”ç½‘ã€‚å½“ç§’æ•°åˆ°0æ—¶åˆé‡æ–°å¼€å§‹è®¡æ—¶ï¼Œå€’è®¡æ—¶åœ¨ç”¨æˆ·é€€å‡ºç¨‹åºæˆ–è€…è¿ä¸Šç½‘ç»œç»“æŸã€‚ æŒ‰ç†è¯´æ˜¯ä¸ªå¾ˆç®€å•çš„Caseã€‚QAå´æŠ¥è¿‡æ¥ä¸ªBUGï¼Œè¯´APPçŠ¶æ€ç”± è”ç½‘-&gt;æ–­ç½‘-&gt;è”ç½‘-&gt;æ–­ç½‘ å˜åŒ–åï¼Œå€’è®¡æ—¶çš„ç§’æ•°å˜ä¸º 9 3 8 2 7 1 å˜å¾—ä¸è¿ç»­äº†ã€‚","text":"é—®é¢˜æè¿°å…¬å¸çš„APPï¼Œåœ¨æ–­ç½‘åè¿›è¡Œä¸€ä¸ª10ç§’çš„å€’è®¡æ—¶æ“ä½œï¼Œæ¯ç§’é’Ÿéƒ½ä¼šå°è¯•é‡æ–°è”ç½‘ã€‚å½“ç§’æ•°åˆ°0æ—¶åˆé‡æ–°å¼€å§‹è®¡æ—¶ï¼Œå€’è®¡æ—¶åœ¨ç”¨æˆ·é€€å‡ºç¨‹åºæˆ–è€…è¿ä¸Šç½‘ç»œç»“æŸã€‚ æŒ‰ç†è¯´æ˜¯ä¸ªå¾ˆç®€å•çš„Caseã€‚QAå´æŠ¥è¿‡æ¥ä¸ªBUGï¼Œè¯´APPçŠ¶æ€ç”± è”ç½‘-&gt;æ–­ç½‘-&gt;è”ç½‘-&gt;æ–­ç½‘ å˜åŒ–åï¼Œå€’è®¡æ—¶çš„ç§’æ•°å˜ä¸º 9 3 8 2 7 1 å˜å¾—ä¸è¿ç»­äº†ã€‚ æ€è€ƒäº†ä¸€ä¸‹ï¼Œè§‰å¾—åº”è¯¥æ˜¯ç¬¬ä¸€æ¬¡å€’è®¡æ—¶çš„æ²¡æœ‰é€€å‡ºï¼Œç¬¬äºŒæ¬¡å€’è®¡æ—¶å¼€å§‹åä¸¤è€…éƒ½å¼€å§‹æ›´æ–°UIã€‚ çœ‹äº†ä»£ç ï¼Œæœç„¶æ˜¯è¿™æ ·çš„ 123456789101112131415161718192021222324void OnIPChanged()&#123; ShowOfflineUI();&#125;void ShowOfflineUI()&#123; Task.Factory.Start(delegate &#123; int i = 10; while(true) &#123; i = (i-1)%10; Invoke(UpdateCountDown(i))//update UI on UI thread try &#123; Thread.Sleep(TimeSpan.FromSeconds(1)) if(Connect()) &#123; break; &#125; &#125; &#125; &#125;)&#125; åœ¨ç¬¬äºŒæ¬¡è§¦å‘å€’è®¡æ—¶çš„æ—¶å€™åŸæ¥çš„å€’è®¡æ—¶è¿˜åœ¨ç»§ç»­ï¼Œå³ï¼Œä¸¤ä¸ªå€’è®¡æ—¶åŒæ—¶æ‰§è¡Œæ˜¯ä¸å®‰å…¨çš„ã€‚è¿™æ˜¯å…¸å‹çš„é‡å…¥é—®é¢˜) è¯´å®è¯æˆ‘ä¸æ˜¯å¾ˆå–œæ¬¢ç›´æ¥ç”¨Thread.Sleepæ¥åšæ“ä½œï¼Œè¿™æ ·å ç”¨äº†ä¸€ä¸ªçº¿ç¨‹å¿™ç­‰ï¼Œæµªè´¹äº†èµ„æºã€‚C#ä¸­ä¸€èˆ¬é‡‡ç”¨åŸºäºTaskçš„å¼‚æ­¥ç¼–ç¨‹æ¥åšï¼Œè¿™æ ·ä¸ä¼šæµªè´¹èµ„æºã€‚Taskæä¾›çš„CancellationTokenèƒ½å¤Ÿæ¯”è¾ƒå®¹æ˜“çš„å®ç°å–æ¶ˆã€‚æ”¾åˆ°è¿™ä¸ªCaseé‡Œï¼Œåªè¦å¼€å§‹å€’è®¡æ—¶çš„æ—¶å€™å–æ¶ˆä¸Šä¸€æ¬¡çš„å€’è®¡æ—¶å°±å¥½äº†ã€‚ è¯´å¹²å°±å¹²,æˆ‘æœ€å–œæ¬¢ç”¨Taské‡å†™åŸºäºThreadçš„å¹¶å‘/å¼‚æ­¥äº† 12345678910111213141516171819202122232425262728TaskCancellationToken _cts;void OnIPChanged()&#123; ShowOfflineUI(); ShowOfflineUI();&#125;async Task ShowOfflineUI()&#123; _cts?.Cancel(); _cts = new CancellationToken(); await Task.Run( async ()=&gt; &#123; int i = 0; while(true) &#123; i = (i-1)%10; Invoke(UpdateCountDown(i)); await Task.Delay(TimeSpan.FromSeconds(1),_cts.Token); if(Connect()) &#123; break; &#125; &#125; &#125; );&#125; ä¸ºäº†éªŒè¯æ–¹æ³•çš„æ­£ç¡®æ€§ï¼Œæˆ‘ç‰¹åœ°åœ¨OnIPChanged()è°ƒç”¨äº†ä¸¤æ¬¡ShowOfflineUI()ã€‚ä½†æ˜¯ç¬¬ä¸€ä¸ªTaskå¹¶æ²¡æœ‰è¢«å–æ¶ˆã€‚ åˆ†æé—®é¢˜å†™å‡ºäº†è·Ÿè‡ªå·±é¢„æœŸä¸ä¸€æ ·çš„ä»£ç æ€ä¹ˆåŠï¼Ÿå½“ç„¶æ˜¯ä¸ŠDebuggeräº†ã€‚åœ¨Debuggerçš„ç«çœ¼é‡‘ç›ä¸‹ï¼Œæˆ‘å¾ˆå¿«æ³¨æ„åˆ°äº†æœ€æ˜æ˜¾çš„ç°è±¡ï¼šåœ¨ç¬¬äºŒæ¬¡è°ƒç”¨ShowOfflineUIçš„æ—¶å€™ï¼Œ_cts.Cancel()å¹¶æ²¡æœ‰æŠŠç¬¬ä¸€ä¸ªTaskä¸­çš„CancellationTokençš„IsCancellationRequestå˜ä¸ºTrueã€‚è®¡ç®—æœºç§‘å­¦é‡Œæœ‰å¥è€è¯ï¼Œé‚£å°±æ˜¯æ°¸è¿œä¸è¦æ€€ç–‘è¿‘30å¹´å†…ç¼–è¯‘å™¨çš„æ­£ç¡®æ€§ã€‚ç»è¿‡æ•°ååˆ†é’Ÿçš„æ’(è°·)æŸ¥(æ­Œ)å®šä½äº†é—®é¢˜çš„åŸå› :ä¸¤ä¸ªTaskå¼•ç”¨çš„_ctsæ˜¯åŒä¸€ä¸ªã€‚ åŸå› å‰–æå¦‚æœä¸€ä¸ªåŒ¿åå‡½æ•°å¼•ç”¨äº†ä¸å±äºä»–è‡ªå·±çš„å±€éƒ¨å˜é‡ï¼Œé‚£ä¹ˆè¿™ä¸ªç°è±¡å°±ç§°ä¸ºé—­åŒ…ã€‚å› ä¸ºè¿™å®åœ¨æ˜¯å¤ªè‡ªç„¶äº†æ‰€ä»¥æˆ‘æ‰æ²¡å¾€è¿™ä¸Šé¢æƒ³ã€‚åœ¨ç»™Task.Runä¸­ï¼Œæˆ‘ä¼ å…¥äº†ä¸€ä¸ªActionç±»å‹çš„å‡½æ•°ï¼Œå®ƒæ•è·äº†å¤–éƒ¨å˜é‡_ctsã€‚åœ¨å‡½æ•°ä¸­æ¯æ¬¡ç”¨åˆ°_ctsçš„æ—¶å€™ï¼Œè¢«æ•è·çš„å˜é‡çš„å€¼è¢«é‡æ–°è®¡ç®—ï¼Œç»“æœä½œä¸ºå®é™…çš„å€¼ã€‚è€Œæˆ‘çš„æœ¬æ„æ˜¯è®©ä¸¤ä¸ªTaskæ‹¥æœ‰ä¸åŒçš„_ctsï¼Œè¿™æ ·åè¾¹çš„Taskå°±å¯ä»¥å–æ¶ˆå‰è¾¹çš„Taskäº†ã€‚æ˜ç™½äº†è¿™äº›åå°±å¾ˆå¥½æ”¹äº†ï¼Œåœ¨ShowOfflineUIé‡Œæ”¾ä¸€ä¸ªå±€éƒ¨å˜é‡ï¼Œå­˜å‚¨_ctsçš„å€¼ï¼Œè®©åŒ¿åå‡½æ•°æ•è·è¿™ä¸ªå±€éƒ¨å˜é‡å°±å¥½äº†1234567891011121314151617181920212223async Task ShowOfflineUI()&#123; var local = _cts; local?.Cancel(); _cts = new CancellationToken(); await Task.Run( async ()=&gt; &#123; int i = 0; while(true) &#123; i = (i-1)%10; Invoke(UpdateCountDown(i)); await Task.Delay(TimeSpan.FromSeconds(1),local?.Token??CancellationToken.None); if(Connect()) &#123; break; &#125; &#125; &#125; );&#125; æœ‰å…´è¶£çš„æœ‹å‹å¯ä»¥çŒœä¸€çŒœè¿™ä¸¤æ®µä»£ç çš„ç»“æœï¼Œå†è¿è¡ŒéªŒè¯ä¸€ä¸‹ 123456789101112131415161718public void NonLocal()&#123; List&lt;Action&gt; actions = new List&lt;Action&gt;(); for(int i=0 ;i&lt;10;i++) actions.Add(()=&gt;Console.WriteLine(i)); actions.ForEach(a=&gt;a());&#125;public void Local()&#123; List&lt;Action&gt; actions = new List&lt;Action&gt;(); for(int i=0 ;i&lt;10;i++) &#123; int j = i; actions.Add(()=&gt;Console.WriteLine (j)); &#125; actions.ForEach(a=&gt;a());&#125; ç›¸ä¿¡åå­—å°±ç»™å¤§å®¶è¶³å¤Ÿå¤šçš„æç¤ºäº† æœ€åç¥ä½ èº«ä½“å¥åº·ï¼Œå†è§","categories":[],"tags":[{"name":"Reentrance","slug":"Reentrance","permalink":"https://verrickt.github.io/tags/Reentrance/"},{"name":"async/await","slug":"async-await","permalink":"https://verrickt.github.io/tags/async-await/"},{"name":"lambda","slug":"lambda","permalink":"https://verrickt.github.io/tags/lambda/"}]},{"title":"HTTPClient è¸©å‘è®°","slug":"httpclient-good-part-and-tipfalls","date":"2017-10-24T11:43:28.000Z","updated":"2018-08-02T15:04:19.455Z","comments":true,"path":"2017/10/24/httpclient-good-part-and-tipfalls/","link":"","permalink":"https://verrickt.github.io/2017/10/24/httpclient-good-part-and-tipfalls/","excerpt":"HttpClientæ˜¯éšç€.Net framework 4.5ä¸€èµ·å‘å¸ƒçš„ç°ä»£Httpåº“ã€‚æ¯”èµ·WebClientï¼ŒHttpClientæœ€å¤§çš„ä¼˜ç‚¹å°±æ˜¯åŠ å…¥äº†C#5ä¸­çš„async/awaitå¼‚æ­¥æ–¹æ³•çš„æ”¯æŒã€‚async/awaitçš„å‘æš‚ä¸”ä¸è¡¨ï¼Œä»Šå¤©å°±æ¥è¯´ä¸€è¯´è¿™ä¸ªHttpClient HttpClientçš„å‘HttpClientå®ç°äº†IDisposableæ¥å£ï¼Œå¾ˆå¤šå°ä¼™ä¼´ä¸€çœ‹åˆ°IDisposeableæ¥å£å°±çº·çº·æŠŠHttpClientå¥—åœ¨äº†usingé‡Œè¾¹ 12345//bad httpclient usageusing(var client = new HttpClient())&#123; //do stuffs&#125; è¿™ç§ç”¨æ³•æ˜¯é”™è¯¯çš„.HttpClientåœ¨è®¾è®¡ä¹‹åˆè¢«è®¾è®¡ä¸ºä¸€ä¸ªå¯é‡ç”¨çš„å¯¹è±¡ï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸåº”è¯¥ä¸åº”ç”¨ç¨‹åºç›¸ä¸€è‡´.ä¸Šè¿°é”™è¯¯çš„ç”¨æ³•æ¯å‘èµ·ä¸€ä¸ªè¯·æ±‚å°±ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„HttpClientï¼Œå¹¶ä¸”åœ¨æ”¶åˆ°å›å¤ä¹‹åç«‹å³æŠŠHttpClient disposeæ‰ã€‚ä¼—æ‰€å‘¨çŸ¥TCPè¿æ¥åœ¨çœŸæ­£æ–­å¼€ä¹‹å‰ä¼šæœ‰å‡ åˆ†é’Ÿå¤„äºCLOSE_WAITçŠ¶æ€ã€‚è¿™ä¸ªçŠ¶æ€ä¸‹TCPé“¾æ¥å¹¶æ²¡æœ‰çœŸæ­£æ–­å¼€ã€‚çŸ­æ—¶é—´å†…å¤§é‡å‘å‡ºHttpè¯·æ±‚ä¼šä½¿ç³»ç»Ÿå¯ç”¨çš„ç«¯å£æ€¥å‰§æ¶ˆè€—ã€‚","text":"HttpClientæ˜¯éšç€.Net framework 4.5ä¸€èµ·å‘å¸ƒçš„ç°ä»£Httpåº“ã€‚æ¯”èµ·WebClientï¼ŒHttpClientæœ€å¤§çš„ä¼˜ç‚¹å°±æ˜¯åŠ å…¥äº†C#5ä¸­çš„async/awaitå¼‚æ­¥æ–¹æ³•çš„æ”¯æŒã€‚async/awaitçš„å‘æš‚ä¸”ä¸è¡¨ï¼Œä»Šå¤©å°±æ¥è¯´ä¸€è¯´è¿™ä¸ªHttpClient HttpClientçš„å‘HttpClientå®ç°äº†IDisposableæ¥å£ï¼Œå¾ˆå¤šå°ä¼™ä¼´ä¸€çœ‹åˆ°IDisposeableæ¥å£å°±çº·çº·æŠŠHttpClientå¥—åœ¨äº†usingé‡Œè¾¹ 12345//bad httpclient usageusing(var client = new HttpClient())&#123; //do stuffs&#125; è¿™ç§ç”¨æ³•æ˜¯é”™è¯¯çš„.HttpClientåœ¨è®¾è®¡ä¹‹åˆè¢«è®¾è®¡ä¸ºä¸€ä¸ªå¯é‡ç”¨çš„å¯¹è±¡ï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸåº”è¯¥ä¸åº”ç”¨ç¨‹åºç›¸ä¸€è‡´.ä¸Šè¿°é”™è¯¯çš„ç”¨æ³•æ¯å‘èµ·ä¸€ä¸ªè¯·æ±‚å°±ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„HttpClientï¼Œå¹¶ä¸”åœ¨æ”¶åˆ°å›å¤ä¹‹åç«‹å³æŠŠHttpClient disposeæ‰ã€‚ä¼—æ‰€å‘¨çŸ¥TCPè¿æ¥åœ¨çœŸæ­£æ–­å¼€ä¹‹å‰ä¼šæœ‰å‡ åˆ†é’Ÿå¤„äºCLOSE_WAITçŠ¶æ€ã€‚è¿™ä¸ªçŠ¶æ€ä¸‹TCPé“¾æ¥å¹¶æ²¡æœ‰çœŸæ­£æ–­å¼€ã€‚çŸ­æ—¶é—´å†…å¤§é‡å‘å‡ºHttpè¯·æ±‚ä¼šä½¿ç³»ç»Ÿå¯ç”¨çš„ç«¯å£æ€¥å‰§æ¶ˆè€—ã€‚ MSçš„äººæ¨èé‡ç”¨HttpClientä»¥ä½¿å…¶ç”Ÿå‘½å‘¨æœŸä¸åº”ç”¨ç›¸åŒ 1234567891011//good httpclient usageclass GoodHttpClientSample&#123; private static readonly HttpClient client = new HttpClient(); public Task&lt;string&gt; GetStringAsync(string url) &#123; var resposne = await client.GetAsync(url).ConfigureAwait(false); return response.Content.ReadAsStringAsync(); &#125; &#125; HttpClientçš„ä¼˜ç‚¹è¸©è¿‡äº†å‘æˆ‘ä»¬å†æ¥è¯´è¯´ä»–çš„å¥½å¤„ã€‚å»æ‰async/awaitæ”¯æŒè¿™ä¸ªæœ€å¤§çš„æœ‰ç‚¹ï¼ŒHttpClientçš„ä¸€ä¸ªæ„é€ å‡½æ•°çš„é‡è½½æ¥å—ä¸€ä¸ªHttpMessageHandlerã€‚è¿™ä¸ªé‡è½½å¾ˆæœ‰æ„æ€ã€‚HttpMessageHandlerå¯ä»¥åœ¨å‘å‡ºHttpè¯·æ±‚å’Œæ¥å—Httpå›å¤æ—¶åšå‡ºä¸€äº›å›åº”ã€‚.net frameworké‡Œæœ‰ä¸€ä¸ªç±»å«åšDelegatingHandlerï¼Œå®ƒç»§æ‰¿äº†HttpMessageHandlerã€‚å«åšDelegatingHandleræ˜¯å› ä¸ºå®ƒæœ‰ä¸ªç±»å‹ä¸ºHttpMessageHandlerçš„InnerHandlerå±æ€§ï¼Œå› è€Œå¯ä»¥æŠŠè¯·æ±‚delegateç»™InnerHandlerã€‚é€šè¿‡è¿™ä¸ªDelegatingHandleræˆ‘ä»¬å¯ä»¥è¯·ä»¥å®ç°åƒJava webé‡Œçš„filter chainä¸€æ ·çš„é€»è¾‘ã€‚ ä»Šå¤©é‡æ„äº†å…¬å¸çš„ä»£ç ã€‚å…¬å¸ç°æœ‰çš„HttpManageræä¾›äº†GETå’ŒPOSTä¸¤ç§HttpåŠ¨è¯çš„å¼‚æ­¥æ–¹æ³•ã€‚åœ¨è¿™äº›æ–¹æ³•ä¸­è¿˜è¿›è¡Œäº†æ—¥å¿—è®°å½•å’Œå¤±è´¥é‡è¯•ã€‚æ—¥å¿—è®°å½•å’Œå¤±è´¥é‡è¯•ç›¸å…³çš„ä»£ç éå¸¸é‡å¤ï¼Œä½†æ˜¯åˆæ— æ³•å†™æˆä¸€ä¸ªå‡½æ•°ã€‚å› æ­¤æˆ‘æŠŠè¿™éƒ¨åˆ†é€»è¾‘æŠ½å‡ºæ¥åšæˆäº†ä¸¤ä¸ªDelegatingHandler 12345678910111213141516171819202122232425class LogHandler:DelegatingHandler&#123; private readonly ILog _log; public LogHandler(ILog log,HttpMessageHandler handler):base(handler) &#123; _log = log; &#125; protected async override Task&lt;HttpResponseMessage&gt; SendAsync(HttpRequestMessage request, CancellationToken cancellationToken) &#123; try &#123; var begin = DateTime.Now; _log.I($\"&#123;request.Method&#125; -&gt;&#123;request.RequestUri&#125;\"); var response = await base.SendAsync(request,cancellationToken); var end = DateTime.Now; var diff = (end-begin).TotalMillseconds; _log.I($\"&#123;request.Method&#125; &lt;- &#123;response.Content.ReadAsStringAsync()&#125; cost&#123;diff&#125;ms\"); &#125; catch(Exception e) &#123; _log.E($\"&#123;request.Method&#125; -&gt;&#123;request.RequestUri&#125;,&#123;e&#125;\"); throw; &#125; &#125; 1234567891011121314151617181920212223242526272829303132333435class RetryHandler:DelegatingHandler&#123; protected async override Task&lt;HttpResponseMessage&gt; SendAsync(HttpRequestMessage request,CancellationToken cancellationToken) &#123; HttpResponseMessage response = null; for(int i=0;i&lt;=_retryTimes,i++) &#123; try &#123; response = await base.SendAsync(request,cancellationToken); return response; &#125; catch(Exception) &#123; if(i==_retryTimes) &#123; throw; &#125; &#125; //make compiler happy. return response; &#125; &#125; private readonly int _retryTimes = 0; public RetryHandler(int retryTimes,HttpMessageHandler handler):base(handler) &#123; if(retryTimes&lt;0) &#123; throw new ArgumentOutOfRangeException(nameof(retryTimes)); &#125; _retryTimes = retryTimes; &#125;&#125; HttpClientHandleræ˜¯ä¸ªçœŸæ­£å®ç°HttpClienté€»è¾‘çš„HttpMessageHandlerã€‚å› æ­¤ï¼Œæˆ‘ä»¬åªè¦ä¿è¯æœ€å†…éƒ¨çš„Handleræ—¶HttpClientHandlerå°±OKäº†ã€‚ 1234private static readonly ILog _log;private static readonly HttpClient _client = new HttpClient(new RetryHandler(3,new LogHandler(_log,new HttpClientHandler()))); éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœHttpHandleræ²¡æœ‰è¿”å›HttpResponseMessage,å¯¹åº”çš„å¼‚æ­¥æ–¹æ³•ä¼šåœ¨è¿è¡Œæ—¶æŠ›å‡ºInvalidOperationException é‡æ„ä¹‹åæ•´ä¸ªHttpå°è£…ç±»çš„ä»£ç è¡Œæ•°ä»400è¡Œå‡å°‘åˆ°äº†120è¡Œå·¦å³ï¼Œå¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§æå‡æ˜¾è‘—ã€‚ Further readingFUN WITH THE HTTPCLIENT PIPELINE YOUâ€™RE USING HTTPCLIENT WRONG AND IT IS DESTABILIZING YOUR SOFTWARE Do HttpClient and HttpClientHandler have to be disposed?","categories":[],"tags":[{"name":"HttpClient","slug":"HttpClient","permalink":"https://verrickt.github.io/tags/HttpClient/"},{"name":"C#","slug":"C","permalink":"https://verrickt.github.io/tags/C/"}]}]}